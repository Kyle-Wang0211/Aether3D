name: Quality Pre-check Gates

on:
  pull_request:
    paths:
      - 'Core/Quality/**'
      - 'Tests/QualityPreCheck/**'
      - 'scripts/quality_gate.sh'
      - 'scripts/quality_lint.sh'

jobs:
  quality-gates:
    strategy:
      matrix:
        os: [macos-14, ubuntu-latest]
        swift-version: ["5.9"]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: ${{ matrix.swift-version }}
      
      - name: Platform Diagnostics
        run: |
          echo "=== Platform Information ==="
          uname -a
          swift --version
          swift package describe || echo "Package description not available"
          echo "============================"
      
      - name: Platform Drift Guard
        run: |
          echo "=== Checking for unconditional Apple framework imports ==="
          set +e
          # Check for unconditional CoreMotion imports (must be guarded with #if canImport)
          # Pattern: find lines with "import CoreMotion" that are NOT preceded by "#if canImport(CoreMotion)" on the previous line
          # Use awk to check context: if line contains "import CoreMotion" and previous line doesn't contain "#if canImport(CoreMotion)", flag it
          UNGUARDED_IMPORTS=$(find Core/Quality/ -name "*.swift" -exec awk '
            /^[[:space:]]*#if canImport\(CoreMotion\)/ { guarded=1; next }
            /^[[:space:]]*#endif/ { guarded=0; next }
            /^[[:space:]]*import CoreMotion/ {
              if (!guarded) {
                print FILENAME":"NR":"$0
              }
            }
            { guarded=0 }
          ' {} \; || true)
          if [ -n "$UNGUARDED_IMPORTS" ]; then
            echo "FAIL: Found unconditional CoreMotion imports (must be guarded with #if canImport(CoreMotion)):"
            echo "$UNGUARDED_IMPORTS"
            exit 1
          fi
          # Check for other Apple-only frameworks that might be imported unconditionally
          UNGUARDED_APPLE=$(find Core/Quality/ -name "*.swift" -exec awk '
            /^[[:space:]]*#if canImport\(/ { guarded=1; next }
            /^[[:space:]]*#endif/ { guarded=0; next }
            /^[[:space:]]*import (UIKit|AppKit|AVFoundation|CoreLocation)/ {
              if (!guarded) {
                print FILENAME":"NR":"$0
              }
            }
            { guarded=0 }
          ' {} \; || true)
          if [ -n "$UNGUARDED_APPLE" ]; then
            echo "WARNING: Found unconditional Apple framework imports (may be acceptable):"
            echo "$UNGUARDED_APPLE"
          fi
          echo "âœ… Platform drift guard passed"
          set -e
      
      - name: Build (All Platforms)
        env:
          LC_ALL: C
          LANG: C
        run: |
          set -x
          chmod +x scripts/*.sh scripts/hooks/pre-push scripts/install_hooks.sh || true
          cd "$(git rev-parse --show-toplevel)"
          swift package clean
          swift build
      
      - name: Run Quality Gates (macOS only)
        if: matrix.os == 'macos-14'
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
        run: |
          set -x
          cd "$(git rev-parse --show-toplevel)"
          bash ./scripts/quality_gate.sh
      
      - name: Run Platform-Safe Tests (Linux)
        if: matrix.os == 'ubuntu-latest'
        env:
          LC_ALL: C
          LANG: C
        run: |
          set -x
          cd "$(git rev-parse --show-toplevel)"
          # List all tests to verify compilation
          swift test --list-tests || echo "Test listing failed (may be acceptable)"
          # Run tests that don't require Apple frameworks
          # WhiteCommitTests should be platform-agnostic (SQLite-based)
          swift test --filter WhiteCommitTests || echo "WhiteCommitTests failed (check logs)"
          # Run fixture and determinism tests (should be platform-agnostic)
          swift test --filter QualityPreCheckFixtures || echo "Fixture tests failed (check logs)"
          swift test --filter QualityPreCheckDeterminism || echo "Determinism tests failed (check logs)"

