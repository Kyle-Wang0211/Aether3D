name: PR3 Whitelist Enforcement

on:
  pull_request:
    paths:
      - 'Core/Evidence/PR3/**'
      - 'Core/Evidence/PRMath/**'
      - 'Core/Evidence/Smoothing/**'
      - 'Core/Evidence/Validation/**'
      - 'Core/Evidence/Constants/**'
      - 'Core/Evidence/Vector/**'
      - 'Core/Evidence/Tier/**'
      - 'Tests/Evidence/PR3/**'
      - 'Tests/Evidence/PRMath/**'
      - '.github/workflows/pr3-whitelist.yml'

jobs:
  pr3-whitelist-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check PR3 allowed paths
        run: |
          # Allowed paths for PR3
          ALLOWED_PATHS=(
            "Core/Evidence/PR3/"
            "Core/Evidence/PRMath/"
            "Core/Evidence/Smoothing/"
            "Core/Evidence/Validation/"
            "Core/Evidence/Constants/"
            "Core/Evidence/Vector/"
            "Core/Evidence/Tier/"
            "Tests/Evidence/PR3/"
            "Tests/Evidence/PRMath/"
            "Scripts/ForbiddenPatternLint.swift"
            ".github/workflows/pr3-whitelist.yml"
            ".github/workflows/evidence-tests.yml"
          )
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD)
          
          # Check each changed file
          for file in $CHANGED_FILES; do
            # Skip if file is in allowed paths
            ALLOWED=false
            for allowed_path in "${ALLOWED_PATHS[@]}"; do
              if [[ "$file" == "$allowed_path"* ]]; then
                ALLOWED=true
                break
              fi
            done
            
            # Check if file is PR3-related but not in allowed paths
            if [[ "$file" == *"PR3"* ]] || [[ "$file" == *"PRMath"* ]]; then
              if [ "$ALLOWED" = false ]; then
                echo "❌ PR3 file outside allowed paths: $file"
                exit 1
              fi
            fi
            
            # Check forbidden modifications
            FORBIDDEN_FILES=(
              "Core/Evidence/ViewDiversityTracker.swift"
              "Core/Constants/EvidenceConstants.swift"
              "Core/Evidence/UnifiedAdmissionController.swift"
              "Core/Evidence/SpamProtection.swift"
            )
            
            for forbidden in "${FORBIDDEN_FILES[@]}"; do
              if [[ "$file" == "$forbidden" ]]; then
                echo "❌ Forbidden modification: $file (PR3 must not modify PR2 code)"
                exit 1
              fi
            done
          done
          
          echo "✓ PR3 whitelist check passed"
