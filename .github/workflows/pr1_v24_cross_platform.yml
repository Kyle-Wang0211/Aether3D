name: PR1 v2.4 Cross-Platform Verification

on:
  pull_request:
    paths:
      - 'Core/**'
      - 'Tests/**'
      - 'Sources/**'
      - 'scripts/**'
      - '.github/workflows/pr1_v24_cross_platform.yml'
  push:
    branches:
      - main
      - 'pr1/**'
    paths:
      - 'Core/**'
      - 'Tests/**'
      - 'Sources/**'
      - 'scripts/**'
      - '.github/workflows/pr1_v24_cross_platform.yml'

env:
  LANG: C
  LC_ALL: C

jobs:
  swiftpm-macos-debug:
    name: SwiftPM macOS Debug
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Select stable Xcode
        run: |
          set -euo pipefail
          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "Selecting /Applications/$app"
              sudo xcode-select -s "/Applications/$app/Contents/Developer"
              return 0
            fi
            return 1
          }
          pick "Xcode_16.2.app" || pick "Xcode_16.1.app" || pick "Xcode_16.0.app" || pick "Xcode.app" || {
            echo "No Xcode found"; exit 1
          }
          swift --version
      - name: Build and test (Debug)
        run: |
          swift test --skip PR5CaptureTests
      - name: Extract CHECKS_TOTAL
        run: |
          swift test --skip PR5CaptureTests 2>&1 | grep -E "CHECKS_TOTAL=|VERIFICATION SUITE SUMMARY" || echo "CHECKS_TOTAL not found"

  swiftpm-macos-release:
    name: SwiftPM macOS Release
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Select stable Xcode
        run: |
          set -euo pipefail
          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "Selecting /Applications/$app"
              sudo xcode-select -s "/Applications/$app/Contents/Developer"
              return 0
            fi
            return 1
          }
          pick "Xcode_16.2.app" || pick "Xcode_16.1.app" || pick "Xcode_16.0.app" || pick "Xcode.app" || {
            echo "No Xcode found"; exit 1
          }
          swift --version
      - name: Build and test (Release)
        run: |
          swift test -c release --skip PR5CaptureTests

  swiftpm-ubuntu-debug:
    name: SwiftPM Ubuntu Debug
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            binutils git unzip gnupg2 libc6-dev libcurl4-openssl-dev \
            libedit2 libgcc-11-dev libpython3-dev libsqlite3-0 \
            libstdc++-11-dev libxml2-dev libz3-dev pkg-config tzdata \
            zlib1g-dev libsqlite3-dev
      - name: Import Swift GPG key
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            if curl -fsSL --compressed --retry 3 --retry-delay 5 https://swift.org/keys/all-keys.asc | gpg --import - 2>&1; then
              echo "✅ Swift GPG key imported successfully"
              exit 0
            fi
            echo "⚠️ Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "❌ Failed to import Swift GPG key after 3 attempts"
          exit 1
      - name: Set up Swift
        run: |
          set -euo pipefail
          SWIFT_VERSION="6.2.3"
          SWIFT_PLATFORM="ubuntu22.04"
          SWIFT_TARBALL="swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}.tar.gz"
          SWIFT_URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/${SWIFT_TARBALL}"
          echo "Downloading Swift ${SWIFT_VERSION}..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}" -o "/tmp/${SWIFT_TARBALL}"
          echo "Verifying GPG signature..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}.sig" -o "/tmp/${SWIFT_TARBALL}.sig"
          gpg --verify "/tmp/${SWIFT_TARBALL}.sig" "/tmp/${SWIFT_TARBALL}" || echo "⚠️ GPG verification failed (non-fatal)"
          echo "Extracting Swift toolchain..."
          sudo tar -xzf "/tmp/${SWIFT_TARBALL}" -C /opt
          SWIFT_PATH="/opt/swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}/usr/bin"
          echo "${SWIFT_PATH}" >> $GITHUB_PATH
          export PATH="${SWIFT_PATH}:${PATH}"
          echo "✅ Swift ${SWIFT_VERSION} installed"
          swift --version

      - name: Build and test (Debug)
        run: |
          # Skip PR5CaptureTests: @MainActor + async setUp/tearDown causes SIGABRT on Linux.
          # 4 batches to stay under Linux MAX_ARG_STRLEN (128KB per arg).
          # SwiftPM enumerates all remaining test names as a single posix_spawn argument.
          SKIP_ALWAYS="--skip PR5CaptureTests --disable-swift-testing"
          SKIP_UPLOADS="--skip UploadTests --skip UploadTestsB --skip UploadTestsC"
          SKIP_CORE="--skip Aether3DCoreTests --skip CITests --skip PR4MathTests --skip PR4PathTraceTests --skip PR4OwnershipTests --skip PR4OverflowTests --skip PR4LUTTests --skip PR4DeterminismTests --skip PR4SoftmaxTests --skip PR4HealthTests --skip PR4UncertaintyTests --skip PR4CalibrationTests --skip PR4GoldenTests --skip PR4IntegrationTests --skip EvidenceGridTests --skip EvidenceGridDeterminismTests"
          swift build --build-tests
          echo "=== Batch 1/4: Core + CI + PR4 + Evidence (~84KB) ==="
          swift test --skip-build $SKIP_ALWAYS $SKIP_UPLOADS --skip ConstantsTests --skip TSDFTests --skip ScanGuidanceTests
          echo "=== Batch 2/4: Constants + TSDF + ScanGuidance (~46KB) ==="
          swift test --skip-build $SKIP_ALWAYS $SKIP_UPLOADS $SKIP_CORE
          echo "=== Batch 3/4: UploadTests (~65KB) ==="
          swift test --skip-build $SKIP_ALWAYS --skip UploadTestsB --skip UploadTestsC --skip ConstantsTests --skip TSDFTests --skip ScanGuidanceTests $SKIP_CORE
          echo "=== Batch 4/4: UploadTestsB + UploadTestsC (~115KB) ==="
          swift test --skip-build $SKIP_ALWAYS --skip UploadTests --skip ConstantsTests --skip TSDFTests --skip ScanGuidanceTests $SKIP_CORE
      - name: Extract CHECKS_TOTAL
        run: |
          swift test --skip-build --skip PR5CaptureTests --skip UploadTests --skip UploadTestsB --skip UploadTestsC --skip TSDFTests --skip ScanGuidanceTests --disable-swift-testing 2>&1 | grep -E "CHECKS_TOTAL=|VERIFICATION SUITE SUMMARY" || echo "CHECKS_TOTAL not found"

  swiftpm-ubuntu-release:
    name: SwiftPM Ubuntu Release
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            binutils git unzip gnupg2 libc6-dev libcurl4-openssl-dev \
            libedit2 libgcc-11-dev libpython3-dev libsqlite3-0 \
            libstdc++-11-dev libxml2-dev libz3-dev pkg-config tzdata \
            zlib1g-dev libsqlite3-dev
      - name: Import Swift GPG key
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            if curl -fsSL --compressed --retry 3 --retry-delay 5 https://swift.org/keys/all-keys.asc | gpg --import - 2>&1; then
              echo "✅ Swift GPG key imported successfully"
              exit 0
            fi
            echo "⚠️ Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "❌ Failed to import Swift GPG key after 3 attempts"
          exit 1
      - name: Set up Swift
        run: |
          set -euo pipefail
          SWIFT_VERSION="6.2.3"
          SWIFT_PLATFORM="ubuntu22.04"
          SWIFT_TARBALL="swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}.tar.gz"
          SWIFT_URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/${SWIFT_TARBALL}"
          echo "Downloading Swift ${SWIFT_VERSION}..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}" -o "/tmp/${SWIFT_TARBALL}"
          echo "Verifying GPG signature..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}.sig" -o "/tmp/${SWIFT_TARBALL}.sig"
          gpg --verify "/tmp/${SWIFT_TARBALL}.sig" "/tmp/${SWIFT_TARBALL}" || echo "⚠️ GPG verification failed (non-fatal)"
          echo "Extracting Swift toolchain..."
          sudo tar -xzf "/tmp/${SWIFT_TARBALL}" -C /opt
          SWIFT_PATH="/opt/swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}/usr/bin"
          echo "${SWIFT_PATH}" >> $GITHUB_PATH
          export PATH="${SWIFT_PATH}:${PATH}"
          echo "✅ Swift ${SWIFT_VERSION} installed"
          swift --version

      - name: Build and test (Release)
        run: |
          # 4 batches to stay under Linux MAX_ARG_STRLEN (128KB per arg).
          # NOTE: Do NOT use `swift build -c release --build-tests` + `--skip-build` —
          # `--build-tests` in release mode does NOT pass `-enable-testing`.
          SKIP_ALWAYS="--skip PR5CaptureTests --disable-swift-testing"
          SKIP_UPLOADS="--skip UploadTests --skip UploadTestsB --skip UploadTestsC"
          SKIP_CORE="--skip Aether3DCoreTests --skip CITests --skip PR4MathTests --skip PR4PathTraceTests --skip PR4OwnershipTests --skip PR4OverflowTests --skip PR4LUTTests --skip PR4DeterminismTests --skip PR4SoftmaxTests --skip PR4HealthTests --skip PR4UncertaintyTests --skip PR4CalibrationTests --skip PR4GoldenTests --skip PR4IntegrationTests --skip EvidenceGridTests --skip EvidenceGridDeterminismTests"
          echo "=== Batch 1/4: Core + CI + PR4 + Evidence (~84KB) ==="
          swift test -c release $SKIP_ALWAYS $SKIP_UPLOADS --skip ConstantsTests --skip TSDFTests --skip ScanGuidanceTests
          echo "=== Batch 2/4: Constants + TSDF + ScanGuidance (~46KB) ==="
          swift test -c release --skip-build $SKIP_ALWAYS $SKIP_UPLOADS $SKIP_CORE
          echo "=== Batch 3/4: UploadTests (~65KB) ==="
          swift test -c release --skip-build $SKIP_ALWAYS --skip UploadTestsB --skip UploadTestsC --skip ConstantsTests --skip TSDFTests --skip ScanGuidanceTests $SKIP_CORE
          echo "=== Batch 4/4: UploadTestsB + UploadTestsC (~115KB) ==="
          swift test -c release --skip-build $SKIP_ALWAYS --skip UploadTests --skip ConstantsTests --skip TSDFTests --skip ScanGuidanceTests $SKIP_CORE

  fixtures-no-diff:
    name: Fixtures No-Diff
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            binutils git unzip gnupg2 libc6-dev libcurl4-openssl-dev \
            libedit2 libgcc-11-dev libpython3-dev libsqlite3-0 \
            libstdc++-11-dev libxml2-dev libz3-dev pkg-config tzdata \
            zlib1g-dev libsqlite3-dev
      - name: Import Swift GPG key
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            if curl -fsSL --compressed --retry 3 --retry-delay 5 https://swift.org/keys/all-keys.asc | gpg --import - 2>&1; then
              echo "✅ Swift GPG key imported successfully"
              exit 0
            fi
            echo "⚠️ Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "❌ Failed to import Swift GPG key after 3 attempts"
          exit 1
      - name: Set up Swift
        run: |
          set -euo pipefail
          SWIFT_VERSION="6.2.3"
          SWIFT_PLATFORM="ubuntu22.04"
          SWIFT_TARBALL="swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}.tar.gz"
          SWIFT_URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/${SWIFT_TARBALL}"
          echo "Downloading Swift ${SWIFT_VERSION}..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}" -o "/tmp/${SWIFT_TARBALL}"
          echo "Verifying GPG signature..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}.sig" -o "/tmp/${SWIFT_TARBALL}.sig"
          gpg --verify "/tmp/${SWIFT_TARBALL}.sig" "/tmp/${SWIFT_TARBALL}" || echo "⚠️ GPG verification failed (non-fatal)"
          echo "Extracting Swift toolchain..."
          sudo tar -xzf "/tmp/${SWIFT_TARBALL}" -C /opt
          SWIFT_PATH="/opt/swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}/usr/bin"
          echo "${SWIFT_PATH}" >> $GITHUB_PATH
          export PATH="${SWIFT_PATH}:${PATH}"
          echo "✅ Swift ${SWIFT_VERSION} installed"
          swift --version

      - name: Regenerate fixtures
        run: |
          scripts/regen_fixtures.sh
      - name: Check for diff
        run: |
          git diff --exit-code Tests/Fixtures || {
            echo "ERROR: Regenerated fixtures differ from committed fixtures"
            git diff Tests/Fixtures
            exit 1
          }

  ios-simulator:
    name: iOS Simulator Tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Build and test iOS Simulator
        run: |
          # Note: This requires an Xcode project/workspace
          # For now, we'll skip if no Xcode project exists
          if [ -f "*.xcodeproj" ] || [ -f "*.xcworkspace" ]; then
            xcodebuild test \
              -scheme Aether3DCoreTests \
              -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
              -enableCodeCoverage NO \
              || echo "iOS Simulator tests skipped (Xcode project not configured)"
          else
            echo "iOS Simulator tests skipped (no Xcode project found)"
          fi

  python-reference-verify:
    name: Python Reference Verification
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Verify DecisionHash fixtures
        run: |
          python3 scripts/verify_decisionhash_fixtures.py Tests/Fixtures/decision_hash_v1.txt

  swift-compiler-matrix:
    name: Swift Compiler Matrix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-15
            use-xcode: true
          - os: ubuntu-22.04
            swift-version: "6.2"
            use-xcode: false
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            binutils git unzip gnupg2 libc6-dev libcurl4-openssl-dev \
            libedit2 libgcc-11-dev libpython3-dev libsqlite3-0 \
            libstdc++-11-dev libxml2-dev libz3-dev pkg-config tzdata \
            zlib1g-dev libsqlite3-dev
      - name: Select stable Xcode (macOS)
        if: matrix.use-xcode
        run: |
          set -euo pipefail
          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "Selecting /Applications/$app"
              sudo xcode-select -s "/Applications/$app/Contents/Developer"
              return 0
            fi
            return 1
          }
          pick "Xcode_16.2.app" || pick "Xcode_16.1.app" || pick "Xcode_16.0.app" || pick "Xcode.app" || {
            echo "No Xcode found"; exit 1
          }
          swift --version
      - name: Import Swift GPG key (Linux)
        if: "!matrix.use-xcode"
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            if curl -fsSL --compressed --retry 3 --retry-delay 5 https://swift.org/keys/all-keys.asc | gpg --import - 2>&1; then
              echo "✅ Swift GPG key imported successfully"
              exit 0
            fi
            echo "⚠️ Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "❌ Failed to import Swift GPG key after 3 attempts"
          exit 1
      - name: Set up Swift (Linux)
        if: "!matrix.use-xcode"
        run: |
          set -euo pipefail
          SWIFT_VERSION="6.2.3"
          SWIFT_PLATFORM="ubuntu22.04"
          SWIFT_TARBALL="swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}.tar.gz"
          SWIFT_URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/${SWIFT_TARBALL}"
          echo "Downloading Swift ${SWIFT_VERSION}..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}" -o "/tmp/${SWIFT_TARBALL}"
          echo "Verifying GPG signature..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}.sig" -o "/tmp/${SWIFT_TARBALL}.sig"
          gpg --verify "/tmp/${SWIFT_TARBALL}.sig" "/tmp/${SWIFT_TARBALL}" || echo "⚠️ GPG verification failed (non-fatal)"
          echo "Extracting Swift toolchain..."
          sudo tar -xzf "/tmp/${SWIFT_TARBALL}" -C /opt
          SWIFT_PATH="/opt/swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}/usr/bin"
          echo "${SWIFT_PATH}" >> $GITHUB_PATH
          export PATH="${SWIFT_PATH}:${PATH}"
          echo "✅ Swift ${SWIFT_VERSION} installed"
          swift --version

      - name: Build and test
        run: |
          # PR5CaptureTests: @MainActor + async setUp/tearDown crashes test runner.
          # macOS: --skip only (do NOT use --disable-swift-testing — causes SIGTRAP).
          # Linux: 4-batch strategy — UploadTests split into 3 targets (each <128KB)
          #   to avoid posix_spawn MAX_ARG_STRLEN (128KB) overflow.
          if [ "$RUNNER_OS" = "Linux" ]; then
            SKIP_ALWAYS="--skip PR5CaptureTests --disable-swift-testing"
            SKIP_UPLOADS="--skip UploadTests --skip UploadTestsB --skip UploadTestsC"
            SKIP_CORE="--skip Aether3DCoreTests --skip CITests --skip PR4MathTests --skip PR4PathTraceTests --skip PR4OwnershipTests --skip PR4OverflowTests --skip PR4LUTTests --skip PR4DeterminismTests --skip PR4SoftmaxTests --skip PR4HealthTests --skip PR4UncertaintyTests --skip PR4CalibrationTests --skip PR4GoldenTests --skip PR4IntegrationTests --skip EvidenceGridTests --skip EvidenceGridDeterminismTests"
            swift build --build-tests
            echo "=== Batch 1/4: Core + CI + PR4 + Evidence (~84KB) ==="
            swift test --skip-build $SKIP_ALWAYS $SKIP_UPLOADS --skip ConstantsTests --skip TSDFTests --skip ScanGuidanceTests
            echo "=== Batch 2/4: Constants + TSDF + ScanGuidance (~46KB) ==="
            swift test --skip-build $SKIP_ALWAYS $SKIP_UPLOADS $SKIP_CORE
            echo "=== Batch 3/4: UploadTests (~65KB) ==="
            swift test --skip-build $SKIP_ALWAYS --skip UploadTestsB --skip UploadTestsC --skip ConstantsTests --skip TSDFTests --skip ScanGuidanceTests $SKIP_CORE
            echo "=== Batch 4/4: UploadTestsB + UploadTestsC (~115KB) ==="
            swift test --skip-build $SKIP_ALWAYS --skip UploadTests --skip ConstantsTests --skip TSDFTests --skip ScanGuidanceTests $SKIP_CORE
          else
            swift test --skip PR5CaptureTests
          fi
      - name: Extract CHECKS_TOTAL
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            swift test --skip-build --skip PR5CaptureTests --skip UploadTests --skip UploadTestsB --skip UploadTestsC --skip TSDFTests --skip ScanGuidanceTests --disable-swift-testing 2>&1 | grep -E "CHECKS_TOTAL=|VERIFICATION SUITE SUMMARY" || echo "CHECKS_TOTAL not found"
          else
            swift test --skip PR5CaptureTests 2>&1 | grep -E "CHECKS_TOTAL=|VERIFICATION SUITE SUMMARY" || echo "CHECKS_TOTAL not found"
          fi

  generate-verification-matrix:
    name: Generate Verification Matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate matrix
        run: |
          bash scripts/generate_verification_matrix.sh
      - name: Upload matrix
        uses: actions/upload-artifact@v4
        with:
          name: verification-matrix
          path: docs/constitution/VERIFICATION_MATRIX.md
