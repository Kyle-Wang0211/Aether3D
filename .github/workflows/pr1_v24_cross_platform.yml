name: PR1 v2.4 Cross-Platform Verification

on:
  pull_request:
    paths:
      - 'Core/**'
      - 'Tests/**'
      - 'Sources/**'
      - 'scripts/**'
      - '.github/workflows/pr1_v24_cross_platform.yml'
  push:
    branches:
      - main
      - 'pr1/**'
    paths:
      - 'Core/**'
      - 'Tests/**'
      - 'Sources/**'
      - 'scripts/**'
      - '.github/workflows/pr1_v24_cross_platform.yml'

env:
  LANG: C
  LC_ALL: C

jobs:
  swiftpm-macos-debug:
    name: SwiftPM macOS Debug
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Select stable Xcode
        run: |
          set -euo pipefail
          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "Selecting /Applications/$app"
              sudo xcode-select -s "/Applications/$app/Contents/Developer"
              return 0
            fi
            return 1
          }
          pick "Xcode_16.2.app" || pick "Xcode_16.1.app" || pick "Xcode_16.0.app" || pick "Xcode.app" || {
            echo "No Xcode found"; exit 1
          }
          swift --version
      - name: Build and test (Debug)
        run: |
          swift test
      - name: Extract CHECKS_TOTAL
        run: |
          swift test 2>&1 | grep -E "CHECKS_TOTAL=|VERIFICATION SUITE SUMMARY" || echo "CHECKS_TOTAL not found"

  swiftpm-macos-release:
    name: SwiftPM macOS Release
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Select stable Xcode
        run: |
          set -euo pipefail
          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "Selecting /Applications/$app"
              sudo xcode-select -s "/Applications/$app/Contents/Developer"
              return 0
            fi
            return 1
          }
          pick "Xcode_16.2.app" || pick "Xcode_16.1.app" || pick "Xcode_16.0.app" || pick "Xcode.app" || {
            echo "No Xcode found"; exit 1
          }
          swift --version
      - name: Build and test (Release)
        run: |
          swift test -c release

  swiftpm-ubuntu-debug:
    name: SwiftPM Ubuntu Debug
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev
      - name: Set up Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"

      - name: Build and test (Debug)
        run: |
          swift test
      - name: Extract CHECKS_TOTAL
        run: |
          swift test 2>&1 | grep -E "CHECKS_TOTAL=|VERIFICATION SUITE SUMMARY" || echo "CHECKS_TOTAL not found"

  swiftpm-ubuntu-release:
    name: SwiftPM Ubuntu Release
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev
      - name: Set up Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"

      - name: Build and test (Release)
        run: |
          swift test -c release

  fixtures-no-diff:
    name: Fixtures No-Diff
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev
      - name: Set up Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"

      - name: Regenerate fixtures
        run: |
          scripts/regen_fixtures.sh
      - name: Check for diff
        run: |
          git diff --exit-code Tests/Fixtures || {
            echo "ERROR: Regenerated fixtures differ from committed fixtures"
            git diff Tests/Fixtures
            exit 1
          }

  ios-simulator:
    name: iOS Simulator Tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      - name: Build and test iOS Simulator
        run: |
          # Note: This requires an Xcode project/workspace
          # For now, we'll skip if no Xcode project exists
          if [ -f "*.xcodeproj" ] || [ -f "*.xcworkspace" ]; then
            xcodebuild test \
              -scheme Aether3DCoreTests \
              -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
              -enableCodeCoverage NO \
              || echo "iOS Simulator tests skipped (Xcode project not configured)"
          else
            echo "iOS Simulator tests skipped (no Xcode project found)"
          fi

  python-reference-verify:
    name: Python Reference Verification
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Verify DecisionHash fixtures
        run: |
          python3 scripts/verify_decisionhash_fixtures.py Tests/Fixtures/decision_hash_v1.txt

  swift-compiler-matrix:
    name: Swift Compiler Matrix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-15
            use-xcode: true
          - os: ubuntu-22.04
            swift-version: "6.2"
            use-xcode: false
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev
      - name: Select stable Xcode (macOS)
        if: matrix.use-xcode
        run: |
          set -euo pipefail
          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "Selecting /Applications/$app"
              sudo xcode-select -s "/Applications/$app/Contents/Developer"
              return 0
            fi
            return 1
          }
          pick "Xcode_16.2.app" || pick "Xcode_16.1.app" || pick "Xcode_16.0.app" || pick "Xcode.app" || {
            echo "No Xcode found"; exit 1
          }
          swift --version
      - name: Set up Swift (Linux)
        if: "!matrix.use-xcode"
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: ${{ matrix.swift-version }}

      - name: Build and test
        run: |
          swift test
      - name: Extract CHECKS_TOTAL
        run: |
          swift test 2>&1 | grep -E "CHECKS_TOTAL=|VERIFICATION SUITE SUMMARY" || echo "CHECKS_TOTAL not found"

  generate-verification-matrix:
    name: Generate Verification Matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate matrix
        run: |
          bash scripts/generate_verification_matrix.sh
      - name: Upload matrix
        uses: actions/upload-artifact@v4
        with:
          name: verification-matrix
          path: docs/constitution/VERIFICATION_MATRIX.md
