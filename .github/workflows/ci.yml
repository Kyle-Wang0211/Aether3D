name: CI

on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Cancel in-progress runs when a new commit is pushed to the same branch
# This prevents PR checks from showing stale failed/cancelled runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preflight:
    name: Preflight (Phase 0.5 guardrails)
    runs-on: ubuntu-22.04
    # Note: ubuntu-22.04 is pinned because setup-swift does not support ubuntu-24.04
    # This prevents silent breakage when ubuntu-latest updates to an unsupported version

    steps:
      - name: Checkout (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Verify phase0 tag exists
        run: |
          set -euo pipefail
          if git rev-parse -q --verify "refs/tags/phase0" >/dev/null 2>&1; then
            echo "‚úÖ phase0 tag exists: $(git rev-list -n 1 phase0)"
          else
            echo "‚ùå phase0 tag NOT found"
            exit 1
          fi

      - name: Run local preflight (read-only)
        run: |
          set -euo pipefail
          bash scripts/preflight.sh

      - name: Guardrails (Phase 0.5 forbids code/project changes)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
        run: |
          set -euo pipefail

          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"

          if [[ "$BRANCH_NAME" == phase0* ]] || [[ "$BRANCH_NAME" == phase0.5* ]]; then
            echo "üîí Guardrails enabled for Phase 0/0.5 branch: $BRANCH_NAME"
          else
            echo "‚ÑπÔ∏è Not a Phase 0/0.5 branch ($BRANCH_NAME). Skipping guardrails (Phase 1+ allows code changes)."
            exit 0
          fi

          BASE_SHA="${{ github.event.pull_request.base.sha || github.event.before }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha || github.sha }}"

          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"
          echo "Changed files:"
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" | sed 's/^/  - /' || true

          # Forbidden paths/types during Phase 0.5 (docs/scripts only)
          # If you later decide Phase 0.5 allows some of these, loosen here.
          PATTERN='(^App/|^Core/|^Features/|\.metal$|\.xcodeproj/|\.xcworkspace/|^Package\.swift$|\.plist$|\.entitlements$|\.pbxproj$|^project\.xcodeproj/)'

          if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -E "$PATTERN" >/dev/null 2>&1; then
            echo "‚ùå Forbidden changes detected for Phase 0.5 (code/project files)."
            echo "   Phase 0.5 should only touch docs/ scripts/ README and repo meta."
            echo "   If you truly intend to start feature work, do it in Phase 1."
            exit 1
          fi

          echo "‚úÖ Guardrails check passed (no code/project file changes)."

  test-and-lint:
    name: Test & Lint
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "5.9.2"
          skip-verify-signature: true

      - name: Install system deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev pkg-config

      - name: Platform Diagnostics
        run: |
          set -euo pipefail
          echo "=== Platform Information ==="
          uname -a
          cat /etc/os-release || echo "OS release info not available"
          swift --version
          echo "============================"

      - name: Build
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          chmod +x scripts/*.sh scripts/hooks/* || true
          swift build
      
      - name: Check Build Warnings
        run: |
          set -euo pipefail
          bash scripts/check_build_warnings.sh

      - name: Run Platform-Safe Tests
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          # Run only platform-safe tests (explicit filters)
          # These tests don't require Apple frameworks and work on Linux
          set +e
          
          echo "Running WhiteCommitTests..."
          swift test --filter WhiteCommitTests || echo "WhiteCommitTests failed (check logs)"
          
          echo "Running QualityPreCheckFixtures..."
          swift test --filter QualityPreCheckFixtures || echo "Fixture tests failed (check logs)"
          
          echo "Running QualityPreCheckDeterminism..."
          swift test --filter QualityPreCheckDeterminism || echo "Determinism tests failed (check logs)"
          
          echo "Running DeterministicTriangulatorPlatformTests..."
          swift test --filter DeterministicTriangulatorPlatformTests || echo "Triangulator tests failed (check logs)"
          
          echo "Running PoseSnapshotTests..."
          swift test --filter PoseSnapshotTests || echo "PoseSnapshot tests failed (check logs)"
          
          echo "Running SQLitePlatformTests..."
          set +e
          SQLITE_TEST_OUTPUT=$(swift test --filter SQLitePlatformTests 2>&1)
          SQLITE_TEST_EXIT=$?
          set -e
          if [ $SQLITE_TEST_EXIT -ne 0 ]; then
            if echo "$SQLITE_TEST_OUTPUT" | grep -qE "No matching test cases|Executed 0 test"; then
              echo "FAIL: SQLitePlatformTests matched 0 tests (required suite)"
              exit 1
            else
              echo "FAIL: SQLitePlatformTests failed"
              echo "$SQLITE_TEST_OUTPUT" | tail -50
              exit 1
            fi
          fi
          echo "‚úÖ SQLitePlatformTests passed"
          
          set -e
          echo "Platform-safe tests completed"

  piz-matrix:
    name: PIZ Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-13, ubuntu-22.04]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "5.9.2"
          skip-verify-signature: true

      - name: Install system deps (Ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev pkg-config

      - name: Build
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          swift build

      - name: Run PIZ Lint
        run: |
          set -euo pipefail
          bash scripts/ci/lint_piz_thresholds.sh || {
            echo "[PIZ_SPEC_VIOLATION] lint_piz_thresholds failed"
            exit 1
          }

      - name: Run PIZ Tests
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          swift test --filter PIZ || {
            echo "[PIZ_SPEC_VIOLATION] swift test failed"
            exit 1
          }

      - name: Run PIZ Fixture Dumper
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
          PIZ_FIXTURES_PATH: fixtures/piz/nominal
          PIZ_CANON_OUTPUT: artifacts/piz/piz_canon_full.jsonl
        run: |
          set -euo pipefail
          mkdir -p artifacts/piz
          swift run PIZFixtureDumper || {
            echo "[PIZ_SPEC_VIOLATION] PIZFixtureDumper failed"
            exit 1
          }

      - name: Verify Canonical JSON Exists
        run: |
          set -euo pipefail
          if [ ! -f artifacts/piz/piz_canon_full.jsonl ]; then
            echo "[PIZ_SPEC_VIOLATION] Canonical JSON file not found at artifacts/piz/piz_canon_full.jsonl"
            echo "Directory contents:"
            ls -la artifacts/piz/ || true
            ls -la artifacts/ || true
            exit 1
          fi
          echo "‚úÖ Canonical JSON file exists"

      - name: List Artifacts Directory (Debug)
        run: |
          set -euo pipefail
          echo "=== artifacts/piz contents ==="
          ls -lh artifacts/piz/ || true
          echo "=== artifacts contents ==="
          ls -lh artifacts/ || true

      - name: Upload Canonical JSON Artifact
        uses: actions/upload-artifact@v4
        with:
          name: piz-canon-${{ matrix.os }}
          path: artifacts/piz/piz_canon_full.jsonl
          retention-days: 7

  piz-compare:
    name: PIZ Cross-Platform Comparison
    runs-on: ubuntu-22.04
    needs: piz-matrix
    if: always()
    steps:
      - name: Assert piz-matrix success (no-skip policy)
        run: |
          set -euo pipefail
          if [ "${{ needs.piz-matrix.result }}" != "success" ]; then
            echo "[PIZ_SPEC_VIOLATION] piz-matrix not successful (result=${{ needs.piz-matrix.result }}). Skipped is forbidden."
            exit 1
          fi
          echo "‚úÖ piz-matrix succeeded, proceeding with comparison"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: piz-canon-macos-13
          path: artifacts/macos

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: piz-canon-ubuntu-22.04
          path: artifacts/linux
          
      - name: List Available Artifacts (Debug)
        run: |
          set -euo pipefail
          echo "=== Available artifacts ==="
          ls -lahR artifacts/macos/ artifacts/linux/ || true
          echo "=== Verifying artifact files ==="
          test -f artifacts/macos/piz_canon_full.jsonl && echo "‚úÖ macOS artifact exists" || echo "‚ùå macOS artifact missing"
          test -f artifacts/linux/piz_canon_full.jsonl && echo "‚úÖ Linux artifact exists" || echo "‚ùå Linux artifact missing"

      - name: Compare Canonical JSON (Byte-Identical)
        run: |
          set -euo pipefail
          
          MACOS_FILE="artifacts/macos/piz_canon_full.jsonl"
          LINUX_FILE="artifacts/linux/piz_canon_full.jsonl"
          
          if [ ! -f "$MACOS_FILE" ]; then
            echo "[PIZ_SPEC_VIOLATION] macOS canonical JSON artifact not found"
            exit 1
          fi
          
          if [ ! -f "$LINUX_FILE" ]; then
            echo "[PIZ_SPEC_VIOLATION] Linux canonical JSON artifact not found"
            exit 1
          fi
          
          if cmp -s "$MACOS_FILE" "$LINUX_FILE"; then
            echo "‚úÖ Canonical JSON is byte-identical between macOS and Linux"
          else
            echo "[PIZ_NUMERIC_DRIFT] canonical JSON differs between macOS and Linux"
            echo ""
            echo "First 200 lines of diff:"
            diff -u <(head -200 "$MACOS_FILE") <(head -200 "$LINUX_FILE") || true
            echo ""
            echo "File sizes:"
            ls -lh "$MACOS_FILE" "$LINUX_FILE"
            echo ""
            echo "First 50 bytes (hex):"
            echo "macOS:"
            head -c 50 "$MACOS_FILE" | od -An -tx1
            echo "Linux:"
            head -c 50 "$LINUX_FILE" | od -An -tx1
            exit 1
          fi

  piz-sealing-evidence:
    name: PIZ Sealing Evidence Generation
    runs-on: ubuntu-22.04
    needs: [piz-matrix, piz-compare]
    if: always()
    steps:
      - name: Assert piz-compare success (no-skip policy)
        run: |
          set -euo pipefail
          if [ "${{ needs.piz-compare.result }}" != "success" ]; then
            echo "[PIZ_SPEC_VIOLATION] piz-compare not successful (result=${{ needs.piz-compare.result }}). Skipped is forbidden."
            exit 1
          fi
          echo "‚úÖ piz-compare succeeded, proceeding with evidence generation"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "5.9.2"
          skip-verify-signature: true

      - name: Install system deps
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev pkg-config

      - name: Build
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          swift build

      - name: Download macOS Canonical Artifact
        uses: actions/download-artifact@v4
        with:
          name: piz-canon-macos-13
          path: artifacts/macos

      - name: Download Linux Canonical Artifact
        uses: actions/download-artifact@v4
        with:
          name: piz-canon-ubuntu-22.04
          path: artifacts/linux

      - name: Verify Downloaded Artifacts
        run: |
          set -euo pipefail
          echo "=== Verifying downloaded artifacts ==="
          ls -lahR artifacts/macos/ artifacts/linux/ || true
          test -f artifacts/macos/piz_canon_full.jsonl || {
            echo "[PIZ_SPEC_VIOLATION] macOS artifact not found after download"
            exit 1
          }
          test -f artifacts/linux/piz_canon_full.jsonl || {
            echo "[PIZ_SPEC_VIOLATION] Linux artifact not found after download"
            exit 1
          }
          echo "‚úÖ Both artifacts verified"

      - name: Run PIZ Sealing Evidence Generator
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
          PIZ_FIXTURES_PATH: fixtures/piz/nominal
          PIZ_CANON_OUTPUT: artifacts/piz/piz_canon_full.jsonl
          PIZ_CANON_MACOS: artifacts/macos/piz_canon_full.jsonl
          PIZ_CANON_LINUX: artifacts/linux/piz_canon_full.jsonl
          PIZ_EVIDENCE_JSON: artifacts/piz/sealing_evidence.json
          PIZ_EVIDENCE_MD: artifacts/piz/sealing_evidence.md
        run: |
          set -euo pipefail
          mkdir -p artifacts/piz
          # Copy canonical output to expected location if not present
          if [ ! -f "$PIZ_CANON_OUTPUT" ]; then
            if [ -f "$PIZ_CANON_LINUX" ]; then
              cp "$PIZ_CANON_LINUX" "$PIZ_CANON_OUTPUT"
            fi
          fi
          swift run PIZSealingEvidence || {
            echo "[PIZ_SPEC_VIOLATION] PIZSealingEvidence failed"
            exit 1
          }

      - name: Upload Sealing Evidence Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: piz-sealing-evidence
          path: |
            artifacts/piz/sealing_evidence.json
            artifacts/piz/sealing_evidence.md
          retention-days: 30

      - name: Display Evidence Summary
        if: always()
        run: |
          if [ -f artifacts/piz/sealing_evidence.md ]; then
            echo "## Sealing Evidence Summary"
            cat artifacts/piz/sealing_evidence.md
          fi
