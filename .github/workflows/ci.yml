name: CI

on:
  pull_request:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # SSOT Declaration Gate (cannot be bypassed with --no-verify)
  # ============================================================================
  ssot-declaration-gate:
    name: SSOT Declaration Gate
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Must! For diff comparison
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Fetch base branch
        if: github.event_name == 'pull_request'
        run: |
          git fetch origin ${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}

      - name: Verify SSOT declarations
        env:
          CI: "true"
          GITHUB_BASE_REF: ${{ github.base_ref || 'main' }}
          GITHUB_HEAD_REF: ${{ github.head_ref || github.ref_name }}
        run: |
          echo "=== SSOT Declaration Gate (CI-enforced) ==="
          echo "Base ref: $GITHUB_BASE_REF"
          echo "Head ref: ${{ github.head_ref || github.ref_name }}"
          bash scripts/ci/ssot_declaration_check.sh

      - name: Verify SSOT integrity
        run: |
          bash scripts/ci/ssot_integrity_verify.sh

      - name: Verify SSOT consistency
        run: |
          bash scripts/ci/ssot_consistency_verify.sh

      - name: Verify CI integrity
        run: |
          bash scripts/ci/ci_integrity_verify.sh

      - name: Detect workflow self-modification
        run: |
          WORKFLOW_CHANGES=$(git diff --name-only origin/${{ github.base_ref || 'main' }}...HEAD -- .github/workflows/ || true)
          if [ -n "$WORKFLOW_CHANGES" ]; then
            echo "‚ö†Ô∏è  WARNING: This PR modifies CI workflow files:"
            echo "$WORKFLOW_CHANGES"
            echo ""
            echo "Workflow changes require:"
            echo "  1. SSOT-Change: yes in commit message(s) that modify workflow files"
            echo "  2. CODEOWNERS approval"
            echo "  3. Additional security review"

            # Check all commits that touch workflow files (not just HEAD)
            # Get commits that actually modified workflow files
            FAILED=0
            for file in $WORKFLOW_CHANGES; do
              # Get all commits that modified this workflow file
              COMMITS_TOUCHING_FILE=$(git log --oneline origin/${{ github.base_ref || 'main' }}..HEAD --follow -- "$file" | head -20)
              if [ -n "$COMMITS_TOUCHING_FILE" ]; then
                echo ""
                echo "Commits modifying $file:"
                echo "$COMMITS_TOUCHING_FILE"

                # Check each commit that touched this file
                while IFS= read -r commit_line; do
                  [ -z "$commit_line" ] && continue
                  COMMIT_SHA=$(echo "$commit_line" | cut -d' ' -f1)
                  COMMIT_MSG=$(git log -1 --pretty=%B "$COMMIT_SHA")

                  if ! echo "$COMMIT_MSG" | grep -qE '^SSOT-Change: yes$'; then
                    echo "‚ùå Commit $COMMIT_SHA modifies workflow but lacks SSOT-Change: yes"
                    FAILED=1
                  else
                    echo "‚úÖ Commit $COMMIT_SHA has SSOT-Change: yes"
                  fi
                done <<< "$COMMITS_TOUCHING_FILE"
              fi
            done

            if [ "$FAILED" -eq 1 ]; then
              echo ""
              echo "‚ùå FAIL: Workflow modification without SSOT-Change: yes in the modifying commit(s)"
              exit 1
            fi
            echo ""
            echo "‚úÖ All workflow-modifying commits have SSOT-Change: yes"
          fi

      - name: Generate SSOT audit log
        if: always()
        run: |
          bash scripts/ci/ssot_audit_log.sh || true

      - name: Upload audit log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ssot-audit-log
          path: .ssot_audit.jsonl
          if-no-files-found: ignore

      - name: Label SSOT changes
        if: github.event_name == 'pull_request'
        continue-on-error: true  # Don't fail the job if labeling fails (permission issues)
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            // Get changed files
            const baseRef = '${{ github.base_ref }}';
            const files = execSync(`git diff --name-only origin/${baseRef}...HEAD`).toString().split('\n');

            const ssotPrefixes = [
              'Core/Constants/',
              'Core/SSOT/',
              'docs/constitution/',
              '.github/workflows/',
              'scripts/ci/',
              'scripts/hooks/'
            ];

            const hasSSOTChanges = files.some(f =>
              ssotPrefixes.some(p => f.startsWith(p))
            );

            if (hasSSOTChanges) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: ['ssot-change', 'requires-review']
                });

                // Add comment (only if labeling succeeded)
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: '‚ö†Ô∏è **SSOT Change Detected**\n\nThis PR modifies SSOT-protected files. Please ensure:\n\n- [ ] All commits have `SSOT-Change: yes` footer\n- [ ] Changes are reviewed by CODEOWNERS\n- [ ] No bypass attempts detected'
                });
              } catch (error) {
                console.log('Warning: Could not add labels/comments (may lack permissions):', error.message);
                // Non-blocking - labeling is informational only
              }
            }

  preflight:
    name: Preflight (Phase 0.5 guardrails)
    runs-on: ubuntu-22.04
    # Note: ubuntu-22.04 is pinned because setup-swift does not support ubuntu-24.04
    # This prevents silent breakage when ubuntu-latest updates to an unsupported version

    steps:
      - name: Checkout (with tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Verify phase0 tag exists
        run: |
          set -euo pipefail
          if git rev-parse -q --verify "refs/tags/phase0" >/dev/null 2>&1; then
            echo "‚úÖ phase0 tag exists: $(git rev-list -n 1 phase0)"
          else
            echo "‚ùå phase0 tag NOT found"
            exit 1
          fi

      - name: Run local preflight (read-only)
        run: |
          set -euo pipefail
          bash scripts/preflight.sh

      - name: Guardrails (Phase 0.5 forbids code/project changes)
        if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
        run: |
          set -euo pipefail

          BRANCH_NAME="${{ github.head_ref || github.ref_name }}"

          if [[ "$BRANCH_NAME" == phase0* ]] || [[ "$BRANCH_NAME" == phase0.5* ]]; then
            echo "üîí Guardrails enabled for Phase 0/0.5 branch: $BRANCH_NAME"
          else
            echo "‚ÑπÔ∏è Not a Phase 0/0.5 branch ($BRANCH_NAME). Skipping guardrails (Phase 1+ allows code changes)."
            exit 0
          fi

          BASE_SHA="${{ github.event.pull_request.base.sha || github.event.before }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha || github.sha }}"

          echo "Base: $BASE_SHA"
          echo "Head: $HEAD_SHA"
          echo "Changed files:"
          git diff --name-only "$BASE_SHA" "$HEAD_SHA" | sed 's/^/  - /' || true

          # Forbidden paths/types during Phase 0.5 (docs/scripts only)
          # If you later decide Phase 0.5 allows some of these, loosen here.
          PATTERN='(^App/|^Core/|^Features/|\.metal$|\.xcodeproj/|\.xcworkspace/|^Package\.swift$|\.plist$|\.entitlements$|\.pbxproj$|^project\.xcodeproj/)'

          if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -E "$PATTERN" >/dev/null 2>&1; then
            echo "‚ùå Forbidden changes detected for Phase 0.5 (code/project files)."
            echo "   Phase 0.5 should only touch docs/ scripts/ README and repo meta."
            echo "   If you truly intend to start feature work, do it in Phase 1."
            exit 1
          fi

          echo "‚úÖ Guardrails check passed (no code/project file changes)."

  test-and-lint:
    name: Test & Lint (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [ssot-declaration-gate]
    strategy:
      matrix:
        include:
          - os: macos-15
            use-xcode: true
          - os: ubuntu-22.04
            swift-version: "6.2"
            use-xcode: false
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Select stable Xcode (macOS)
        if: matrix.use-xcode
        run: |
          set -euo pipefail
          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "Selecting /Applications/$app"
              sudo xcode-select -s "/Applications/$app/Contents/Developer"
              return 0
            fi
            return 1
          }
          pick "Xcode_16.2.app" || pick "Xcode_16.1.app" || pick "Xcode_16.0.app" || pick "Xcode.app" || {
            echo "No Xcode found"; exit 1
          }

      - name: Import Swift GPG key (Linux)
        if: "!matrix.use-xcode"
        run: |
          curl -fsSL https://swift.org/keys/all-keys.asc | gpg --import -

      - name: Setup Swift (Linux)
        if: "!matrix.use-xcode"
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"

      - name: Install system deps (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev pkg-config

      - name: Platform Diagnostics
        run: |
          set -euo pipefail
          echo "=== Platform Information ==="
          uname -a
          cat /etc/os-release || echo "OS release info not available"
          swift --version
          echo "============================"

      - name: Build
        env:
          LC_ALL: C
          LANG: C
          TZ: UTC
        run: |
          set -euo pipefail
          chmod +x scripts/*.sh scripts/hooks/* || true
          swift build
      
      - name: Check Build Warnings
        run: |
          set -euo pipefail
          bash scripts/check_build_warnings.sh

      - name: Run Platform-Safe Tests
        env:
          LC_ALL: C
          LANG: C
          TZ: UTC
        run: |
          set -euo pipefail
          # Run only platform-safe tests (explicit filters)
          # These tests don't require Apple frameworks and work on Linux
          set +e
          
          echo "Running CrossPlatformGoldenSmokeTests..."
          swift test --filter CrossPlatformGoldenSmokeTests || echo "CrossPlatformGoldenSmokeTests failed (check logs)"
          
          echo "Running Blake3GoldenVectorTests..."
          swift test --filter Blake3GoldenVectorTests || echo "Blake3GoldenVectorTests failed (check logs)"
          
          echo "Running CanonicalEndiannessGoldenTests..."
          swift test --filter CanonicalEndiannessGoldenTests || echo "CanonicalEndiannessGoldenTests failed (check logs)"
          
          echo "Running CanonicalBytesLengthTests..."
          swift test --filter CanonicalBytesLengthTests || echo "CanonicalBytesLengthTests failed (check logs)"
          
          echo "Running CanonicalNoStringNoJSONScanTests..."
          swift test --filter CanonicalNoStringNoJSONScanTests || echo "CanonicalNoStringNoJSONScanTests failed (check logs)"
          
          echo "Running SchemaVersionGatingTests..."
          swift test --filter SchemaVersionGatingTests || echo "SchemaVersionGatingTests failed (check logs)"
          
          echo "Running DecisionHashOutputFormattingTests..."
          swift test --filter DecisionHashOutputFormattingTests || echo "DecisionHashOutputFormattingTests failed (check logs)"
          
          echo "Running PR1 v2.4 Addendum Verification Suite..."
          # Run all tests to accumulate check count, then extract CHECKS_TOTAL
          # The ChecksTotalSmokeTest will verify >=1000 checks at the end
          VERIFICATION_OUTPUT=$(swift test 2>&1) || echo "Some tests failed (check logs)"
          echo "$VERIFICATION_OUTPUT"
          
          # Extract and print CHECKS_TOTAL from test output
          echo "Extracting CHECKS_TOTAL..."
          echo "$VERIFICATION_OUTPUT" | grep -E "CHECKS_TOTAL=|VERIFICATION SUITE SUMMARY" || echo "CHECKS_TOTAL not found in output"
          swift test --filter DecisionHashOutputFormattingTests || echo "DecisionHashOutputFormattingTests failed (check logs)"
          
          set +e
          
          echo "Running WhiteCommitTests..."
          swift test --filter WhiteCommitTests || echo "WhiteCommitTests failed (check logs)"
          
          echo "Running QualityPreCheckFixtures..."
          swift test --filter QualityPreCheckFixtures || echo "Fixture tests failed (check logs)"
          
          echo "Running QualityPreCheckDeterminism..."
          swift test --filter QualityPreCheckDeterminism || echo "Determinism tests failed (check logs)"
          
          echo "Running DeterministicTriangulatorPlatformTests..."
          swift test --filter DeterministicTriangulatorPlatformTests || echo "Triangulator tests failed (check logs)"
          
          echo "Running PoseSnapshotTests..."
          swift test --filter PoseSnapshotTests || echo "PoseSnapshot tests failed (check logs)"
          
          echo "Running SQLitePlatformTests..."
          set +e
          SQLITE_TEST_OUTPUT=$(swift test --filter SQLitePlatformTests 2>&1)
          SQLITE_TEST_EXIT=$?
          set -e
          if [ $SQLITE_TEST_EXIT -ne 0 ]; then
            if echo "$SQLITE_TEST_OUTPUT" | grep -qE "No matching test cases|Executed 0 test"; then
              echo "FAIL: SQLitePlatformTests matched 0 tests (required suite)"
              exit 1
            else
              echo "FAIL: SQLitePlatformTests failed"
              echo "$SQLITE_TEST_OUTPUT" | tail -50
              exit 1
            fi
          fi
          echo "‚úÖ SQLitePlatformTests passed"
          
          set -e
          echo "Platform-safe tests completed"
          
      - name: Verify Fixtures Unchanged
        run: |
          set -euo pipefail
          # Ensure fixtures are not modified unexpectedly
          # If fixture generation runs, verify fixtures are unchanged
          git diff --exit-code Tests/Fixtures/ || {
            echo "ERROR: Fixtures were modified unexpectedly"
            echo "Fixtures must be generated using scripts/gen-fixtures-decisionhash-v1.swift and committed"
            exit 1
          }

  piz-matrix:
    name: PIZ Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [ssot-declaration-gate]
    timeout-minutes: 120
    strategy:
      matrix:
        os: [macos-15, ubuntu-22.04]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}

      - name: Select stable Xcode on macOS (single Swift source)
        if: matrix.os == 'macos-15'
        run: |
          set -euo pipefail
          echo "=== Available Xcode installations ==="
          ls -1 /Applications | grep -E '^Xcode(_[0-9]+\.[0-9]+)?\.app$' || echo "No Xcode found in /Applications"
          echo ""

          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "‚úÖ Selecting /Applications/$app"
              export DEVELOPER_DIR="/Applications/$app/Contents/Developer"
              sudo xcode-select -s "$DEVELOPER_DIR"
              return 0
            fi
            return 1
          }

          echo "=== Selecting Xcode (priority: 16.2 > 16.1 > 16.0 > default) ==="
          # Note: macOS-15 runner uses Xcode 16.x by default; we prioritize stable versions
          # WHY: Prevent BitwiseCopyable/swiftinterface errors from mixing Xcode SDK with external Swift toolchain
          pick "Xcode_16.2.app" || \
          pick "Xcode_16.1.app" || \
          pick "Xcode_16.0.app" || \
          pick "Xcode.app" || {
            echo "[PIZ_SPEC_VIOLATION] No Xcode found in /Applications"
            exit 1
          }

          export DEVELOPER_DIR="$(xcode-select -p)"
          echo "DEVELOPER_DIR=$DEVELOPER_DIR" >> "$GITHUB_ENV"
          echo ""
          echo "=== Xcode version ==="
          xcodebuild -version
          echo ""
          echo "=== Swift toolchain verification (xcrun) ==="
          XCRUN_SWIFT="$(xcrun --find swift)"
          echo "XCRUN_SWIFT: $XCRUN_SWIFT"
          echo "DEVELOPER_DIR: $DEVELOPER_DIR"
          echo ""
          echo "=== Swift version (xcrun) ==="
          xcrun swift --version
          echo ""
          echo "=== SDK path ==="
          xcrun --show-sdk-path
          echo ""
          if [[ ! "$XCRUN_SWIFT" == "$DEVELOPER_DIR"* ]]; then
            echo "[PIZ_SPEC_VIOLATION] macOS Swift toolchain mismatch: xcrun swift is not from selected Xcode"
            echo "XCRUN_SWIFT: $XCRUN_SWIFT"
            echo "DEVELOPER_DIR: $DEVELOPER_DIR"
            echo "xcodebuild version:"
            xcodebuild -version
            exit 1
          fi
          echo "‚úÖ Swift is from selected Xcode (verified via xcrun)"

      - name: Import Swift GPG key (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          curl -fsSL https://swift.org/keys/all-keys.asc | gpg --import -

      - name: Setup Swift (Linux only)
        if: matrix.os == 'ubuntu-22.04'
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"

      - name: Install system deps (Ubuntu)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev pkg-config

      - name: Build
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          swift build

      - name: Run PIZ Lint
        run: |
          set -euo pipefail
          bash scripts/ci/lint_piz_thresholds.sh || {
            echo "[PIZ_SPEC_VIOLATION] lint_piz_thresholds failed"
            exit 1
          }

      - name: Run PIZ Tests
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        if: matrix.os != 'macos-15'
        run: |
          set -euo pipefail
          swift test --filter PIZ || {
            echo "[PIZ_SPEC_VIOLATION] swift test failed"
            exit 1
          }

      - name: Run PIZ Tests (macOS with retry)
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        if: matrix.os == 'macos-15'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 5
          command: |
            set -euo pipefail
            swift test --filter PIZ || {
              echo "[PIZ_SPEC_VIOLATION] swift test failed"
              exit 1
            }

      - name: Run PIZ Fixture Dumper
        env:
          LC_ALL: C
          LANG: C
          TZ: UTC
          PIZ_FIXTURES_PATH: fixtures/piz/nominal
          PIZ_CANON_OUTPUT: artifacts/piz/piz_canon_full.jsonl
          PIZ_CANONICAL_MODE: "1"
          PIZ_CANON_TIMESTAMP: "1970-01-01T00:00:00Z"
        if: matrix.os != 'macos-15'
        run: |
          set -euo pipefail
          mkdir -p artifacts/piz
          swift run PIZFixtureDumper || {
            echo "[PIZ_SPEC_VIOLATION] PIZFixtureDumper failed"
            exit 1
          }
          
      - name: Verify Canonical JSON Determinism (Linux)
        env:
          LC_ALL: C
          LANG: C
          TZ: UTC
          PIZ_FIXTURES_PATH: fixtures/piz/nominal
        if: matrix.os != 'macos-15'
        run: |
          set -euo pipefail
          mkdir -p artifacts/piz
          # Build once before determinism check to avoid SwiftPM build logs in output
          swift build || {
            echo "[PIZ_SPEC_VIOLATION] swift build failed"
            exit 1
          }
          # Generate canonical output twice and compare for determinism
          # Use --skip-build to avoid SwiftPM build logs, redirect stderr to log file
          swift run --skip-build PIZFixtureDumper 2> artifacts/piz/piz_fixture_dumper_run1.log > artifacts/piz/piz_canon_full_1.jsonl || {
            echo "[PIZ_SPEC_VIOLATION] PIZFixtureDumper failed (first run)"
            cat artifacts/piz/piz_fixture_dumper_run1.log
            exit 1
          }
          swift run --skip-build PIZFixtureDumper 2> artifacts/piz/piz_fixture_dumper_run2.log > artifacts/piz/piz_canon_full_2.jsonl || {
            echo "[PIZ_SPEC_VIOLATION] PIZFixtureDumper failed (second run)"
            cat artifacts/piz/piz_fixture_dumper_run2.log
            exit 1
          }
          
          if ! cmp -s artifacts/piz/piz_canon_full_1.jsonl artifacts/piz/piz_canon_full_2.jsonl; then
            echo "[PIZ_NUMERIC_DRIFT] NONDETERMINISM DETECTED: canonical output differs between runs"
            echo "File sizes:"
            ls -lh artifacts/piz/piz_canon_full_*.jsonl
            echo ""
            echo "First 200 lines diff:"
            diff -u <(head -200 artifacts/piz/piz_canon_full_1.jsonl) <(head -200 artifacts/piz/piz_canon_full_2.jsonl) || true
            echo ""
            echo "SHA-256 hashes:"
            sha256sum artifacts/piz/piz_canon_full_*.jsonl || shasum -a 256 artifacts/piz/piz_canon_full_*.jsonl
            exit 1
          fi
          echo "‚úÖ Canonical output is deterministic (byte-identical between runs)"
          
          # Copy first run to final output
          cp artifacts/piz/piz_canon_full_1.jsonl artifacts/piz/piz_canon_full.jsonl

      - name: Run PIZ Fixture Dumper (macOS with retry)
        env:
          LC_ALL: C
          LANG: C
          TZ: UTC
          PIZ_FIXTURES_PATH: fixtures/piz/nominal
          PIZ_CANON_OUTPUT: artifacts/piz/piz_canon_full.jsonl
          PIZ_CANONICAL_MODE: "1"
          PIZ_CANON_TIMESTAMP: "1970-01-01T00:00:00Z"
        if: matrix.os == 'macos-15'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 30
          max_attempts: 3
          retry_wait_seconds: 5
          command: |
            set -euo pipefail
            mkdir -p artifacts/piz
            swift run PIZFixtureDumper || {
              echo "[PIZ_SPEC_VIOLATION] PIZFixtureDumper failed"
              exit 1
            }
            
      - name: Verify Canonical JSON Determinism (macOS)
        env:
          LC_ALL: C
          LANG: C
          TZ: UTC
          PIZ_FIXTURES_PATH: fixtures/piz/nominal
        if: matrix.os == 'macos-15'
        run: |
          set -euo pipefail
          mkdir -p artifacts/piz
          # Build once before determinism check to avoid SwiftPM build logs in output
          swift build || {
            echo "[PIZ_SPEC_VIOLATION] swift build failed"
            exit 1
          }
          # Generate canonical output twice and compare for determinism
          # Use --skip-build to avoid SwiftPM build logs, redirect stderr to log file
          swift run --skip-build PIZFixtureDumper 2> artifacts/piz/piz_fixture_dumper_run1.log > artifacts/piz/piz_canon_full_1.jsonl || {
            echo "[PIZ_SPEC_VIOLATION] PIZFixtureDumper failed (first run)"
            cat artifacts/piz/piz_fixture_dumper_run1.log
            exit 1
          }
          swift run --skip-build PIZFixtureDumper 2> artifacts/piz/piz_fixture_dumper_run2.log > artifacts/piz/piz_canon_full_2.jsonl || {
            echo "[PIZ_SPEC_VIOLATION] PIZFixtureDumper failed (second run)"
            cat artifacts/piz/piz_fixture_dumper_run2.log
            exit 1
          }
          
          if ! cmp -s artifacts/piz/piz_canon_full_1.jsonl artifacts/piz/piz_canon_full_2.jsonl; then
            echo "[PIZ_NUMERIC_DRIFT] NONDETERMINISM DETECTED: canonical output differs between runs"
            echo "File sizes:"
            ls -lh artifacts/piz/piz_canon_full_*.jsonl
            echo ""
            echo "First 200 lines diff:"
            diff -u <(head -200 artifacts/piz/piz_canon_full_1.jsonl) <(head -200 artifacts/piz/piz_canon_full_2.jsonl) || true
            echo ""
            echo "SHA-256 hashes:"
            sha256sum artifacts/piz/piz_canon_full_*.jsonl || shasum -a 256 artifacts/piz/piz_canon_full_*.jsonl
            exit 1
          fi
          echo "‚úÖ Canonical output is deterministic (byte-identical between runs)"
          
          # Copy first run to final output
          cp artifacts/piz/piz_canon_full_1.jsonl artifacts/piz/piz_canon_full.jsonl

      - name: Verify Canonical JSON Exists + Proof
        run: |
          set -euo pipefail
          if [ ! -f artifacts/piz/piz_canon_full.jsonl ]; then
            echo "[PIZ_SPEC_VIOLATION] Canonical JSON file not found at artifacts/piz/piz_canon_full.jsonl"
            echo "Directory contents:"
            ls -la artifacts/piz/ || true
            ls -la artifacts/ || true
            exit 1
          fi
          echo "‚úÖ Canonical JSON file exists"
          echo ""
          echo "=== Canonical JSON Proof (first 10 lines + hash) ==="
          head -10 artifacts/piz/piz_canon_full.jsonl
          echo ""
          echo "File size: $(wc -c < artifacts/piz/piz_canon_full.jsonl) bytes"
          echo "SHA-256: $(sha256sum artifacts/piz/piz_canon_full.jsonl | cut -d' ' -f1 || shasum -a 256 artifacts/piz/piz_canon_full.jsonl | cut -d' ' -f1)"

      - name: List Artifacts Directory (Debug)
        run: |
          set -euo pipefail
          echo "=== artifacts/piz contents ==="
          ls -lh artifacts/piz/ || true
          echo "=== artifacts contents ==="
          ls -lh artifacts/ || true

      - name: Upload Canonical JSON Artifact
        uses: actions/upload-artifact@v4
        with:
          name: piz-canon-${{ matrix.os }}
          path: artifacts/piz/piz_canon_full.jsonl
          retention-days: 7

  piz-compare:
    name: PIZ Cross-Platform Comparison
    runs-on: ubuntu-22.04
    needs: piz-matrix
    # WHY: always() ensures job runs even if upstream fails, then guard step fails explicitly
    # This prevents "skipped" status and provides clear failure reason
    if: always()
    env:
      PIZ_MACOS_ARTIFACT: piz-canon-macos-15
      PIZ_LINUX_ARTIFACT: piz-canon-ubuntu-22.04
    steps:
      - name: "Guard: Assert piz-matrix success (no-skip policy)"
        run: |
          set -euo pipefail
          if [ "${{ needs.piz-matrix.result }}" != "success" ]; then
            echo "[PIZ_SPEC_VIOLATION] piz-matrix not successful (result=${{ needs.piz-matrix.result }}). Cannot compare."
            echo "Upstream job status: ${{ needs.piz-matrix.result }}"
            exit 1
          fi
          echo "‚úÖ piz-matrix succeeded, proceeding with comparison"

      - name: Artifact presence proof (piz-compare)
        run: |
          set -euo pipefail
          echo "=== Expected artifacts ==="
          echo "macOS artifact: ${{ env.PIZ_MACOS_ARTIFACT }}"
          echo "Linux artifact: ${{ env.PIZ_LINUX_ARTIFACT }}"
          echo "Upstream piz-matrix result: ${{ needs.piz-matrix.result }}"
          # Note: We cannot check artifact existence via API before download,
          # but download step will fail with clear error if artifact is missing.
          # This step serves as documentation of expected artifact names.

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download macOS Artifact
        continue-on-error: false
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PIZ_MACOS_ARTIFACT }}
          path: artifacts/macos
        # If download fails, GitHub Actions will show clear error with artifact name

      - name: Verify macOS artifact downloaded
        run: |
          set -euo pipefail
          if [ ! -f artifacts/macos/piz_canon_full.jsonl ]; then
            echo "[PIZ_SPEC_VIOLATION] macOS artifact download failed or file missing"
            echo "Expected artifact name: ${{ env.PIZ_MACOS_ARTIFACT }}"
            echo "Expected file path: artifacts/macos/piz_canon_full.jsonl"
            echo "Upstream piz-matrix result: ${{ needs.piz-matrix.result }}"
            ls -lah artifacts/macos/ || echo "artifacts/macos/ directory does not exist"
            exit 1
          fi
          echo "‚úÖ macOS artifact verified"

      - name: Download Linux Artifact
        continue-on-error: false
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PIZ_LINUX_ARTIFACT }}
          path: artifacts/linux
        # If download fails, GitHub Actions will show clear error with artifact name

      - name: Verify Linux artifact downloaded
        run: |
          set -euo pipefail
          if [ ! -f artifacts/linux/piz_canon_full.jsonl ]; then
            echo "[PIZ_SPEC_VIOLATION] Linux artifact download failed or file missing"
            echo "Expected artifact name: ${{ env.PIZ_LINUX_ARTIFACT }}"
            echo "Expected file path: artifacts/linux/piz_canon_full.jsonl"
            echo "Upstream piz-matrix result: ${{ needs.piz-matrix.result }}"
            ls -lah artifacts/linux/ || echo "artifacts/linux/ directory does not exist"
            exit 1
          fi
          echo "‚úÖ Linux artifact verified"
          
      - name: List Available Artifacts (Debug)
        run: |
          set -euo pipefail
          echo "=== Available artifacts ==="
          ls -lahR artifacts/macos/ artifacts/linux/ || true
          echo "=== Verifying artifact files ==="
          test -f artifacts/macos/piz_canon_full.jsonl && echo "‚úÖ macOS artifact exists" || echo "‚ùå macOS artifact missing"
          test -f artifacts/linux/piz_canon_full.jsonl && echo "‚úÖ Linux artifact exists" || echo "‚ùå Linux artifact missing"

      - name: Compare Canonical JSON (Byte-Identical)
        run: |
          set -euo pipefail
          
          MACOS_FILE="artifacts/macos/piz_canon_full.jsonl"
          LINUX_FILE="artifacts/linux/piz_canon_full.jsonl"
          
          if [ ! -f "$MACOS_FILE" ]; then
            echo "[PIZ_SPEC_VIOLATION] macOS canonical JSON artifact not found"
            exit 1
          fi
          
          if [ ! -f "$LINUX_FILE" ]; then
            echo "[PIZ_SPEC_VIOLATION] Linux canonical JSON artifact not found"
            exit 1
          fi
          
          if cmp -s "$MACOS_FILE" "$LINUX_FILE"; then
            echo "‚úÖ Canonical JSON is byte-identical between macOS and Linux"
          else
            echo "[PIZ_NUMERIC_DRIFT] canonical JSON differs between macOS and Linux"
            echo ""
            echo "First 200 lines of diff:"
            diff -u <(head -200 "$MACOS_FILE") <(head -200 "$LINUX_FILE") || true
            echo ""
            echo "File sizes:"
            ls -lh "$MACOS_FILE" "$LINUX_FILE"
            echo ""
            echo "First 50 bytes (hex):"
            echo "macOS:"
            head -c 50 "$MACOS_FILE" | od -An -tx1
            echo "Linux:"
            head -c 50 "$LINUX_FILE" | od -An -tx1
            exit 1
          fi

  piz-sealing-evidence:
    name: PIZ Sealing Evidence Generation
    runs-on: ubuntu-22.04
    needs: [piz-matrix, piz-compare]
    # WHY: always() ensures job runs even if upstream fails, then guard step fails explicitly
    # This prevents "skipped" status and provides clear failure reason
    if: always()
    env:
      PIZ_MACOS_ARTIFACT: piz-canon-macos-15
      PIZ_LINUX_ARTIFACT: piz-canon-ubuntu-22.04
    steps:
      - name: "Guard: Assert piz-compare success (no-skip policy)"
        run: |
          set -euo pipefail
          if [ "${{ needs.piz-compare.result }}" != "success" ]; then
            echo "[PIZ_SPEC_VIOLATION] piz-compare not successful (result=${{ needs.piz-compare.result }}). Cannot generate evidence."
            echo "Upstream job status: piz-compare=${{ needs.piz-compare.result }}, piz-matrix=${{ needs.piz-matrix.result }}"
            exit 1
          fi
          echo "‚úÖ piz-compare succeeded, proceeding with evidence generation"

      - name: Artifact presence proof (piz-sealing-evidence)
        run: |
          set -euo pipefail
          echo "=== Expected artifacts ==="
          echo "macOS artifact: ${{ env.PIZ_MACOS_ARTIFACT }}"
          echo "Linux artifact: ${{ env.PIZ_LINUX_ARTIFACT }}"
          echo "Upstream piz-compare result: ${{ needs.piz-compare.result }}"
          echo "Upstream piz-matrix result: ${{ needs.piz-matrix.result }}"
          # Note: We cannot check artifact existence via API before download,
          # but download step will fail with clear error if artifact is missing.
          # This step serves as documentation of expected artifact names.

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Import Swift GPG key
        run: |
          curl -fsSL https://swift.org/keys/all-keys.asc | gpg --import -

      - name: Setup Swift
        uses: swift-actions/setup-swift@v3
        with:
          swift-version: "6.2"

      - name: Install system deps
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev pkg-config

      - name: Build
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          swift build

      - name: Download macOS Canonical Artifact
        continue-on-error: false
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PIZ_MACOS_ARTIFACT }}
          path: artifacts/macos
        # If download fails, GitHub Actions will show clear error with artifact name

      - name: Verify macOS artifact downloaded (piz-sealing-evidence)
        run: |
          set -euo pipefail
          if [ ! -f artifacts/macos/piz_canon_full.jsonl ]; then
            echo "[PIZ_SPEC_VIOLATION] macOS artifact download failed or file missing"
            echo "Expected artifact name: ${{ env.PIZ_MACOS_ARTIFACT }}"
            echo "Expected file path: artifacts/macos/piz_canon_full.jsonl"
            echo "Upstream piz-compare result: ${{ needs.piz-compare.result }}"
            echo "Upstream piz-matrix result: ${{ needs.piz-matrix.result }}"
            ls -lah artifacts/macos/ || echo "artifacts/macos/ directory does not exist"
            exit 1
          fi
          echo "‚úÖ macOS artifact verified"

      - name: Download Linux Canonical Artifact
        continue-on-error: false
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PIZ_LINUX_ARTIFACT }}
          path: artifacts/linux
        # If download fails, GitHub Actions will show clear error with artifact name

      - name: Verify Linux artifact downloaded (piz-sealing-evidence)
        run: |
          set -euo pipefail
          if [ ! -f artifacts/linux/piz_canon_full.jsonl ]; then
            echo "[PIZ_SPEC_VIOLATION] Linux artifact download failed or file missing"
            echo "Expected artifact name: ${{ env.PIZ_LINUX_ARTIFACT }}"
            echo "Expected file path: artifacts/linux/piz_canon_full.jsonl"
            echo "Upstream piz-compare result: ${{ needs.piz-compare.result }}"
            echo "Upstream piz-matrix result: ${{ needs.piz-matrix.result }}"
            ls -lah artifacts/linux/ || echo "artifacts/linux/ directory does not exist"
            exit 1
          fi
          echo "‚úÖ Linux artifact verified"

      - name: Run PIZ Sealing Evidence Generator
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
          PIZ_FIXTURES_PATH: fixtures/piz/nominal
          PIZ_CANON_OUTPUT: artifacts/piz/piz_canon_full.jsonl
          PIZ_CANON_MACOS: artifacts/macos/piz_canon_full.jsonl
          PIZ_CANON_LINUX: artifacts/linux/piz_canon_full.jsonl
          PIZ_EVIDENCE_JSON: artifacts/piz/sealing_evidence.json
          PIZ_EVIDENCE_MD: artifacts/piz/sealing_evidence.md
        run: |
          set -euo pipefail
          mkdir -p artifacts/piz
          # Copy canonical output to expected location if not present
          if [ ! -f "$PIZ_CANON_OUTPUT" ]; then
            if [ -f "$PIZ_CANON_LINUX" ]; then
              cp "$PIZ_CANON_LINUX" "$PIZ_CANON_OUTPUT"
            fi
          fi
          swift run PIZSealingEvidence || {
            echo "[PIZ_SPEC_VIOLATION] PIZSealingEvidence failed"
            exit 1
          }

      - name: Upload Sealing Evidence Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: piz-sealing-evidence
          path: |
            artifacts/piz/sealing_evidence.json
            artifacts/piz/sealing_evidence.md
          retention-days: 30

      - name: Display Evidence Summary
        if: always()
        run: |
          if [ -f artifacts/piz/sealing_evidence.md ]; then
            echo "## Sealing Evidence Summary"
            cat artifacts/piz/sealing_evidence.md
          fi

  piz-gate:
    name: PIZ Final Gate (no-skip policy)
    runs-on: ubuntu-22.04
    needs: [piz-matrix, piz-compare, piz-sealing-evidence]
    if: always()
    steps:
      - name: Assert all PIZ jobs succeeded (treat skipped/cancelled as failure)
        run: |
          set -euo pipefail
          echo "piz-matrix result: ${{ needs.piz-matrix.result }}"
          echo "piz-compare result: ${{ needs.piz-compare.result }}"
          echo "piz-sealing-evidence result: ${{ needs.piz-sealing-evidence.result }}"
          if [ "${{ needs.piz-matrix.result }}" != "success" ]; then
            echo "[PIZ_SPEC_VIOLATION] piz-matrix is not success (result=${{ needs.piz-matrix.result }})"
            exit 1
          fi
          if [ "${{ needs.piz-compare.result }}" != "success" ]; then
            echo "[PIZ_SPEC_VIOLATION] piz-compare is not success (result=${{ needs.piz-compare.result }})"
            exit 1
          fi
          if [ "${{ needs.piz-sealing-evidence.result }}" != "success" ]; then
            echo "[PIZ_SPEC_VIOLATION] piz-sealing-evidence is not success (result=${{ needs.piz-sealing-evidence.result }})"
            exit 1
          fi
          echo "‚úÖ PIZ Final Gate passed"
