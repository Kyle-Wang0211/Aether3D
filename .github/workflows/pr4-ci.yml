name: PR4 V10 CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'Sources/PR4**'
      - 'Tests/PR4**'
      - 'Package.swift'
  pull_request:
    branches: [main]
    paths:
      - 'Sources/PR4**'
      - 'Tests/PR4**'

jobs:
  test-macos-arm64:
    name: macOS ARM64 Tests
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select stable Xcode
        run: |
          set -euo pipefail
          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "Selecting /Applications/$app"
              sudo xcode-select -s "/Applications/$app/Contents/Developer"
              return 0
            fi
            return 1
          }
          pick "Xcode_16.2.app" || pick "Xcode_16.1.app" || pick "Xcode_16.0.app" || pick "Xcode.app" || {
            echo "No Xcode found"; exit 1
          }
          swift --version

      - name: Build
        run: swift build -c release

      - name: Run Tests
        run: swift test --enable-code-coverage

      - name: Generate Determinism Digest
        run: |
          swift run PR4DigestGenerator > digest-macos-arm64.txt || echo "0" > digest-macos-arm64.txt

      - name: Upload Digest
        uses: actions/upload-artifact@v4
        with:
          name: digest-macos-arm64
          path: digest-macos-arm64.txt

  test-macos-x86:
    name: macOS x86_64 Tests
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select stable Xcode
        run: |
          set -euo pipefail
          pick() {
            local app="$1"
            if [ -d "/Applications/$app/Contents/Developer" ]; then
              echo "Selecting /Applications/$app"
              sudo xcode-select -s "/Applications/$app/Contents/Developer"
              return 0
            fi
            return 1
          }
          pick "Xcode_16.2.app" || pick "Xcode_16.1.app" || pick "Xcode_16.0.app" || pick "Xcode.app" || {
            echo "No Xcode found"; exit 1
          }
          swift --version

      - name: Build
        run: swift build -c release

      - name: Run Tests
        run: swift test

      - name: Generate Determinism Digest
        run: |
          swift run PR4DigestGenerator > digest-macos-x86.txt || echo "0" > digest-macos-x86.txt

      - name: Upload Digest
        uses: actions/upload-artifact@v4
        with:
          name: digest-macos-x86
          path: digest-macos-x86.txt

  test-linux:
    name: Linux x86_64 Tests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Import Swift GPG key
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            if curl -fsSL --compressed --retry 3 --retry-delay 5 https://swift.org/keys/all-keys.asc | gpg --import - 2>&1; then
              echo "✅ Swift GPG key imported successfully"
              exit 0
            fi
            echo "⚠️ Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "❌ Failed to import Swift GPG key after 3 attempts"
          exit 1

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            binutils git unzip gnupg2 libc6-dev libcurl4-openssl-dev \
            libedit2 libgcc-11-dev libpython3-dev libsqlite3-0 \
            libstdc++-11-dev libxml2-dev libz3-dev pkg-config tzdata \
            zlib1g-dev libsqlite3-dev

      - name: Set up Swift
        run: |
          set -euo pipefail
          SWIFT_VERSION="6.2.3"
          SWIFT_PLATFORM="ubuntu22.04"
          SWIFT_TARBALL="swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}.tar.gz"
          SWIFT_URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/${SWIFT_TARBALL}"
          echo "Downloading Swift ${SWIFT_VERSION}..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}" -o "/tmp/${SWIFT_TARBALL}"
          echo "Verifying GPG signature..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}.sig" -o "/tmp/${SWIFT_TARBALL}.sig"
          gpg --verify "/tmp/${SWIFT_TARBALL}.sig" "/tmp/${SWIFT_TARBALL}" || echo "⚠️ GPG verification failed (non-fatal)"
          echo "Extracting Swift toolchain..."
          sudo tar -xzf "/tmp/${SWIFT_TARBALL}" -C /opt
          SWIFT_PATH="/opt/swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}/usr/bin"
          echo "${SWIFT_PATH}" >> $GITHUB_PATH
          export PATH="${SWIFT_PATH}:${PATH}"
          echo "✅ Swift ${SWIFT_VERSION} installed"
          swift --version

      - name: Build
        run: swift build -c release

      - name: Run Tests
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          swift test 2>&1 || {
            echo "❌ Tests failed. Checking for platform-specific issues..."
            swift test --verbose 2>&1 | tail -100
            exit 1
          }

      - name: Generate Determinism Digest
        run: |
          swift run PR4DigestGenerator > digest-linux-x86.txt || echo "0" > digest-linux-x86.txt

      - name: Upload Digest
        uses: actions/upload-artifact@v4
        with:
          name: digest-linux-x86
          path: digest-linux-x86.txt

  compare-digests:
    name: Cross-Platform Determinism Check
    needs: [test-macos-arm64, test-macos-x86, test-linux]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download macOS ARM64 Digest
        uses: actions/download-artifact@v4
        with:
          name: digest-macos-arm64
          path: digests/

      - name: Download macOS x86_64 Digest
        uses: actions/download-artifact@v4
        with:
          name: digest-macos-x86
          path: digests/

      - name: Download Linux Digest
        uses: actions/download-artifact@v4
        with:
          name: digest-linux-x86
          path: digests/

      - name: Compare Digests
        run: |
          echo "=== Cross-Platform Determinism Check ==="

          MACOS_ARM64=$(cat digests/digest-macos-arm64.txt)
          MACOS_X86=$(cat digests/digest-macos-x86.txt)
          LINUX=$(cat digests/digest-linux-x86.txt)

          echo "macOS ARM64: $MACOS_ARM64"
          echo "macOS x86_64: $MACOS_X86"
          echo "Linux x86_64: $LINUX"

          if [ "$MACOS_ARM64" != "$MACOS_X86" ]; then
            echo "❌ FAILED: macOS ARM64 vs x86_64 mismatch!"
            exit 1
          fi

          if [ "$MACOS_ARM64" != "$LINUX" ]; then
            echo "❌ FAILED: macOS ARM64 vs Linux mismatch!"
            exit 1
          fi

          echo "✅ All platforms produce identical determinism digest"

  lint:
    name: Static Analysis
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Check Health Isolation
        run: |
          echo "Checking Health module for forbidden imports..."

          FORBIDDEN_IMPORTS=$(grep -r "import PR4Quality\|import PR4Uncertainty\|import PR4Gate" Sources/PR4Health/ || true)

          if [ -n "$FORBIDDEN_IMPORTS" ]; then
            echo "❌ Health module has forbidden imports:"
            echo "$FORBIDDEN_IMPORTS"
            exit 1
          fi

          echo "✅ Health module isolation verified"

      - name: Check Accelerate Usage
        run: |
          echo "Checking for Accelerate/vDSP in critical path..."

          FORBIDDEN=$(grep -rE "import Accelerate|vDSP_|vForce|vImage" \
            Sources/PR4Math/ \
            Sources/PR4Softmax/ \
            Sources/PR4LUT/ \
            Sources/PR4Overflow/ || true)

          if [ -n "$FORBIDDEN" ]; then
            echo "❌ Accelerate/vDSP found in critical path:"
            echo "$FORBIDDEN"
            exit 1
          fi

          echo "✅ No Accelerate/vDSP in critical path"

      - name: Verify Package DAG
        run: |
          echo "Verifying Package dependency graph..."
          bash scripts/verify-package-dag.sh || exit 1
