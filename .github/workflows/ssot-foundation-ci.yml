name: SSOT Foundation CI (Guardian Layer)

# Prevent concurrent runs on same ref, but isolate per workflow to prevent cross-workflow cancellation
# For PRs: use PR number for better isolation; for push: use ref
# Concurrency group uses ONLY github.* contexts (compile-time evaluation)
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Runtime env for diagnostics only (mirrors concurrency group value)
env:
  SSOT_CONCURRENCY_GROUP: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}

on:
  pull_request:
    paths:
      - 'docs/constitution/**'
      - 'Core/Constants/**'
      - 'Tests/Constants/**'
      - '.github/workflows/ssot-foundation-ci.yml'
  push:
    branches: [main]
    paths:
      - 'docs/constitution/**'
      - 'Core/Constants/**'
      - 'Tests/Constants/**'
      - '.github/workflows/ssot-foundation-ci.yml'
  workflow_dispatch:
    # Manual trigger for experimental lanes
  schedule:
    # Run experimental native crypto lane nightly at 2 AM UTC
    - cron: '0 2 * * *'

# CI Philosophy: CI is the constitutional court of SSOT.
# CI must block silent drift, accidental identity changes, explanation inconsistencies, and "green by editing goldens".
# CI is allowed to be strict. CI is not allowed to be vague.

jobs:
  # Gate 0 ‚Äî Workflow Lint (Fastest, Blocks Everything)
  # Validates workflow job graph before any other jobs run
  # Prevents "unknown job" errors from silently recurring
  gate_0_workflow_lint:
    name: Gate 0 ‚Äî Workflow Lint
    runs-on: ubuntu-22.04  # Pinned to prevent runner drift
    timeout-minutes: 2
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # pinned from v4 (2026-01-24)
        with:
          fetch-depth: 0
      
      - name: Event Context Parity Check
        run: |
          set -euo pipefail
          echo "üîí Gate 0: Event Context Parity Check"
          echo "Validating GitHub Actions context consistency"
          echo ""
          
          EVENT_NAME="${{ github.event_name }}"
          REF="${{ github.ref }}"
          SHA="${{ github.sha }}"
          WORKFLOW="${{ github.workflow }}"
          ACTOR="${{ github.actor }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "Context snapshot:"
          echo "  event_name: ${EVENT_NAME}"
          echo "  ref: ${REF}"
          echo "  sha: ${SHA}"
          echo "  workflow: ${WORKFLOW}"
          echo "  actor: ${ACTOR}"
          echo "  pr_number: ${PR_NUMBER:-N/A}"
          echo ""
          
          # Validate event context consistency
          ERRORS=0
          
          if [ "$EVENT_NAME" = "pull_request" ]; then
            if [ -z "${PR_NUMBER}" ] || [ "${PR_NUMBER}" = "null" ]; then
              echo "‚ùå pull_request event but PR number is missing or null"
              ERRORS=$((ERRORS + 1))
            fi
            if [ -z "${REF}" ] || [ "${REF}" = "refs/heads/main" ]; then
              echo "‚ö†Ô∏è  pull_request event: ref should be PR ref, not main branch"
            fi
          elif [ "$EVENT_NAME" = "push" ]; then
            if [ -n "${PR_NUMBER}" ] && [ "${PR_NUMBER}" != "null" ]; then
              echo "‚ùå push event but PR number is set (${PR_NUMBER}) - context mismatch"
              ERRORS=$((ERRORS + 1))
            fi
            if [ -z "${REF}" ]; then
              echo "‚ùå push event but ref is empty"
              ERRORS=$((ERRORS + 1))
            fi
          else
            echo "‚ö†Ô∏è  Unexpected event type: ${EVENT_NAME}"
          fi
          
          # Validate required fields
          if [ -z "${SHA}" ]; then
            echo "‚ùå SHA is empty"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ -z "${WORKFLOW}" ]; then
            echo "‚ùå Workflow name is empty"
            ERRORS=$((ERRORS + 1))
          fi
          
          # Validate concurrency group computation
          CONCURRENCY_GROUP="${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          if [ -z "${CONCURRENCY_GROUP}" ] || [ "${CONCURRENCY_GROUP}" = "-" ]; then
            echo "‚ùå Concurrency group evaluates to empty or invalid: '${CONCURRENCY_GROUP}'"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "‚ùå Gate 0 FAILED: Event context validation failed ($ERRORS error(s))"
            echo "This indicates a GitHub Actions context mismatch that will cause merge-time failures"
            exit 1
          fi
          
          echo "‚úÖ Event context validation passed"
          echo ""
      
      - name: Validate Workflow Graph
        run: |
          set -euo pipefail
          echo "üîí Gate 0: Workflow Graph Validation"
          echo "Validating job graph to prevent 'unknown job' errors"
          echo ""
          
          chmod +x scripts/ci/validate_workflow_graph.sh
          bash scripts/ci/validate_workflow_graph.sh .github/workflows/ssot-foundation-ci.yml || {
            echo ""
            echo "‚ùå Gate 0 FAILED: Workflow job graph is invalid"
            echo "Fix job ID mismatches in 'needs:' references before proceeding"
            exit 1
          }
          
          echo ""
          echo "‚úÖ Gate 0 PASSED: Workflow job graph is valid"
  
  # Gate Linux Preflight (Ubuntu, Fast, Non-Blocking)
  # Catches 80% of Linux failures early without requiring Swift build
  # Runs in parallel with Gate 1 to minimize CI time
  gate_linux_preflight_only:
    name: Gate Linux Preflight (Ubuntu, Fast)
    runs-on: ubuntu-22.04
    needs: [gate_0_workflow_lint]
    timeout-minutes: 5
    permissions:
      contents: read
    # Linux-only: Disable crypto CPU feature detection to prevent SIGILL on CI CPUs
    # Prevents swift-crypto/OpenSSL/BoringSSL asm SIGILL on some hosted CI CPUs; forces software path
    env:
      OPENSSL_ia32cap: ":0"
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # pinned from v4 (2026-01-24)
        with:
          fetch-depth: 0
      
      - name: Runner & Toolchain Snapshot (Diagnostics)
        run: |
          set -euo pipefail
          echo "üîç Runner & Toolchain Snapshot (Diagnostics Only)"
          echo "This step provides environment diagnostics for drift analysis"
          echo ""
          
          echo "=== OS Information ==="
          uname -a
          if [ "$(uname)" = "Darwin" ]; then
            sw_vers || echo "  (sw_vers not available)"
          elif [ -f /etc/os-release ]; then
            cat /etc/os-release | grep -E "^(NAME|VERSION|ID)=" || echo "  (os-release parsing failed)"
          fi
          echo ""
          
          echo "=== Architecture ==="
          uname -m
          if command -v lscpu >/dev/null 2>&1; then
            echo ""
            lscpu | grep -E "^(Architecture|Model name|CPU\(s\)):" || echo "  (lscpu parsing failed)"
          fi
          echo ""
          
          echo "=== Toolchain Versions ==="
          swift --version || echo "  ‚ùå swift not available"
          if [ "$(uname)" = "Darwin" ]; then
            xcodebuild -version 2>/dev/null || echo "  ‚ö†Ô∏è  xcodebuild not available"
          fi
          echo ""
          
          echo "‚úÖ Diagnostics complete (non-blocking)"
      
      - name: Repository Hygiene
        run: |
          set -euo pipefail
          echo "üîí Linux Preflight: Repository Hygiene"
          chmod +x scripts/ci/repo_hygiene.sh
          bash scripts/ci/repo_hygiene.sh
      
      - name: Validate Workflow Graph
        run: |
          set -euo pipefail
          echo "üîí Linux Preflight: Workflow Graph Validation"
          chmod +x scripts/ci/validate_workflow_graph.sh
          bash scripts/ci/validate_workflow_graph.sh .github/workflows/ssot-foundation-ci.yml
      
      - name: Validate SSOT Gate Test Selection
        run: |
          set -euo pipefail
          echo "üîí Linux Preflight: Test Selection Validation"
          chmod +x scripts/ci/validate_ssot_gate_test_selection.sh
          bash scripts/ci/validate_ssot_gate_test_selection.sh
      
      - name: SSOT Preflight
        run: |
          set -euo pipefail
          echo "üîí Linux Preflight: SSOT Preflight"
          chmod +x scripts/ci/preflight_ssot_foundation.sh
          bash scripts/ci/preflight_ssot_foundation.sh
      
      - name: Dependency Drift Guardrail (swift-crypto)
        run: |
          set -euo pipefail
          echo "üîç Checking swift-crypto dependency (required for CryptoShim on Linux)..."
          if ! swift package describe 2>/dev/null | grep -q "swift-crypto\|Crypto"; then
            echo "::error::swift-crypto dependency missing; CryptoShim requires it on Linux."
            echo "Restore Package.swift dependency for ConstantsTests target."
            echo "Package description output:"
            swift package describe 2>&1 | head -20 || echo "  (package describe failed)"
            exit 1
          fi
          echo "‚úÖ swift-crypto dependency found"
          echo ""
          echo "üîç Parsing swift-crypto version/revision from Package.resolved..."
          if [ -f "Package.resolved" ]; then
            SWIFT_CRYPTO_REVISION=$(python3 -c 'import json; f=open("Package.resolved"); d=json.load(f); f.close(); p=[p for p in d.get("pins",[]) if p.get("identity")=="swift-crypto"]; s=p[0].get("state",{}) if p else {}; print(f"{s.get(\"version\",\"unknown\")} ({s.get(\"revision\",\"unknown\")[:12]})") if s else print("swift-crypto not found")' 2>/dev/null || echo "unknown")
            echo "  swift-crypto version/revision: ${SWIFT_CRYPTO_REVISION:-unknown}"
            echo ""
            echo "‚ö†Ô∏è  Dependency drift guardrail:"
            echo "  If swift-crypto revision changes, commit message MUST include 'Dependency-Change: yes'"
            echo "  OR add a marker file: touch .dependency-change-marker"
            echo "  Current revision: ${SWIFT_CRYPTO_REVISION:-unknown}"
            echo ""
            # Check if dependency change is explicitly marked
            if git log -1 --pretty=%B | grep -q "Dependency-Change: yes" 2>/dev/null || \
               [ -f ".dependency-change-marker" ] 2>/dev/null; then
              echo "  ‚úÖ Dependency change explicitly marked (commit message or marker file)"
            else
              # Check if Package.resolved changed in this commit
              if git diff --cached --name-only | grep -q "Package.resolved" 2>/dev/null || \
                 git diff HEAD --name-only | grep -q "Package.resolved" 2>/dev/null; then
                echo "  ‚ö†Ô∏è  Package.resolved changed but no explicit marker found"
                echo "  This may be intentional (e.g., transitive dependency update)"
                echo "  If intentional, add 'Dependency-Change: yes' to commit message or create .dependency-change-marker"
              else
                echo "  ‚úÖ No Package.resolved changes detected in this commit"
              fi
            fi
          else
            echo "  ‚ö†Ô∏è  Package.resolved not found (may be using SPM without lock file)"
          fi
      
      - name: Export OPENSSL_ia32cap to GITHUB_ENV (Linux Preflight)
        run: |
          set -euo pipefail
          echo 'OPENSSL_ia32cap=:0' >> "$GITHUB_ENV"
          echo "‚úÖ Exported OPENSSL_ia32cap=:0 to GITHUB_ENV for all subsequent steps"
      
      - name: Crypto Shim Sanity Check (Linux) ‚Äî Canary
        env:
          # Step-level env (belt-and-suspenders)
          OPENSSL_ia32cap: ":0"
        run: |
          set -euo pipefail
          echo "üîç Linux Crypto Shim Sanity Check (Canary)"
          echo "This canary test catches SIGILL early before full Gate 2 suite runs"
          echo ""
          echo "Environment diagnostics:"
          echo "  uname -a: $(uname -a)"
          echo "  Swift: $(swift --version | head -1)"
          echo "  CPU: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs || echo 'unknown')"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo ""
          echo "Environment variables (crypto-related):"
          env | sort | grep -E "(OPENSSL_ia32cap|ia32cap|CRYPTO|SWIFT)" || echo "  (none found)"
          # Guardrail: Ensure OPENSSL_ia32cap is set
          if [ -z "${OPENSSL_ia32cap:-}" ] || [ "${OPENSSL_ia32cap}" != ":0" ]; then
            echo ""
            echo "::error::OPENSSL_ia32cap must be ':0' on Linux Preflight to prevent SIGILL"
            echo "Current value: '${OPENSSL_ia32cap:-not set}'"
            echo "This will cause SIGILL crashes. Fix: Ensure OPENSSL_ia32cap=:0 is set at job level, step level, GITHUB_ENV, and inline prefix"
            exit 1
          fi
          echo ""
          echo "‚úÖ OPENSSL_ia32cap guardrail passed"
          echo ""
          echo "Testing CryptoShimConsistencyTests (canary test to catch SIGILL early)..."
          echo "Exact invocation: OPENSSL_ia32cap=:0 swift test -c debug --filter CryptoShimConsistencyTests"
          echo ""
          # Inline prefix ensures env is applied even if step-level env fails
          OPENSSL_ia32cap=:0 swift test -c debug --filter CryptoShimConsistencyTests || {
            echo ""
            echo "::error::SIGILL during crypto canary. This indicates native crypto backend illegal instruction."
            echo "See DEVELOPER_FAILURE_TRIAGE.md ‚Üí Ubuntu SIGILL section."
            echo ""
            echo "Diagnostics:"
            echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
            echo "  Test command: OPENSSL_ia32cap=:0 swift test -c debug --filter CryptoShimConsistencyTests"
            exit 1
          }
          echo "‚úÖ Crypto shim canary check passed (no SIGILL detected)"
      
      - name: Linux Preflight Complete
        run: |
          set -euo pipefail
          echo ""
          echo "‚úÖ Linux Preflight PASSED: Repository hygiene and workflow validation complete"
  
  # Gate 1 ‚Äî Constitutional Gate (Fast, Blocking)
  # Runs on every PR, must finish fast
  # Any failure blocks merge immediately
  # No retries, no soft warnings
  # Purpose: Stop illegal changes before humans rationalize them
  gate_1_constitutional:
    name: Gate 1 ‚Äî Constitutional (Fast, Blocking)
    runs-on: macos-14  # Pin to macos-14 for stable Xcode availability
    needs: [gate_0_workflow_lint]
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    
    strategy:
      fail-fast: true  # Stop immediately on first failure
      matrix:
        build_config: [debug, release]
        xcode_version: ['15.4']  # Single stable version (15.0 not reliably available)
    
    steps:
      - name: Concurrency Diagnostics
        run: |
          set -euo pipefail
          echo "::notice::Concurrency diagnostics for Gate 1"
          echo "event_name: ${{ github.event_name }}"
          echo "actor: ${{ github.actor }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo "SSOT_CONCURRENCY_GROUP: ${{ env.SSOT_CONCURRENCY_GROUP }}"
          echo "concurrency.group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo ""
      
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # pinned from v4 (2026-01-24)
        with:
          fetch-depth: 0
      
      - name: Setup Swift (Pinned Toolchain)
        if: runner.os == 'Linux'
        uses: swift-actions/setup-swift@cdbe0f7f4c77929b6580e71983e8606e55ffe7e4 # pinned from v1 (2026-01-24)
        with:
          swift-version: "6.0"
          # Pin exact toolchain to prevent runner toolcache drift
      
      - name: Enumerate Available Xcodes
        run: |
          set -euo pipefail
          echo "üîç Available Xcode installations:"
          ls -1 /Applications | grep -E '^Xcode.*\.app$' || echo "  (none found)"
          echo ""
          echo "Current Xcode selection:"
          xcode-select -p || echo "  (none selected)"
          echo ""
      
      - name: Setup Xcode ${{ matrix.xcode_version }}
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # pinned from v1 (2026-01-24)
        with:
          xcode-version: ${{ matrix.xcode_version }}
      
      - name: Validate Xcode Selection
        run: |
          set -euo pipefail
          chmod +x scripts/ci/validate_macos_xcode_selection.sh
          bash scripts/ci/validate_macos_xcode_selection.sh ${{ matrix.xcode_version }} || {
            echo ""
            echo "‚ùå Xcode validation failed"
            echo "Requested version: ${{ matrix.xcode_version }}"
            echo "Available Xcodes:"
            ls -1 /Applications | grep -E '^Xcode.*\.app$' || echo "  (none found)"
            echo ""
            echo "Fix: Update workflow matrix to match available Xcode versions on runner image"
            exit 1
          }
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@7ca6abe6b3b0e8b5421b88be48feee39cbf52c6a # pinned from v2 (2026-01-24)
        with:
          swift-version: "6.0"
      
      - name: Toolchain Sanity Check
        run: |
          set -euo pipefail
          echo "üîç Toolchain Versions:"
          swift --version
          xcodebuild -version
          echo ""
      
      - name: Build (${{ matrix.build_config }})
        env:
          CONFIGURATION: ${{ matrix.build_config }}
        run: |
          set -euo pipefail
          swift build -c ${{ matrix.build_config }}
      
      - name: Run Gate 1 Tests (Constitutional)
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          XCODE_VERSION: ${{ matrix.xcode_version }}
        run: |
          set -euo pipefail
          echo "üîí Gate 1: Constitutional Gate (Fast, Blocking)"
          echo "Build Config: ${{ matrix.build_config }}"
          echo "Xcode Version: ${{ matrix.xcode_version }}"
          echo ""
          echo "Testing:"
          echo "  - Enum frozen order (B3)"
          echo "  - Catalog schema (B1, D2)"
          echo "  - Documentation sync (B1, B2)"
          echo "  - Encoding golden vectors (A2)"
          echo "  - Quantization golden vectors (A3, A4)"
          echo ""
          
          GATE1_OUTPUT_FILE="/tmp/gate1_test_output.log"
          swift test -c ${{ matrix.build_config }} \
            --filter EnumFrozenOrderTests \
            --filter CatalogSchemaTests \
            --filter DocumentationSyncTests \
            --filter DeterministicEncodingContractTests \
            --filter DeterministicQuantizationContractTests \
            --filter GoldenVectorsRoundTripTests 2>&1 | tee "$GATE1_OUTPUT_FILE" || {
            echo ""
            echo "‚ùå Gate 1 FAILED: Constitutional invariants violated"
            echo "Invariant IDs: B3, B1, D2, A2, A3, A4"
            echo "This blocks all merges. No retries allowed."
            echo "See docs/constitution/FAILURE_TRIAGE_MAP.md for repair guidance."
            exit 1
          }
          
          # Check for zero tests executed (must fail for required suites)
          GATE1_OUTPUT=$(cat "$GATE1_OUTPUT_FILE" 2>/dev/null || echo "")
          if echo "$GATE1_OUTPUT" | grep -qE "Executed 0 tests|0 tests executed|0 test\(s\)"; then
            echo ""
            echo "‚ùå Gate 1 FAILED: Zero tests executed"
            echo "This indicates filter mismatch, test name change, or execution failure"
            echo "Test output:"
            echo "$GATE1_OUTPUT" | tail -20
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Gate 1 PASSED: Constitutional invariants intact"
      
      - name: Cancellation Notice
        if: ${{ cancelled() }}
        run: |
          set -euo pipefail
          echo "::notice::JOB CANCELED (not a test failure)"
          echo ""
          echo "=== Cancellation Classification ==="
          echo "Status: CANCELLED (superseded by newer run)"
          echo "Classification: Concurrency cancellation (not a test failure)"
          echo ""
          echo "=== Context ==="
          echo "event_name: ${{ github.event_name }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo ""
          echo "=== Concurrency ==="
          echo "concurrency.group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo "SSOT_CONCURRENCY_GROUP: ${{ env.SSOT_CONCURRENCY_GROUP }}"
          echo ""
          echo "=== Note ==="
          echo "This job was cancelled because a newer run started with the same concurrency group."
          echo "This is expected behavior and does NOT indicate a test failure."
          echo "To see test results, check the newer run (run_id: check GitHub Actions UI)"
  
  # Gate 2 ‚Äî Determinism & Trust Gate (Deep, Blocking)
  # Runs only if Gate 1 passes
  # Enforces long-term reproducibility, auditability, and user trust
  gate_2_determinism_trust:
    name: Gate 2 ‚Äî Determinism & Trust (Deep, Blocking)
    runs-on: ${{ matrix.os }}
    needs: [gate_1_constitutional, gate_linux_preflight_only]
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
    # Linux-only: Disable crypto CPU feature detection to prevent SIGILL on CI CPUs
    # Prevents swift-crypto/OpenSSL/BoringSSL asm SIGILL on some hosted CI CPUs; forces software path; Linux-only.
    # Setting OPENSSL_ia32cap=:0 at job level ensures it's inherited by all steps and child processes
    # Setting SSOT_PURE_SWIFT_SHA256=1 forces pure Swift crypto backend (deterministic, no SIGILL risk)
    # Setting GLIBC_TUNABLES disables CPU feature detection at process level (baseline lock for blocking Linux Gate 2)
    # Closed-world: Linux entries explicitly set SSOT_PURE_SWIFT_SHA256="1", macOS entries omit it (absence is intentional)
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-14
            xcode_version: '15.4'
            build_config: debug
            # macOS: SSOT_PURE_SWIFT_SHA256 intentionally absent (uses native CryptoKit)
          - os: macos-14
            xcode_version: '15.4'
            build_config: release
            # macOS: SSOT_PURE_SWIFT_SHA256 intentionally absent (uses native CryptoKit)
          - os: ubuntu-22.04
            xcode_version: ''
            build_config: debug
            SSOT_PURE_SWIFT_SHA256: "1"
            OPENSSL_ia32cap: ":0"
            GLIBC_TUNABLES: "glibc.cpu.hwcaps=-x86-64-v3:-x86-64-v4"
          - os: ubuntu-22.04
            xcode_version: ''
            build_config: release
            SSOT_PURE_SWIFT_SHA256: "1"
            OPENSSL_ia32cap: ":0"
            GLIBC_TUNABLES: "glibc.cpu.hwcaps=-x86-64-v3:-x86-64-v4"
    
    env:
      # Job-level env propagates matrix env to all steps (closed-world: Linux entries have explicit values, macOS entries inherit empty/unset)
      OPENSSL_ia32cap: ${{ matrix.OPENSSL_ia32cap || '' }}
      SSOT_PURE_SWIFT_SHA256: ${{ matrix.SSOT_PURE_SWIFT_SHA256 || '' }}
      # GLIBC_TUNABLES: Process-wide CPU feature baseline lock (blocking Linux Gate 2 only)
      GLIBC_TUNABLES: ${{ matrix.GLIBC_TUNABLES || '' }}
    
    steps:
      - name: Concurrency Diagnostics
        run: |
          set -euo pipefail
          echo "::notice::Concurrency diagnostics for Gate 2"
          echo "event_name: ${{ github.event_name }}"
          echo "actor: ${{ github.actor }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo "SSOT_CONCURRENCY_GROUP: ${{ env.SSOT_CONCURRENCY_GROUP }}"
          echo "concurrency.group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo ""
      
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # pinned from v4 (2026-01-24)
        with:
          fetch-depth: 0
      
      - name: Setup Xcode (macOS only)
        if: matrix.os == 'macos-14'
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # pinned from v1 (2026-01-24)
        with:
          xcode-version: ${{ matrix.xcode_version }}
      
      - name: Validate Xcode Selection (macOS only)
        if: matrix.os == 'macos-14'
        run: |
          set -euo pipefail
          chmod +x scripts/ci/validate_macos_xcode_selection.sh
          bash scripts/ci/validate_macos_xcode_selection.sh ${{ matrix.xcode_version }} || {
            echo ""
            echo "‚ùå Xcode validation failed"
            echo "Requested version: ${{ matrix.xcode_version }}"
            echo "Available Xcodes:"
            ls -1 /Applications | grep -E '^Xcode.*\.app$' || echo "  (none found)"
            echo ""
            echo "Fix: Update workflow matrix to match available Xcode versions on runner image"
            exit 1
          }
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@7ca6abe6b3b0e8b5421b88be48feee39cbf52c6a # pinned from v2 (2026-01-24)
        with:
          swift-version: "6.0"
      
      - name: Toolchain Sanity Check
        run: |
          set -euo pipefail
          echo "üîç Toolchain Versions:"
          swift --version
          if [ "${{ matrix.os }}" == "macos-14" ]; then
            xcodebuild -version || echo "xcodebuild not available"
          fi
          echo ""
      
      - name: Install system deps (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev pkg-config
      
      - name: Export OPENSSL_ia32cap to GITHUB_ENV (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -euo pipefail
          echo 'OPENSSL_ia32cap=:0' >> "$GITHUB_ENV"
          echo "‚úÖ Exported OPENSSL_ia32cap=:0 to GITHUB_ENV for all subsequent steps"
      
      - name: Linux System Diagnostics (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -euo pipefail
          echo "üîç Linux System Diagnostics (for SIGILL troubleshooting)"
          echo "  uname -a: $(uname -a)"
          echo "  uname -m: $(uname -m)"
          echo "  CPU info:"
          lscpu | head -20 || true
          cat /proc/cpuinfo | head -40 || true
          echo ""
          echo "Crypto-related environment variables:"
          env | grep -E 'OPENSSL_ia32cap|CRYPTO|BORING|SWIFT_CRYPTO' || echo "  (none found)"
          echo ""
      
      - name: Verify OPENSSL_ia32cap Guardrail (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -euo pipefail
          echo "üîç Verifying OPENSSL_ia32cap is set to prevent SIGILL..."
          echo "Current OPENSSL_ia32cap value:"
          env | grep -E '^OPENSSL_ia32cap=' || echo "  (not found in env)"
          echo ""
          if [ -z "${OPENSSL_ia32cap:-}" ] || [ "${OPENSSL_ia32cap}" != ":0" ]; then
            echo "::error::OPENSSL_ia32cap must be ':0' on Ubuntu Gate 2 to prevent SIGILL"
            echo "Current value: '${OPENSSL_ia32cap:-not set}'"
            echo "Fix: Ensure OPENSSL_ia32cap=:0 is set at job level, step level, GITHUB_ENV, and inline prefix"
            exit 1
          fi
          echo "‚úÖ OPENSSL_ia32cap=${OPENSSL_ia32cap} (correct)"
      
      - name: Crypto Canary Test (Linux) ‚Äî Early SIGILL Detection
        if: matrix.os == 'ubuntu-22.04'
        env:
          # Step-level env (belt-and-suspenders)
          OPENSSL_ia32cap: ":0"
          SSOT_PURE_SWIFT_SHA256: "1"
        run: |
          set -euo pipefail
          echo "üîç Crypto Canary Test (catches SIGILL before full Gate 2 suite)"
          echo "Testing CryptoShimConsistencyTests with pure Swift backend (SSOT_PURE_SWIFT_SHA256=1)..."
          echo ""
          echo "Environment check:"
          echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo ""
          # Inline prefix ensures env is applied even if step-level env fails
          SSOT_PURE_SWIFT_SHA256=1 OPENSSL_ia32cap=:0 swift test -c debug --filter CryptoShimConsistencyTests 2>&1 | tee /tmp/canary_output.log || {
            CANARY_EXIT=$?
            CANARY_OUTPUT=$(cat /tmp/canary_output.log 2>/dev/null || echo "")
            echo ""
            echo "::error::Crypto canary test failed (exit code: $CANARY_EXIT)"
            echo ""
            # Check for SIGILL
            if echo "$CANARY_OUTPUT" | grep -qE "signal code 4|Illegal instruction|SIGILL"; then
              echo "=== SIGILL_ENVIRONMENTAL_FAILURE ==="
              echo "swift --version:"
              swift --version
              echo ""
              echo "uname -a:"
              uname -a
              echo ""
              echo "CPU flags:"
              grep -m1 '^flags' /proc/cpuinfo || echo "  (cpuinfo not available)"
              echo ""
              echo "SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
              echo "OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
              echo ""
              echo "This SIGILL occurred despite pure Swift backend. Check backend selection log."
            fi
            echo ""
            echo "See DEVELOPER_FAILURE_TRIAGE.md ‚Üí Ubuntu SIGILL section."
            exit 1
          }
          # Backend policy is enforced by CryptoBackendPolicyTests (runs first in Gate 2)
          # This canary test verifies no SIGILL occurs; backend correctness is validated by policy test
          # Legacy grep-based backend detection removed - replaced by executable policy test
          echo "‚úÖ Crypto canary passed (pure Swift backend verified, no SIGILL detected)"
      
      - name: Build (${{ matrix.build_config }})
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          swift build -c ${{ matrix.build_config }}
      
      - name: Final OPENSSL_ia32cap Verification Before Tests (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -euo pipefail
          echo "üîç Final OPENSSL_ia32cap verification before running tests..."
          echo "Environment check:"
          env | grep -E '^OPENSSL_ia32cap=' || echo "  ‚ùå OPENSSL_ia32cap not found in env"
          echo ""
          if [ -z "${OPENSSL_ia32cap:-}" ] || [ "${OPENSSL_ia32cap}" != ":0" ]; then
            echo "::error::OPENSSL_ia32cap must be ':0' before running tests"
            echo "Current value: '${OPENSSL_ia32cap:-not set}'"
            echo "This will cause SIGILL. All layers must be set: job env + step env + GITHUB_ENV + inline prefix"
            exit 1
          fi
          echo "‚úÖ OPENSSL_ia32cap=${OPENSSL_ia32cap} verified (all layers applied)"
          echo ""
      
      - name: Linux System Diagnostics Before Tests (Linux)
        if: matrix.os == 'ubuntu-22.04'
        run: |
          set -euo pipefail
          echo "üîç Linux System Diagnostics (for SIGILL root cause identification)"
          echo "System information:"
          echo "  uname -a: $(uname -a)"
          echo "  uname -m: $(uname -m)"
          echo "  CPU info:"
          lscpu | head -20 || true
          echo ""
          echo "Environment variables (crypto-related):"
          env | grep -E '^OPENSSL_ia32cap=' || echo "  (OPENSSL_ia32cap not found)"
          env | grep -E 'SSOT_PURE_SWIFT_SHA256' || echo "  (SSOT_PURE_SWIFT_SHA256 not set, using native crypto)"
          echo ""
          echo "Locating built xctest binary and checking dependencies..."
          # Find the xctest binary path (typically in .build/debug or .build/release)
          XCTEST_PATH=$(find .build -name "xctest" -type f 2>/dev/null | head -1 || echo "")
          if [ -n "$XCTEST_PATH" ]; then
            echo "  Found xctest at: $XCTEST_PATH"
            echo "  Dependencies (crypto-related):"
            ldd "$XCTEST_PATH" 2>/dev/null | grep -E 'ssl|crypto|boring|swift|foundation' || echo "    (no crypto-related dependencies found or ldd failed)"
          else
            echo "  ‚ö†Ô∏è  xctest binary not found (may not be built yet or path differs)"
          fi
          echo ""
          echo "Note: These diagnostics are for troubleshooting only; they do not affect test execution."
          echo ""
      
      - name: Run Gate 2 Tests (Determinism & Trust)
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
          # Step-level env inherits from job-level (which inherits from matrix entries)
          # Closed-world: Linux matrix entries explicitly set values, macOS entries inherit empty/unset
          OPENSSL_ia32cap: ${{ env.OPENSSL_ia32cap }}
          SSOT_PURE_SWIFT_SHA256: ${{ env.SSOT_PURE_SWIFT_SHA256 }}
        run: |
          set -euo pipefail
          echo "üîí Gate 2: Determinism & Trust Gate (Deep, Blocking)"
          echo "OS: ${{ matrix.os }}, Config: ${{ matrix.build_config }}"
          if [ "${{ matrix.os }}" == "ubuntu-22.04" ]; then
            echo ""
            echo "Linux diagnostics:"
            echo "  uname -a: $(uname -a)"
            echo "  Swift: $(swift --version | head -1)"
            echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
            echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
            echo "  GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set}"
            echo ""
            echo "Environment variables (crypto-related):"
            env | sort | grep -E "(OPENSSL_ia32cap|SSOT_PURE_SWIFT_SHA256|GLIBC_TUNABLES|ia32cap|CRYPTO|SWIFT)" || echo "  (none found)"
            # Guardrail: Ensure GLIBC_TUNABLES is set for blocking Linux Gate 2
            if [ -z "${GLIBC_TUNABLES:-}" ] || [ "${GLIBC_TUNABLES}" != "glibc.cpu.hwcaps=-x86-64-v3:-x86-64-v4" ]; then
              echo ""
              echo "::error::GLIBC_TUNABLES must be 'glibc.cpu.hwcaps=-x86-64-v3:-x86-64-v4' on blocking Ubuntu Gate 2"
              echo "Current value: '${GLIBC_TUNABLES:-not set}'"
              echo "This ensures process-wide CPU feature baseline lock to prevent SIGILL"
              exit 1
            fi
            echo ""
            echo "‚úÖ GLIBC_TUNABLES guardrail passed (process-wide CPU feature baseline lock enabled)"
            # Final guardrail: Ensure OPENSSL_ia32cap is set for ubuntu to prevent SIGILL
            if [ -z "${OPENSSL_ia32cap:-}" ] || [ "${OPENSSL_ia32cap}" != ":0" ]; then
              echo ""
              echo "::error::OPENSSL_ia32cap must be ':0' on Ubuntu Gate 2 to prevent SIGILL"
              echo "Current value: '${OPENSSL_ia32cap:-not set}'"
              echo "This will cause SIGILL crashes. Fix: Ensure OPENSSL_ia32cap=:0 is set at job level, step level, GITHUB_ENV, and inline prefix"
              exit 1
            fi
            # Guardrail: Ensure SSOT_PURE_SWIFT_SHA256 is set for ubuntu to force pure Swift backend (closed-world assertion)
            if [[ "${SSOT_PURE_SWIFT_SHA256:-}" != "1" ]]; then
              echo ""
              echo "::error::SSOT_PURE_SWIFT_SHA256 must be '1' on Ubuntu Gate 2 to force pure Swift backend"
              echo "Current value: '${SSOT_PURE_SWIFT_SHA256:-not set}'"
              echo "This ensures deterministic crypto backend selection and eliminates SIGILL risk"
              echo "Policy: Linux Gate 2 matrix entries must explicitly set SSOT_PURE_SWIFT_SHA256='1'"
              exit 1
            fi
            echo ""
            echo "‚úÖ OPENSSL_ia32cap guardrail passed"
            echo "‚úÖ SSOT_PURE_SWIFT_SHA256 guardrail passed (pure Swift backend enabled)"
          fi
          echo ""
          echo "Testing:"
          echo "  - Cross-platform consistency (A2, A3, A4, A5, CE, CL2)"
          echo "  - Color matrix integrity (CE)"
          echo "  - Domain prefixes (G1)"
          echo "  - Reproducibility boundary (E2)"
          echo "  - Breaking surface (C1)"
          echo "  - Explanation catalog coverage (B1, B2, D2)"
          echo "  - Reason compatibility (U1, U16)"
          echo "  - Minimum explanation set (D2)"
          echo ""
          if [ "${{ matrix.os }}" == "ubuntu-22.04" ]; then
            echo "Exact swift test invocation (with inline env prefixes):"
            echo "  SSOT_PURE_SWIFT_SHA256=1 OPENSSL_ia32cap=:0 swift test -c ${{ matrix.build_config }} --filter [Gate 2 test suites]"
            echo ""
          fi
          
          # Build filter arguments as array (keeps literal --filter tokens visible to grep-based validators)
          FILTERS=(
            --filter CryptoBackendPolicyTests
            --filter ColorMatrixIntegrityTests
            --filter DomainPrefixesTests
            --filter ReproducibilityBoundaryTests
            --filter BreakingSurfaceTests
            --filter ExplanationCatalogCoverageTests
            --filter ReasonCompatibilityTests
            --filter MinimumExplanationSetTests
            --filter CatalogUniquenessTests
            --filter ExplanationIntegrityTests
            --filter CatalogCrossReferenceTests
            --filter CatalogActionabilityRulesTests
            --filter DomainPrefixesClosureTests
            --filter CryptoShimConsistencyTests
          )
          
          # Inline prefix ensures OPENSSL_ia32cap and SSOT_PURE_SWIFT_SHA256 are applied even if env propagation fails
          # Closed-world: Linux matrix entries have explicit values, macOS entries have empty/unset (intentional)
          TEST_FAILED=0
          TEST_OUTPUT_FILE="/tmp/gate2_test_output.log"
          if [ "${{ matrix.os }}" == "ubuntu-22.04" ]; then
            # Linux: use pure Swift backend (SSOT_PURE_SWIFT_SHA256=1) + OPENSSL_ia32cap=:0
            # Inline prefix uses explicit values from matrix (closed-world assertion)
            if ! SSOT_PURE_SWIFT_SHA256="${SSOT_PURE_SWIFT_SHA256:-1}" OPENSSL_ia32cap="${OPENSSL_ia32cap:-:0}" swift test -c "${{ matrix.build_config }}" "${FILTERS[@]}" 2>&1 | tee "$TEST_OUTPUT_FILE"; then
              TEST_FAILED=1
            fi
          else
            # macOS: use native backend (SSOT_PURE_SWIFT_SHA256 intentionally absent)
            if ! swift test -c "${{ matrix.build_config }}" "${FILTERS[@]}" 2>&1 | tee "$TEST_OUTPUT_FILE"; then
              TEST_FAILED=1
            fi
          fi
          
          # Check for zero tests executed (must fail for required suites)
          TEST_OUTPUT=$(cat "$TEST_OUTPUT_FILE" 2>/dev/null || echo "")
          if echo "$TEST_OUTPUT" | grep -qE "Executed 0 tests|0 tests executed|0 test\(s\)"; then
            echo ""
            echo "‚ùå Gate 2 FAILED: Zero tests executed"
            echo "This indicates filter mismatch, test name change, or execution failure"
            echo "Test output:"
            echo "$TEST_OUTPUT" | tail -20
            exit 1
          fi
          
          if [ $TEST_FAILED -eq 1 ]; then
            echo ""
            # Classify SIGILL explicitly (exclusive classification, non-confusing)
            # Check output patterns (exit code from pipe not reliable, use pattern matching)
            IS_SIGILL=0
            if echo "$TEST_OUTPUT" | grep -qE "signal code 4|Illegal instruction|SIGILL|Exited with unexpected signal code 4"; then
              IS_SIGILL=1
            fi
            
            if [ $IS_SIGILL -eq 1 ]; then
              echo "SSOT_GATE2_FAILURE_CLASS=SIGILL_ENVIRONMENTAL"
              echo ""
              echo "=== SIGILL Environmental Failure (Exclusive Classification) ==="
              echo ""
              echo ""
              echo "swift --version:"
              swift --version || echo "  (swift not available)"
              echo ""
              echo "uname -a:"
              uname -a || echo "  (uname not available)"
              echo ""
              if [ "${{ matrix.os }}" == "ubuntu-22.04" ]; then
                echo "CPU flags:"
                grep -m1 '^flags' /proc/cpuinfo || echo "  (cpuinfo not available)"
                echo ""
                echo "GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set}"
              fi
              echo "SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
              echo "OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
              # Backend policy is enforced by CryptoBackendPolicyTests (runs first in Gate 2)
              # Get backend name from executable test, not grep
              echo "Backend policy: Enforced by CryptoBackendPolicyTests (see test output above)"
              echo ""
              echo "Last 50 lines of test output:"
              echo "$TEST_OUTPUT" | tail -50
              echo ""
              echo "‚ö†Ô∏è  Note: Invariants NOT evaluated due to crash"
              echo "‚ö†Ô∏è  This is an environmental failure, NOT an invariant drift."
              echo "‚ö†Ô∏è  SIGILL failures are exclusively environmental and do not indicate test logic failures."
              echo "See DEVELOPER_FAILURE_TRIAGE.md ‚Üí Ubuntu SIGILL section for repair guidance."
              exit 1
            fi
            # Non-SIGILL failures: standard Gate 2 failure message
            echo ""
            echo "‚ùå Gate 2 FAILED: Determinism, reproducibility, or user trust violated"
            echo "Invariant IDs: A2, A3, A4, A5, CE, CL2, E2, C1, B1, B2, D2, G1, U1, U16"
            echo "This indicates cross-platform drift, breaking change violation, or explanation integrity issue."
            echo "See docs/constitution/FAILURE_TRIAGE_MAP.md for repair guidance."
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Gate 2 PASSED: Determinism, reproducibility, and user trust intact"
      
      - name: Cancellation Notice
        if: ${{ cancelled() }}
        run: |
          set -euo pipefail
          echo "::notice::JOB CANCELED (not a test failure)"
          echo ""
          echo "=== Cancellation Classification ==="
          echo "Status: CANCELLED (superseded by newer run)"
          echo "Classification: Concurrency cancellation (not a test failure)"
          echo ""
          echo "=== Context ==="
          echo "event_name: ${{ github.event_name }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo ""
          echo "=== Concurrency ==="
          echo "concurrency.group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo "SSOT_CONCURRENCY_GROUP: ${{ env.SSOT_CONCURRENCY_GROUP }}"
          echo ""
          echo "=== Note ==="
          echo "This job was cancelled because a newer run started with the same concurrency group."
          echo "This is expected behavior and does NOT indicate a test failure."
          echo "To see test results, check the newer run (run_id: check GitHub Actions UI)"
  
  # Golden Vector Change Detection
  # Fails if golden vectors are modified without proper documentation
  golden_vector_governance:
    name: Golden Vector Governance Check
    runs-on: ubuntu-22.04  # Pinned to prevent runner drift (replaces legacy ubuntu-latest)
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # pinned from v4 (2026-01-24)
        with:
          fetch-depth: 0
      
      - name: Check Golden Vector Changes
        run: |
          set -euo pipefail
          echo "üîí Golden Vector Governance Check"
          echo "Any change to golden vectors must be accompanied by breaking change documentation"
          echo ""
          
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          GOLDEN_FILES=(
            "docs/constitution/constants/GOLDEN_VECTORS_ENCODING.json"
            "docs/constitution/constants/GOLDEN_VECTORS_QUANTIZATION.json"
            "docs/constitution/constants/GOLDEN_VECTORS_COLOR.json"
          )
          
          GOLDEN_CHANGED=false
          for file in "${GOLDEN_FILES[@]}"; do
            if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "^$file$"; then
              echo "‚ö†Ô∏è  Golden vector changed: $file"
              GOLDEN_CHANGED=true
            fi
          done
          
          if [ "$GOLDEN_CHANGED" = true ]; then
            echo ""
            echo "Golden vectors are constitutional artifacts. Changes require:"
            echo "  1. Update to BREAKING_CHANGE_SURFACE.json OR"
            echo "  2. Update to MIGRATION_GUIDE.md OR"
            echo "  3. contractVersion bump"
            echo ""
            
            # Check if breaking change documentation exists
            BREAKING_CHANGED=false
            MIGRATION_CHANGED=false
            CONTRACT_VERSION_CHANGED=false
            
            if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "BREAKING_CHANGE_SURFACE.json"; then
              BREAKING_CHANGED=true
            fi
            
            if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "MIGRATION_GUIDE.md"; then
              MIGRATION_CHANGED=true
            fi
            
            if git diff "$BASE_SHA" "$HEAD_SHA" -- Core/Constants/FoundationVersioning.swift | grep -q "CONTRACT_VERSION"; then
              CONTRACT_VERSION_CHANGED=true
            fi
            
            if [ "$BREAKING_CHANGED" = false ] && [ "$MIGRATION_CHANGED" = false ] && [ "$CONTRACT_VERSION_CHANGED" = false ]; then
              echo "‚ùå FAIL: Golden vectors changed without breaking change documentation"
              echo "   Please update BREAKING_CHANGE_SURFACE.json, MIGRATION_GUIDE.md, or bump contractVersion"
              exit 1
            else
              echo "‚úÖ Golden vector change properly documented"
            fi
          else
            echo "‚úÖ No golden vector changes detected"
          fi
  
  # Experimental: Linux Gate 2 with native crypto backend (non-blocking, telemetry only)
  # Purpose: Monitor native crypto stability without blocking main Gate 2
  # Runs only on workflow_dispatch or nightly schedule
  # Isolated: read-only permissions, continue-on-error, no repo modifications
  gate_2_linux_native_crypto_experiment:
    name: Gate 2 ‚Äî Linux Native Crypto Experiment (Non-Blocking Telemetry Only)
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    needs: []
    timeout-minutes: 15
    # Least-privilege permissions: read-only, no repo modifications
    permissions:
      contents: read
      pull-requests: read
    # Explicitly non-blocking: failures do not affect merge gates
    continue-on-error: true
    # Experimental: Do NOT set SSOT_PURE_SWIFT_SHA256 (uses native crypto backend)
    # This is for telemetry only - main Gate 2 remains stable with pure Swift backend
    env:
      OPENSSL_ia32cap: ":0"
      # SSOT_PURE_SWIFT_SHA256 intentionally NOT set (experimental native crypto)
    
    strategy:
      fail-fast: false
      matrix:
        build_config: [debug, release]
    
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # pinned from v4 (2026-01-24)
        with:
          fetch-depth: 0
      
      - name: Experimental Native Crypto Notice (Non-Blocking Telemetry)
        run: |
          set -euo pipefail
          echo "üî¨ EXPERIMENTAL: Linux Gate 2 with Native Crypto Backend (Non-Blocking Telemetry Only)"
          echo ""
          echo "‚ö†Ô∏è  This is a NON-BLOCKING telemetry job. Failures do NOT block merges."
          echo "‚ö†Ô∏è  This job has read-only permissions and does NOT modify repository files."
          echo ""
          echo "Purpose: Monitor GitHub-hosted runner drift and native crypto backend stability."
          echo "Main Gate 2 uses pure Swift backend (SSOT_PURE_SWIFT_SHA256=1) + GLIBC_TUNABLES + pinned toolchain for stability."
          echo ""
          echo "Environment:"
          echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set (experimental native crypto)}"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo "  GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set (uses GitHub-hosted default for telemetry)}"
          echo ""
      
      - name: Setup Swift
        uses: swift-actions/setup-swift@cdbe0f7f4c77929b6580e71983e8606e55ffe7e4 # pinned from v1 (2026-01-24)
        with:
          swift-version: "6.0"
      
      - name: Build (${{ matrix.build_config }})
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          echo "Building in ${{ matrix.build_config }} configuration..."
          swift build -c "${{ matrix.build_config }}" || {
            echo "‚ùå Build failed"
            exit 1
          }
      
      - name: Run Gate 2 Tests (Experimental Native Crypto)
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
          # Experimental: Do NOT set SSOT_PURE_SWIFT_SHA256 (native crypto backend)
          OPENSSL_ia32cap: ":0"
        run: |
          set -euo pipefail
          echo "üî¨ EXPERIMENTAL: Running Gate 2 tests with native crypto backend"
          echo "OS: ubuntu-22.04, Config: ${{ matrix.build_config }}"
          echo ""
          echo "Environment:"
          echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set (experimental)}"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo ""
          
          # Build filter arguments (same as main Gate 2)
          FILTERS=(
            --filter CryptoBackendPolicyTests
            --filter ColorMatrixIntegrityTests
            --filter DomainPrefixesTests
            --filter ReproducibilityBoundaryTests
            --filter BreakingSurfaceTests
            --filter ExplanationCatalogCoverageTests
            --filter ReasonCompatibilityTests
            --filter MinimumExplanationSetTests
            --filter CatalogUniquenessTests
            --filter ExplanationIntegrityTests
            --filter CatalogCrossReferenceTests
            --filter CatalogActionabilityRulesTests
            --filter DomainPrefixesClosureTests
            --filter CryptoShimConsistencyTests
          )
          
          # Run tests with native crypto (no SSOT_PURE_SWIFT_SHA256)
          TEST_OUTPUT_FILE="/tmp/gate2_experiment_output.log"
          TEST_FAILED_EXP=0
          if ! OPENSSL_ia32cap=:0 swift test -c "${{ matrix.build_config }}" "${FILTERS[@]}" 2>&1 | tee "$TEST_OUTPUT_FILE"; then
            TEST_FAILED_EXP=1
          fi
          
          if [ $TEST_FAILED_EXP -eq 1 ]; then
            TEST_OUTPUT=$(cat "$TEST_OUTPUT_FILE" 2>/dev/null || echo "")
            # Classify SIGILL explicitly: check output patterns (exit code from pipe not reliable)
            IS_SIGILL=0
            if echo "$TEST_OUTPUT" | grep -qE "signal code 4|Illegal instruction|SIGILL|Exited with unexpected signal code 4"; then
              IS_SIGILL=1
            fi
            
            if [ $IS_SIGILL -eq 1 ]; then
              echo ""
              echo "SSOT_GATE2_FAILURE_CLASS=SIGILL_ENVIRONMENTAL"
              echo ""
              echo "=== SIGILL Detected in Experimental Native Crypto Lane (Exclusive Classification) ==="
              echo ""
              echo "swift --version:"
              swift --version || echo "  (swift not available)"
              echo ""
              echo "uname -a:"
              uname -a || echo "  (uname not available)"
              echo ""
              echo "CPU flags:"
              grep -m1 '^flags' /proc/cpuinfo || echo "  (cpuinfo not available)"
              echo ""
              echo "SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set (experimental)}"
              echo "OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
              echo "GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set (experimental uses GitHub-hosted default)}"
              # Backend policy is enforced by CryptoBackendPolicyTests (runs first in experimental lane)
              echo "Backend policy: Enforced by CryptoBackendPolicyTests (see test output above)"
              echo ""
              echo "Last 50 lines of test output:"
              echo "$TEST_OUTPUT" | tail -50
              echo ""
              echo "‚ö†Ô∏è  Note: Invariants NOT evaluated due to crash"
              echo "‚ö†Ô∏è  This is an environmental failure, NOT an invariant drift."
              echo "‚ö†Ô∏è  SIGILL failures are exclusively environmental and do not indicate test logic failures."
              echo "‚ö†Ô∏è  This is experimental telemetry. Main Gate 2 uses pure Swift backend for stability."
            fi
            echo ""
            echo "‚ö†Ô∏è  EXPERIMENTAL TELEMETRY FAILURE (Non-Blocking)"
            echo "This is experimental telemetry. Main Gate 2 uses pure Swift backend for stability."
            echo ""
            echo "If this failure is SIGILL, it confirms native crypto backend instability on GitHub-hosted runners."
            echo "Main Gate 2 (with pure Swift backend) remains stable and blocking."
            echo ""
            echo "‚úÖ This failure does NOT block merges. Main Gate 2 (pure Swift backend) is unaffected."
            echo "‚úÖ This job has continue-on-error: true and read-only permissions."
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Experimental native crypto test passed (telemetry only, non-blocking)"
