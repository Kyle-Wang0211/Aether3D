name: SSOT Foundation CI (Guardian Layer)

# Prevent concurrent runs on same ref, but isolate per workflow to prevent cross-workflow cancellation
# For PRs: use PR number for better isolation; for push: use ref
# Concurrency group uses ONLY github.* contexts (compile-time evaluation)
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# Runtime env for diagnostics only (mirrors concurrency group value)
env:
  SSOT_CONCURRENCY_GROUP: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}

on:
  pull_request:
    paths:
      - 'docs/constitution/**'
      - 'Core/Constants/**'
      - 'Tests/Constants/**'
      - '.github/workflows/ssot-foundation-ci.yml'
  push:
    branches: [main]
    paths:
      - 'docs/constitution/**'
      - 'Core/Constants/**'
      - 'Tests/Constants/**'
      - '.github/workflows/ssot-foundation-ci.yml'
  workflow_dispatch:
    # Manual trigger for experimental lanes
  schedule:
    # Run experimental native crypto lane nightly at 2 AM UTC
    - cron: '0 2 * * *'

# CI Philosophy: CI is the constitutional court of SSOT.
# CI must block silent drift, accidental identity changes, explanation inconsistencies, and "green by editing goldens".
# CI is allowed to be strict. CI is not allowed to be vague.

jobs:
  # Gate 0 ‚Äî Workflow Lint (Fastest, Blocks Everything)
  # Validates workflow job graph before any other jobs run
  # Prevents "unknown job" errors from silently recurring
  gate_0_workflow_lint:
    name: Gate 0 ‚Äî Workflow Lint
    runs-on: ubuntu-22.04  # Pinned to prevent runner drift
    timeout-minutes: 2
    permissions:
      contents: read
    steps:
      - name: Checkout
        # pinned from v4 (2026-01-24)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Event Context Parity Check
        run: |
          set -euo pipefail
          IOS_BUILD_LOG="${RUNNER_TEMP:-/tmp}/ios_build.log"
          echo "üîí Gate 0: Event Context Parity Check"
          echo "Validating GitHub Actions context consistency"
          echo ""
          
          EVENT_NAME="${{ github.event_name }}"
          REF="${{ github.ref }}"
          SHA="${{ github.sha }}"
          WORKFLOW="${{ github.workflow }}"
          ACTOR="${{ github.actor }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "Context snapshot:"
          echo "  event_name: ${EVENT_NAME}"
          echo "  ref: ${REF}"
          echo "  sha: ${SHA}"
          echo "  workflow: ${WORKFLOW}"
          echo "  actor: ${ACTOR}"
          echo "  pr_number: ${PR_NUMBER:-N/A}"
          echo ""
          
          # Validate event context consistency
          ERRORS=0
          
          if [ "$EVENT_NAME" = "pull_request" ]; then
            if [ -z "${PR_NUMBER}" ] || [ "${PR_NUMBER}" = "null" ]; then
              echo "‚ùå pull_request event but PR number is missing or null"
              ERRORS=$((ERRORS + 1))
            fi
            if [ -z "${REF}" ] || [ "${REF}" = "refs/heads/main" ]; then
              echo "‚ö†Ô∏è  pull_request event: ref should be PR ref, not main branch"
            fi
          elif [ "$EVENT_NAME" = "push" ]; then
            if [ -n "${PR_NUMBER}" ] && [ "${PR_NUMBER}" != "null" ]; then
              echo "‚ùå push event but PR number is set (${PR_NUMBER}) - context mismatch"
              ERRORS=$((ERRORS + 1))
            fi
            if [ -z "${REF}" ]; then
              echo "‚ùå push event but ref is empty"
              ERRORS=$((ERRORS + 1))
            fi
          else
            echo "‚ö†Ô∏è  Unexpected event type: ${EVENT_NAME}"
          fi
          
          # Validate required fields
          if [ -z "${SHA}" ]; then
            echo "‚ùå SHA is empty"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ -z "${WORKFLOW}" ]; then
            echo "‚ùå Workflow name is empty"
            ERRORS=$((ERRORS + 1))
          fi
          
          # Validate concurrency group computation
          CONCURRENCY_GROUP="${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          if [ -z "${CONCURRENCY_GROUP}" ] || [ "${CONCURRENCY_GROUP}" = "-" ]; then
            echo "‚ùå Concurrency group evaluates to empty or invalid: '${CONCURRENCY_GROUP}'"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "‚ùå Gate 0 FAILED: Event context validation failed ($ERRORS error(s))"
            echo "This indicates a GitHub Actions context mismatch that will cause merge-time failures"
            exit 1
          fi
          
          echo "‚úÖ Event context validation passed"
          echo ""
      
      - name: Validate Workflow Graph
        run: |
          set -euo pipefail
          echo "üîí Gate 0: Workflow Graph Validation"
          echo "Validating job graph to prevent 'unknown job' errors"
          echo ""
          
          chmod +x scripts/ci/validate_workflow_graph.sh
          bash scripts/ci/validate_workflow_graph.sh .github/workflows/ssot-foundation-ci.yml || {
            echo ""
            echo "‚ùå Gate 0 FAILED: Workflow job graph is invalid"
            echo "Fix job ID mismatches in 'needs:' references before proceeding"
            exit 1
          }
          
          echo ""
          echo "‚úÖ Gate 0 PASSED: Workflow job graph is valid"
  
  # Gate Linux Preflight (Ubuntu, Fast, Non-Blocking)
  # Catches 80% of Linux failures early without requiring Swift build
  # Runs in parallel with Gate 1 to minimize CI time
  gate_linux_preflight_only:
    name: Gate Linux Preflight (Ubuntu, Fast)
    runs-on: ubuntu-22.04
    needs: [gate_0_workflow_lint]
    timeout-minutes: 5
    permissions:
      contents: read
    # Linux-only: Disable crypto CPU feature detection to prevent SIGILL on CI CPUs
    # Prevents swift-crypto/OpenSSL/BoringSSL asm SIGILL on some hosted CI CPUs; forces software path
    env:
      OPENSSL_ia32cap: ":0"
    steps:
      - name: Checkout
        # pinned from v4 (2026-01-24)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Runner & Toolchain Snapshot (Diagnostics)
        run: |
          set -euo pipefail
          echo "üîç Runner & Toolchain Snapshot (Diagnostics Only)"
          echo "This step provides environment diagnostics for drift analysis"
          echo ""
          
          echo "=== OS Information ==="
          uname -a
          if [ "$(uname)" = "Darwin" ]; then
            sw_vers || echo "  (sw_vers not available)"
          elif [ -f /etc/os-release ]; then
            cat /etc/os-release | grep -E "^(NAME|VERSION|ID)=" || echo "  (os-release parsing failed)"
          fi
          echo ""
          
          echo "=== Architecture ==="
          uname -m
          if command -v lscpu >/dev/null 2>&1; then
            echo ""
            lscpu | grep -E "^(Architecture|Model name|CPU\(s\)):" || echo "  (lscpu parsing failed)"
          fi
          echo ""
          
          echo "=== Toolchain Versions ==="
          swift --version || echo "  ‚ùå swift not available"
          if [ "$(uname)" = "Darwin" ]; then
            xcodebuild -version 2>/dev/null || echo "  ‚ö†Ô∏è  xcodebuild not available"
          fi
          echo ""
          
          echo "‚úÖ Diagnostics complete (non-blocking)"
      
      - name: Repository Hygiene
        run: |
          set -euo pipefail
          echo "üîí Linux Preflight: Repository Hygiene"
          chmod +x scripts/ci/repo_hygiene.sh
          bash scripts/ci/repo_hygiene.sh
      
      - name: Validate Workflow Graph
        run: |
          set -euo pipefail
          echo "üîí Linux Preflight: Workflow Graph Validation"
          chmod +x scripts/ci/validate_workflow_graph.sh
          bash scripts/ci/validate_workflow_graph.sh .github/workflows/ssot-foundation-ci.yml
      
      - name: Validate SSOT Gate Test Selection
        run: |
          set -euo pipefail
          echo "üîí Linux Preflight: Test Selection Validation"
          chmod +x scripts/ci/validate_ssot_gate_test_selection.sh
          bash scripts/ci/validate_ssot_gate_test_selection.sh
      
      - name: SSOT Preflight
        run: |
          set -euo pipefail
          echo "üîí Linux Preflight: SSOT Preflight"
          chmod +x scripts/ci/preflight_ssot_foundation.sh
          bash scripts/ci/preflight_ssot_foundation.sh
      
      - name: Dependency Drift Guardrail (swift-crypto)
        run: |
          set -euo pipefail
          echo "üîç Checking swift-crypto dependency (required for CryptoShim on Linux)..."
          if ! swift package describe 2>/dev/null | grep -q "swift-crypto\|Crypto"; then
            echo "::error::swift-crypto dependency missing; CryptoShim requires it on Linux."
            echo "Restore Package.swift dependency for ConstantsTests target."
            echo "Package description output:"
            swift package describe 2>&1 | head -20 || echo "  (package describe failed)"
            exit 1
          fi
          echo "‚úÖ swift-crypto dependency found"
          echo ""
          echo "üîç Parsing swift-crypto version/revision from Package.resolved..."
          if [ -f "Package.resolved" ]; then
            SWIFT_CRYPTO_REVISION=$(python3 -c 'import json; f=open("Package.resolved"); d=json.load(f); f.close(); p=[p for p in d.get("pins",[]) if p.get("identity")=="swift-crypto"]; s=p[0].get("state",{}) if p else {}; print(f"{s.get(\"version\",\"unknown\")} ({s.get(\"revision\",\"unknown\")[:12]})") if s else print("swift-crypto not found")' 2>/dev/null || echo "unknown")
            echo "  swift-crypto version/revision: ${SWIFT_CRYPTO_REVISION:-unknown}"
            echo ""
            echo "‚ö†Ô∏è  Dependency drift guardrail:"
            echo "  If swift-crypto revision changes, commit message MUST include 'Dependency-Change: yes'"
            echo "  OR add a marker file: touch .dependency-change-marker"
            echo "  Current revision: ${SWIFT_CRYPTO_REVISION:-unknown}"
            echo ""
            # Check if dependency change is explicitly marked
            if git log -1 --pretty=%B | grep -q "Dependency-Change: yes" 2>/dev/null || \
               [ -f ".dependency-change-marker" ] 2>/dev/null; then
              echo "  ‚úÖ Dependency change explicitly marked (commit message or marker file)"
            else
              # Check if Package.resolved changed in this commit
              if git diff --cached --name-only | grep -q "Package.resolved" 2>/dev/null || \
                 git diff HEAD --name-only | grep -q "Package.resolved" 2>/dev/null; then
                echo "  ‚ö†Ô∏è  Package.resolved changed but no explicit marker found"
                echo "  This may be intentional (e.g., transitive dependency update)"
                echo "  If intentional, add 'Dependency-Change: yes' to commit message or create .dependency-change-marker"
              else
                echo "  ‚úÖ No Package.resolved changes detected in this commit"
              fi
            fi
          else
            echo "  ‚ö†Ô∏è  Package.resolved not found (may be using SPM without lock file)"
          fi
      
      - name: Export OPENSSL_ia32cap to GITHUB_ENV (Linux Preflight)
        run: |
          set -euo pipefail
          echo 'OPENSSL_ia32cap=:0' >> "$GITHUB_ENV"
          echo "‚úÖ Exported OPENSSL_ia32cap=:0 to GITHUB_ENV for all subsequent steps"
      
      - name: Crypto Shim Sanity Check (Linux) ‚Äî Canary
        env:
          # Step-level env (belt-and-suspenders)
          OPENSSL_ia32cap: ":0"
        run: |
          set -euo pipefail
          echo "üîç Linux Crypto Shim Sanity Check (Canary)"
          echo "This canary test catches SIGILL early before full Gate 2 suite runs"
          echo ""
          echo "Environment diagnostics:"
          echo "  uname -a: $(uname -a)"
          echo "  Swift: $(swift --version | head -1)"
          echo "  CPU: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs || echo 'unknown')"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo ""
          echo "Environment variables (crypto-related):"
          env | sort | grep -E "(OPENSSL_ia32cap|ia32cap|CRYPTO|SWIFT)" || echo "  (none found)"
          # Guardrail: Ensure OPENSSL_ia32cap is set
          if [ -z "${OPENSSL_ia32cap:-}" ] || [ "${OPENSSL_ia32cap}" != ":0" ]; then
            echo ""
            echo "::error::OPENSSL_ia32cap must be ':0' on Linux Preflight to prevent SIGILL"
            echo "Current value: '${OPENSSL_ia32cap:-not set}'"
            echo "This will cause SIGILL crashes. Fix: Ensure OPENSSL_ia32cap=:0 is set at job level, step level, GITHUB_ENV, and inline prefix"
            exit 1
          fi
          echo ""
          echo "‚úÖ OPENSSL_ia32cap guardrail passed"
          echo ""
          echo "Testing CryptoShimConsistencyTests (canary test to catch SIGILL early)..."
          echo "Exact invocation: OPENSSL_ia32cap=:0 swift test -c debug --filter CryptoShimConsistencyTests"
          echo ""
          # Inline prefix ensures env is applied even if step-level env fails
          OPENSSL_ia32cap=:0 swift test -c debug --filter CryptoShimConsistencyTests || {
            echo ""
            echo "::error::SIGILL during crypto canary. This indicates native crypto backend illegal instruction."
            echo "See DEVELOPER_FAILURE_TRIAGE.md ‚Üí Ubuntu SIGILL section."
            echo ""
            echo "Diagnostics:"
            echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
            echo "  Test command: OPENSSL_ia32cap=:0 swift test -c debug --filter CryptoShimConsistencyTests"
            exit 1
          }
          echo "‚úÖ Crypto shim canary check passed (no SIGILL detected)"
      
      - name: Linux Preflight Complete
        run: |
          set -euo pipefail
          echo ""
          echo "‚úÖ Linux Preflight PASSED: Repository hygiene and workflow validation complete"
  
  # Gate 1 ‚Äî Constitutional Gate (Fast, Blocking)
  # Runs on every PR, must finish fast
  # Any failure blocks merge immediately
  # No retries, no soft warnings
  # Purpose: Stop illegal changes before humans rationalize them
  gate_1_constitutional:
    name: Gate 1 ‚Äî Constitutional (Fast, Blocking)
    runs-on: macos-14  # Pin to macos-14 for stable Xcode availability
    needs: [gate_0_workflow_lint]
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    
    strategy:
      fail-fast: true  # Stop immediately on first failure
      matrix:
        build_config: [debug, release]
        xcode_version: ['15.4']  # Single stable version (15.0 not reliably available)
    
    steps:
      - name: Concurrency Diagnostics
        run: |
          set -euo pipefail
          echo "::notice::Concurrency diagnostics for Gate 1"
          echo "event_name: ${{ github.event_name }}"
          echo "actor: ${{ github.actor }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo "SSOT_CONCURRENCY_GROUP: ${{ env.SSOT_CONCURRENCY_GROUP }}"
          echo "concurrency.group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo ""
      
      - name: Checkout
        # pinned from v4 (2026-01-24)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Setup Swift (Pinned Toolchain)
        if: runner.os == 'Linux'
        # pinned from v1 (2026-01-24)
        uses: swift-actions/setup-swift@cdbe0f7f4c77929b6580e71983e8606e55ffe7e4
        with:
          swift-version: "6.0"
          # Pin exact toolchain to prevent runner toolcache drift
      
      - name: Enumerate Available Xcodes
        run: |
          set -euo pipefail
          echo "üîç Available Xcode installations:"
          ls -1 /Applications | grep -E '^Xcode.*\.app$' || echo "  (none found)"
          echo ""
          echo "Current Xcode selection:"
          xcode-select -p || echo "  (none selected)"
          echo ""
      
      - name: Setup Xcode ${{ matrix.xcode_version }}
        # pinned from v1 (2026-01-24)
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd
        with:
          xcode-version: ${{ matrix.xcode_version }}
      
      - name: Validate Xcode Selection
        run: |
          set -euo pipefail
          chmod +x scripts/ci/validate_macos_xcode_selection.sh
          bash scripts/ci/validate_macos_xcode_selection.sh ${{ matrix.xcode_version }} || {
            echo ""
            echo "‚ùå Xcode validation failed"
            echo "Requested version: ${{ matrix.xcode_version }}"
            echo "Available Xcodes:"
            ls -1 /Applications | grep -E '^Xcode.*\.app$' || echo "  (none found)"
            echo ""
            echo "Fix: Update workflow matrix to match available Xcode versions on runner image"
            exit 1
          }
      
      - name: Setup Swift
        # pinned from v2 (2026-01-24)
        uses: swift-actions/setup-swift@7ca6abe6b3b0e8b5421b88be48feee39cbf52c6a
        with:
          swift-version: "6.0"
      
      - name: Toolchain Sanity Check
        run: |
          set -euo pipefail
          echo "üîç Toolchain Versions:"
          swift --version
          xcodebuild -version
          echo ""
      
      - name: Build (${{ matrix.build_config }})
        env:
          CONFIGURATION: ${{ matrix.build_config }}
        run: |
          set -euo pipefail
          swift build -c ${{ matrix.build_config }}
      
      - name: Run Gate 1 Tests (Constitutional)
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          XCODE_VERSION: ${{ matrix.xcode_version }}
        run: |
          set -euo pipefail
          echo "üîí Gate 1: Constitutional Gate (Fast, Blocking)"
          echo "Build Config: ${{ matrix.build_config }}"
          echo "Xcode Version: ${{ matrix.xcode_version }}"
          echo ""
          echo "Testing:"
          echo "  - Enum frozen order (B3)"
          echo "  - Catalog schema (B1, D2)"
          echo "  - Documentation sync (B1, B2)"
          echo "  - Encoding golden vectors (A2)"
          echo "  - Quantization golden vectors (A3, A4)"
          echo ""
          
          GATE1_OUTPUT_FILE="/tmp/gate1_test_output.log"
          swift test -c ${{ matrix.build_config }} \
            --filter EnumFrozenOrderTests \
            --filter CatalogSchemaTests \
            --filter DocumentationSyncTests \
            --filter DeterministicEncodingContractTests \
            --filter DeterministicQuantizationContractTests \
            --filter GoldenVectorsRoundTripTests 2>&1 | tee "$GATE1_OUTPUT_FILE" || {
            echo ""
            echo "‚ùå Gate 1 FAILED: Constitutional invariants violated"
            echo "Invariant IDs: B3, B1, D2, A2, A3, A4"
            echo "This blocks all merges. No retries allowed."
            echo "See docs/constitution/FAILURE_TRIAGE_MAP.md for repair guidance."
            exit 1
          }
          
          # Check for zero tests executed (must fail for required suites)
          # Use temp file to avoid SIGPIPE from grep -q
          GATE1_OUTPUT=$(cat "$GATE1_OUTPUT_FILE" 2>/dev/null || echo "")
          TEMP_GATE1_ZERO_CHECK=$(mktemp)
          echo "$GATE1_OUTPUT" > "$TEMP_GATE1_ZERO_CHECK"
          if grep -qE "Executed 0 tests|0 tests executed|0 test\(s\)" "$TEMP_GATE1_ZERO_CHECK"; then
            rm -f "$TEMP_GATE1_ZERO_CHECK"
            echo ""
            echo "‚ùå Gate 1 FAILED: Zero tests executed"
            echo "This indicates filter mismatch, test name change, or execution failure"
            echo "Test output:"
            echo "$GATE1_OUTPUT" | tail -20
            exit 1
          fi
          rm -f "$TEMP_GATE1_ZERO_CHECK"
          
          echo ""
          echo "‚úÖ Gate 1 PASSED: Constitutional invariants intact"
      
      - name: Cancellation Notice
        if: ${{ cancelled() }}
        run: |
          set -euo pipefail
          echo "::notice::JOB CANCELED (not a test failure)"
          echo ""
          echo "=== Cancellation Classification ==="
          echo "Status: CANCELLED (superseded by newer run)"
          echo "Classification: Concurrency cancellation (not a test failure)"
          echo ""
          echo "=== Context ==="
          echo "event_name: ${{ github.event_name }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo ""
          echo "=== Concurrency ==="
          echo "concurrency.group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo "SSOT_CONCURRENCY_GROUP: ${{ env.SSOT_CONCURRENCY_GROUP }}"
          echo ""
          echo "=== Note ==="
          echo "This job was cancelled because a newer run started with the same concurrency group."
          echo "This is expected behavior and does NOT indicate a test failure."
          echo "To see test results, check the newer run (run_id: check GitHub Actions UI)"
  
  # Gate 2 ‚Äî Determinism & Trust Gate (macOS, Blocking)
  # Runs only if Gate 1 passes
  # Enforces long-term reproducibility, auditability, and user trust
  # macOS-only: Linux Gate 2 uses separate telemetry job (gate_2_determinism_trust_linux_telemetry) in Whitebox mode
  gate_2_determinism_trust:
    name: Gate 2 ‚Äî Determinism & Trust (macOS, Blocking)
    runs-on: ${{ matrix.runs_on }}
    needs: [gate_1_constitutional]
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
    # macOS: Uses native CryptoKit (SSOT_PURE_SWIFT_SHA256 intentionally absent)
    strategy:
      fail-fast: false
      matrix:
        include:
          - runs_on: macos-14
            xcode_version: '15.4'
            build_config: debug
            # macOS: SSOT_PURE_SWIFT_SHA256 intentionally absent (uses native CryptoKit)
          - runs_on: macos-14
            xcode_version: '15.4'
            build_config: release
            # macOS: SSOT_PURE_SWIFT_SHA256 intentionally absent (uses native CryptoKit)
    
    steps:
      - name: Concurrency Diagnostics
        run: |
          set -euo pipefail
          echo "::notice::Concurrency diagnostics for Gate 2"
          echo "event_name: ${{ github.event_name }}"
          echo "actor: ${{ github.actor }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo "SSOT_CONCURRENCY_GROUP: ${{ env.SSOT_CONCURRENCY_GROUP }}"
          echo "concurrency.group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo ""
      
      - name: Checkout
        # pinned from v4 (2026-01-24)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Setup Xcode (macOS only)
        if: matrix.runs_on == 'macos-14'
        # pinned from v1 (2026-01-24)
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd
        with:
          xcode-version: ${{ matrix.xcode_version }}
      
      - name: Validate Xcode Selection (macOS only)
        if: matrix.runs_on == 'macos-14'
        run: |
          set -euo pipefail
          chmod +x scripts/ci/validate_macos_xcode_selection.sh
          bash scripts/ci/validate_macos_xcode_selection.sh ${{ matrix.xcode_version }} || {
            echo ""
            echo "‚ùå Xcode validation failed"
            echo "Requested version: ${{ matrix.xcode_version }}"
            echo "Available Xcodes:"
            ls -1 /Applications | grep -E '^Xcode.*\.app$' || echo "  (none found)"
            echo ""
            echo "Fix: Update workflow matrix to match available Xcode versions on runner image"
            exit 1
          }
      
      - name: Setup Swift
        # pinned from v2 (2026-01-24)
        uses: swift-actions/setup-swift@7ca6abe6b3b0e8b5421b88be48feee39cbf52c6a
        with:
          swift-version: "6.0"
      
      - name: Toolchain Sanity Check
        run: |
          set -euo pipefail
          echo "üîç Toolchain Versions:"
          swift --version
          xcodebuild -version || echo "xcodebuild not available"
          echo ""
      
      - name: Cancellation Notice
        if: ${{ cancelled() }}
        run: |
          set -euo pipefail
          echo "::notice::JOB CANCELED (not a test failure)"
          echo ""
          echo "=== Cancellation Classification ==="
          echo "Status: CANCELLED (superseded by newer run)"
          echo "Classification: Concurrency cancellation (not a test failure)"
          echo ""
          echo "=== Context ==="
          echo "event_name: ${{ github.event_name }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo ""
          echo "=== Note ==="
          echo "This job was cancelled because a newer run started with the same concurrency group."
          echo "This is expected behavior and does NOT indicate a test failure."
          echo "To see test results, check the newer run (run_id: check GitHub Actions UI)"
  
  # Gate 2 ‚Äî Determinism & Trust Gate (Linux, Telemetry) ‚Äî Non-Blocking Telemetry (Whitebox)
  # Runs only if Gate 1 and Linux Preflight pass
  # NON-BLOCKING: GitHub-hosted Linux runner environmental drift (SIGILL) is not controllable without self-hosted runner
  # During Whitebox, this preserves full telemetry, policy tests, and SIGILL classification without blocking merge
  # Policy: SSOT_PURE_SWIFT_SHA256="1", OPENSSL_ia32cap=":0", GLIBC_TUNABLES baseline (all hardening preserved)
  # SIGILL classification: Exclusive (SIGILL_ENVIRONMENTAL, never reported as invariant drift)
  # Note: In PRODUCTION mode, this job should be replaced with a self-hosted blocking job (gate_2_determinism_trust_linux_self_hosted)
  gate_2_determinism_trust_linux_telemetry:
    name: Gate 2 ‚Äî Determinism & Trust (Linux, Telemetry) (Non-Blocking, Whitebox)
    runs-on: ubuntu-22.04
    needs: [gate_1_constitutional, gate_linux_preflight_only]
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
    # Explicitly non-blocking: failures do not affect merge gates (Whitebox mode)
    continue-on-error: true
    # Telemetry: Full hardening preserved for diagnostic value
    # Setting OPENSSL_ia32cap=:0 at job level ensures it's inherited by all steps and child processes
    # Setting SSOT_PURE_SWIFT_SHA256=1 forces pure Swift crypto backend (deterministic, no SIGILL risk)
    # Setting GLIBC_TUNABLES disables CPU feature detection at process level (baseline lock)
    env:
      OPENSSL_ia32cap: ":0"
      SSOT_PURE_SWIFT_SHA256: "1"
      GLIBC_TUNABLES: "glibc.cpu.hwcaps=-x86-64-v3:-x86-64-v4"
    strategy:
      fail-fast: false
      matrix:
        build_config: [debug, release]
    
    steps:
      - name: Concurrency Diagnostics
        run: |
          set -euo pipefail
          echo "::notice::Concurrency diagnostics for Gate 2 Linux (Telemetry, Whitebox)"
          echo "event_name: ${{ github.event_name }}"
          echo "actor: ${{ github.actor }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo "SSOT_CONCURRENCY_GROUP: ${{ env.SSOT_CONCURRENCY_GROUP }}"
          echo "concurrency.group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo ""
      
      - name: Checkout
        # pinned from v4 (2026-01-24)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Whitebox Telemetry Banner
        run: |
          set -euo pipefail
          echo "üìä Gate 2 Linux: Telemetry (Non-Blocking, Whitebox)"
          echo ""
          echo "‚ö†Ô∏è  This is a NON-BLOCKING telemetry job. Failures do NOT block merges."
          echo "‚ö†Ô∏è  Mode: WHITEBOX (temporary)"
          echo ""
          echo "Purpose: Monitor GitHub-hosted runner drift and SIGILL frequency."
          echo "Rationale: GitHub-hosted Linux runner CPU micro-architecture drift causes SIGILL"
          echo "  that we cannot control without self-hosted runner infrastructure."
          echo ""
          echo "This job preserves:"
          echo "  ‚úÖ Full hardening (SSOT_PURE_SWIFT_SHA256, OPENSSL_ia32cap, GLIBC_TUNABLES)"
          echo "  ‚úÖ Policy tests (CryptoBackendPolicyTests runs first)"
          echo "  ‚úÖ SIGILL classification (exclusive, never reported as invariant drift)"
          echo "  ‚úÖ All guardrails and diagnostics"
          echo ""
          echo "Config: ${{ matrix.build_config }}"
          echo ""
      
      - name: Detect system Swift (telemetry)
        shell: bash
        run: |
          set -euo pipefail
          echo "üîç System Swift Detection (WHITEBOX Linux Telemetry)"
          echo ""
          echo "‚ö†Ô∏è  WHITEBOX Linux Telemetry: Using system Swift on GitHub-hosted runner"
          echo "‚ö†Ô∏è  Toolchain pinning is NOT enforced in telemetry lanes (PRODUCTION/self-hosted concern)"
          echo ""
          echo "Environment fingerprint:"
          echo "  runner.os: ubuntu-22.04"
          echo "  uname -a: $(uname -a)"
          echo ""
          if ! command -v swift >/dev/null 2>&1; then
            echo "::notice::Telemetry cancelled: system swift not present on runner"
            echo "TELEMETRY_RESULT=CANCELLED" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=NO_SYSTEM_SWIFT" >> "$GITHUB_ENV"
            echo ""
            echo "Swift location: not found in PATH"
            echo "Swift version: not available"
            echo "Swift compiler version: not available"
            echo ""
            echo "Telemetry job will be cancelled gracefully (exit 0)"
            exit 0
          else
            echo "TELEMETRY_RESULT=RUNNING" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=" >> "$GITHUB_ENV"
            echo ""
            echo "Swift location: $(which swift)"
            echo ""
            echo "Swift version:"
            swift --version || echo "  ‚ö†Ô∏è  swift --version failed"
            echo ""
            echo "Swift compiler version:"
            swiftc --version || echo "  ‚ö†Ô∏è  swiftc --version failed"
            echo ""
            echo "‚úÖ System Swift detected - telemetry will proceed"
          fi
      
      - name: Export OPENSSL_ia32cap to GITHUB_ENV
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        run: |
          set -euo pipefail
          echo 'OPENSSL_ia32cap=:0' >> "$GITHUB_ENV"
          echo "‚úÖ Exported OPENSSL_ia32cap=:0 to GITHUB_ENV for all subsequent steps"
      
      - name: Linux System Diagnostics
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        run: |
          set -euo pipefail
          echo "üîç Linux System Diagnostics (GitHub-hosted Telemetry)"
          echo "  uname -a: $(uname -a)"
          echo "  uname -m: $(uname -m)"
          echo "  CPU info:"
          lscpu | head -20 || true
          cat /proc/cpuinfo | head -40 || true
          echo ""
          echo "Crypto-related environment variables:"
          env | grep -E 'OPENSSL_ia32cap|CRYPTO|BORING|SWIFT_CRYPTO|SSOT_PURE_SWIFT_SHA256|GLIBC_TUNABLES' || echo "  (none found)"
          echo ""
      
      - name: Verify OPENSSL_ia32cap Guardrail
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        run: |
          set -euo pipefail
          echo "üîç Verifying OPENSSL_ia32cap is set to prevent SIGILL..."
          echo "Current OPENSSL_ia32cap value:"
          env | grep -E '^OPENSSL_ia32cap=' || echo "  (not found in env)"
          echo ""
          if [ -z "${OPENSSL_ia32cap:-}" ] || [ "${OPENSSL_ia32cap}" != ":0" ]; then
            echo "::warning::OPENSSL_ia32cap should be ':0' on Linux Gate 2 telemetry to prevent SIGILL"
            echo "Current value: '${OPENSSL_ia32cap:-not set}'"
            echo "Note: This is telemetry (non-blocking), but hardening is preserved for diagnostic value"
          else
            echo "‚úÖ OPENSSL_ia32cap=${OPENSSL_ia32cap} (correct)"
          fi
      
      - name: Verify GLIBC_TUNABLES Guardrail
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        run: |
          set -euo pipefail
          echo "üîç Verifying GLIBC_TUNABLES is set for process-wide CPU feature baseline lock..."
          echo "Current GLIBC_TUNABLES value:"
          env | grep -E '^GLIBC_TUNABLES=' || echo "  (not found in env)"
          echo ""
          if [ -z "${GLIBC_TUNABLES:-}" ] || [ "${GLIBC_TUNABLES}" != "glibc.cpu.hwcaps=-x86-64-v3:-x86-64-v4" ]; then
            echo "::warning::GLIBC_TUNABLES should be 'glibc.cpu.hwcaps=-x86-64-v3:-x86-64-v4' on Linux Gate 2 telemetry"
            echo "Current value: '${GLIBC_TUNABLES:-not set}'"
            echo "Note: This is telemetry (non-blocking), but hardening is preserved for diagnostic value"
          else
            echo "‚úÖ GLIBC_TUNABLES=${GLIBC_TUNABLES} (process-wide CPU feature baseline lock enabled)"
          fi
      
      - name: Verify SSOT_PURE_SWIFT_SHA256 Guardrail
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        run: |
          set -euo pipefail
          echo "üîç Verifying SSOT_PURE_SWIFT_SHA256 is set to force pure Swift backend..."
          echo "Current SSOT_PURE_SWIFT_SHA256 value:"
          env | grep -E '^SSOT_PURE_SWIFT_SHA256=' || echo "  (not found in env)"
          echo ""
          if [[ "${SSOT_PURE_SWIFT_SHA256:-}" != "1" ]]; then
            echo "::warning::SSOT_PURE_SWIFT_SHA256 should be '1' on Linux Gate 2 telemetry to force pure Swift backend"
            echo "Current value: '${SSOT_PURE_SWIFT_SHA256:-not set}'"
            echo "Note: This is telemetry (non-blocking), but hardening is preserved for diagnostic value"
          else
            echo "‚úÖ SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256} (pure Swift backend enabled)"
          fi
      
      - name: Crypto Canary Test ‚Äî Early SIGILL Detection
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        env:
          # Step-level env (belt-and-suspenders)
          OPENSSL_ia32cap: ":0"
          SSOT_PURE_SWIFT_SHA256: "1"
        run: |
          set -euo pipefail
          set +e  # Disable exit on error for WHITEBOX telemetry
          echo "üîç Crypto Canary Test (catches SIGILL before full Gate 2 suite)"
          echo "Testing CryptoShimConsistencyTests with pure Swift backend (SSOT_PURE_SWIFT_SHA256=1)..."
          echo ""
          echo "Environment check:"
          echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo ""
          # Inline prefix ensures env is applied even if step-level env fails
          SSOT_PURE_SWIFT_SHA256=1 OPENSSL_ia32cap=:0 swift test -c debug --filter CryptoShimConsistencyTests 2>&1 | tee /tmp/canary_output.log
          CANARY_EXIT=$?
          CANARY_OUTPUT=$(cat /tmp/canary_output.log 2>/dev/null || echo "")
          set -e  # Re-enable exit on error
          
          if [ $CANARY_EXIT -ne 0 ]; then
            echo ""
            echo "::notice::Crypto canary test failed (exit code: $CANARY_EXIT) - WHITEBOX telemetry (non-blocking)"
            echo ""
            # Check for SIGILL (use temp file to avoid SIGPIPE)
            TEMP_CANARY_SIGILL_CHECK=$(mktemp)
            echo "$CANARY_OUTPUT" > "$TEMP_CANARY_SIGILL_CHECK"
            SIGILL_DETECTED=0
            if grep -qE "signal code 4|Illegal instruction|SIGILL|Exited with unexpected signal code 4" "$TEMP_CANARY_SIGILL_CHECK"; then
              SIGILL_DETECTED=1
            fi
            rm -f "$TEMP_CANARY_SIGILL_CHECK"
            if [ $SIGILL_DETECTED -eq 1 ]; then
              echo "TELEMETRY_RESULT=SIGILL_ENVIRONMENTAL" >> "$GITHUB_ENV"
              echo "=== SIGILL_ENVIRONMENTAL_FAILURE ==="
              echo "swift --version:"
              swift --version || echo "  (swift not available)"
              echo ""
              echo "uname -a:"
              uname -a || echo "  (uname not available)"
              echo ""
              echo "CPU flags:"
              grep -m1 '^flags' /proc/cpuinfo || echo "  (cpuinfo not available)"
              echo ""
              echo "SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
              echo "OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
              echo "GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set}"
              echo ""
              echo "‚ö†Ô∏è  SIGILL in GitHub-hosted telemetry confirms runner CPU micro-architecture drift."
              echo "This is expected in telemetry (non-blocking). See MERGE_CONTRACT.md ‚Üí Whitebox Merge Contract."
            else
              echo "TELEMETRY_RESULT=FAIL" >> "$GITHUB_ENV"
              echo "‚ö†Ô∏è  Crypto canary test failed (non-SIGILL failure) - WHITEBOX telemetry (non-blocking)"
            fi
            echo ""
            echo "See DEVELOPER_FAILURE_TRIAGE.md ‚Üí Ubuntu SIGILL section."
            exit 0  # Always exit 0 in WHITEBOX telemetry
          else
            echo "TELEMETRY_RESULT=PASS" >> "$GITHUB_ENV"
            # Backend policy is enforced by CryptoBackendPolicyTests (runs first in Gate 2)
            # This canary test verifies no SIGILL occurs; backend correctness is validated by policy test
            echo "‚úÖ Crypto canary passed (pure Swift backend verified, no SIGILL detected)"
            exit 0
          fi
      
      - name: Build (${{ matrix.build_config }})
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          swift build -c ${{ matrix.build_config }}
      
      - name: Final OPENSSL_ia32cap Verification Before Tests
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        run: |
          set -euo pipefail
          echo "üîç Final OPENSSL_ia32cap verification before running tests..."
          echo "Environment check:"
          env | grep -E '^OPENSSL_ia32cap=' || echo "  ‚ùå OPENSSL_ia32cap not found in env"
          echo ""
          if [ -z "${OPENSSL_ia32cap:-}" ] || [ "${OPENSSL_ia32cap}" != ":0" ]; then
            echo "::error::OPENSSL_ia32cap must be ':0' before running tests"
            echo "Current value: '${OPENSSL_ia32cap:-not set}'"
            echo "This will cause SIGILL. All layers must be set: job env + step env + GITHUB_ENV + inline prefix"
            exit 1
          fi
          echo "‚úÖ OPENSSL_ia32cap=${OPENSSL_ia32cap} verified (all layers applied)"
          echo ""
      
      - name: Linux System Diagnostics Before Tests
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        run: |
          set -euo pipefail
          echo "üîç Linux System Diagnostics (for SIGILL root cause identification)"
          echo "System information:"
          echo "  uname -a: $(uname -a)"
          echo "  uname -m: $(uname -m)"
          echo "  CPU info:"
          lscpu | head -20 || true
          echo ""
          echo "Environment variables (crypto-related):"
          env | grep -E '^OPENSSL_ia32cap=' || echo "  (OPENSSL_ia32cap not found)"
          env | grep -E 'SSOT_PURE_SWIFT_SHA256' || echo "  (SSOT_PURE_SWIFT_SHA256 not set, using native crypto)"
          env | grep -E 'GLIBC_TUNABLES' || echo "  (GLIBC_TUNABLES not set)"
          echo ""
          echo "Locating built xctest binary and checking dependencies..."
          # Find the xctest binary path (typically in .build/debug or .build/release)
          XCTEST_PATH=$(find .build -name "xctest" -type f 2>/dev/null | head -1 || echo "")
          if [ -n "$XCTEST_PATH" ]; then
            echo "  Found xctest at: $XCTEST_PATH"
            echo "  Dependencies (crypto-related):"
            ldd "$XCTEST_PATH" 2>/dev/null | grep -E 'ssl|crypto|boring|swift|foundation' || echo "    (no crypto-related dependencies found or ldd failed)"
          else
            echo "  ‚ö†Ô∏è  xctest binary not found (may not be built yet or path differs)"
          fi
          echo ""
          echo "Note: These diagnostics are for troubleshooting only; they do not affect test execution."
          echo ""
      
      - name: Run Gate 2 Tests (Determinism & Trust ‚Äî Linux Telemetry)
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
          OPENSSL_ia32cap: ${{ env.OPENSSL_ia32cap }}
          SSOT_PURE_SWIFT_SHA256: ${{ env.SSOT_PURE_SWIFT_SHA256 }}
        run: |
          set -euo pipefail
          echo "üìä Gate 2: Determinism & Trust Gate (Linux, Telemetry, Non-Blocking, Whitebox)"
          echo ""
          echo "‚ö†Ô∏è  NON-BLOCKING TELEMETRY (Whitebox mode)"
          echo "‚ö†Ô∏è  Failures do NOT block merges"
          echo ""
          echo "Runner: ubuntu-22.04 (GitHub-hosted)"
          echo "Config: ${{ matrix.build_config }}"
          echo ""
          echo "Linux diagnostics (GitHub-hosted telemetry):"
          echo "  uname -a: $(uname -a)"
          echo "  Swift: $(swift --version | head -1)"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
          echo "  GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set}"
          echo ""
          echo "Environment variables (crypto-related):"
          env | sort | grep -E "(OPENSSL_ia32cap|SSOT_PURE_SWIFT_SHA256|GLIBC_TUNABLES|ia32cap|CRYPTO|SWIFT)" || echo "  (none found)"
          echo ""
          echo "Testing:"
          echo "  - Cross-platform consistency (A2, A3, A4, A5, CE, CL2)"
          echo "  - Color matrix integrity (CE)"
          echo "  - Domain prefixes (G1)"
          echo "  - Reproducibility boundary (E2)"
          echo "  - Breaking surface (C1)"
          echo "  - Explanation catalog coverage (B1, B2, D2)"
          echo "  - Reason compatibility (U1, U16)"
          echo "  - Minimum explanation set (D2)"
          echo ""
          echo "Exact swift test invocation (with inline env prefixes):"
          echo "  SSOT_PURE_SWIFT_SHA256=1 OPENSSL_ia32cap=:0 swift test -c ${{ matrix.build_config }} --filter [Gate 2 test suites]"
          echo ""
          
          # Build filter arguments as array (keeps literal --filter tokens visible to grep-based validators)
          FILTERS=(
            --filter CryptoBackendPolicyTests
            --filter ColorMatrixIntegrityTests
            --filter DomainPrefixesTests
            --filter ReproducibilityBoundaryTests
            --filter BreakingSurfaceTests
            --filter ExplanationCatalogCoverageTests
            --filter ReasonCompatibilityTests
            --filter MinimumExplanationSetTests
            --filter CatalogUniquenessTests
            --filter ExplanationIntegrityTests
            --filter CatalogCrossReferenceTests
            --filter CatalogActionabilityRulesTests
            --filter DomainPrefixesClosureTests
            --filter CryptoShimConsistencyTests
          )
          
          # Telemetry Linux: use pure Swift backend (SSOT_PURE_SWIFT_SHA256=1) + OPENSSL_ia32cap=:0
          # Inline prefix uses explicit values from job env (closed-world assertion)
          # Non-blocking: failures do not block merges (Whitebox mode)
          # WHITEBOX mode: never exit non-zero (always exit 0)
          set +e  # Disable exit on error for WHITEBOX telemetry
          TEST_OUTPUT_FILE="/tmp/gate2_test_output.log"
          SSOT_PURE_SWIFT_SHA256="${SSOT_PURE_SWIFT_SHA256:-1}" OPENSSL_ia32cap="${OPENSSL_ia32cap:-:0}" swift test -c "${{ matrix.build_config }}" "${FILTERS[@]}" 2>&1 | tee "$TEST_OUTPUT_FILE"
          TEST_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          # Check for zero tests executed (must fail for required suites)
          # Use temp file to avoid SIGPIPE from grep -q
          TEST_OUTPUT=$(cat "$TEST_OUTPUT_FILE" 2>/dev/null || echo "")
          TEMP_ZERO_CHECK=$(mktemp)
          echo "$TEST_OUTPUT" > "$TEMP_ZERO_CHECK"
          ZERO_TESTS=0
          if grep -qE "Executed 0 tests|0 tests executed|0 test\(s\)" "$TEMP_ZERO_CHECK"; then
            ZERO_TESTS=1
          fi
          rm -f "$TEMP_ZERO_CHECK"
          
          if [ $ZERO_TESTS -eq 1 ]; then
            echo ""
            echo "::notice::Gate 2 Linux Telemetry: Zero tests executed (non-blocking, WHITEBOX)"
            echo "This indicates filter mismatch, test name change, or execution failure"
            echo "Test output:"
            echo "$TEST_OUTPUT" | tail -20
            echo "TELEMETRY_RESULT=FAIL" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=ZERO_TESTS_EXECUTED" >> "$GITHUB_ENV"
            exit 0  # Always exit 0 in WHITEBOX telemetry
          fi
          
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo ""
            # Classify SIGILL explicitly (exclusive classification, non-confusing)
            # Check output patterns (exit code from pipe not reliable, use pattern matching)
            # Use temp file to avoid SIGPIPE from grep -q
            IS_SIGILL=0
            TEMP_SIGILL_CHECK=$(mktemp)
            echo "$TEST_OUTPUT" > "$TEMP_SIGILL_CHECK"
            if grep -qE "signal code 4|Illegal instruction|SIGILL|Exited with unexpected signal code 4" "$TEMP_SIGILL_CHECK"; then
              IS_SIGILL=1
            fi
            rm -f "$TEMP_SIGILL_CHECK"
            
            if [ $IS_SIGILL -eq 1 ]; then
              echo "TELEMETRY_RESULT=SIGILL_ENVIRONMENTAL" >> "$GITHUB_ENV"
              echo "TELEMETRY_REASON=SIGILL_DETECTED" >> "$GITHUB_ENV"
              echo "SSOT_GATE2_FAILURE_CLASS=SIGILL_ENVIRONMENTAL"
              echo ""
              echo "=== SIGILL Detected in GitHub-hosted Telemetry (Non-Blocking, Whitebox) ==="
              echo ""
              echo "AUDIT: Gate2 GitHub-hosted telemetry SIGILL detected"
              echo "  CPU flags: $(grep -m1 '^flags' /proc/cpuinfo | cut -d: -f2 | xargs || echo 'unknown')"
              echo "  Swift version: $(swift --version | head -1 || echo 'not available')"
              echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
              echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
              echo "  GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set}"
              echo ""
              echo "swift --version:"
              swift --version || echo "  (swift not available)"
              echo ""
              echo "uname -a:"
              uname -a || echo "  (uname not available)"
              echo ""
              echo "CPU flags:"
              grep -m1 '^flags' /proc/cpuinfo || echo "  (cpuinfo not available)"
              echo ""
              echo "Backend policy: Enforced by CryptoBackendPolicyTests (see test output above)"
              echo ""
              echo "Last 50 lines of test output:"
              echo "$TEST_OUTPUT" | tail -50
              echo ""
              echo "‚ö†Ô∏è  Note: Invariants NOT evaluated due to crash"
              echo "‚ö†Ô∏è  This is an environmental failure, NOT an invariant drift."
              echo "‚ö†Ô∏è  SIGILL confirms GitHub-hosted runner CPU micro-architecture drift."
              echo "‚ö†Ô∏è  This telemetry failure does NOT block merges (Whitebox mode)."
              echo "‚ö†Ô∏è  See MERGE_CONTRACT.md ‚Üí Whitebox Merge Contract for rationale."
              echo "::notice::Gate 2 Linux Telemetry: SIGILL_ENVIRONMENTAL (non-blocking, environmental failure)"
              exit 0  # Always exit 0 in WHITEBOX telemetry
            fi
            # Non-SIGILL failures: standard Gate 2 failure message (but non-blocking in Whitebox)
            echo "TELEMETRY_RESULT=FAIL" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=TEST_FAILURE" >> "$GITHUB_ENV"
            echo ""
            echo "‚ö†Ô∏è  Gate 2 FAILED: Determinism, reproducibility, or user trust violated (Non-Blocking, Whitebox)"
            echo "Invariant IDs: A2, A3, A4, A5, CE, CL2, E2, C1, B1, B2, D2, G1, U1, U16"
            echo "This indicates cross-platform drift, breaking change violation, or explanation integrity issue."
            echo "‚ö†Ô∏è  This failure does NOT block merges (Whitebox mode)."
            echo "‚ö†Ô∏è  See MERGE_CONTRACT.md ‚Üí Whitebox Merge Contract for rationale."
            echo "See docs/constitution/FAILURE_TRIAGE_MAP.md for repair guidance."
            echo "::notice::Gate 2 Linux Telemetry: FAILED (non-blocking, invariant violation detected)"
            exit 0  # Always exit 0 in WHITEBOX telemetry
          fi
          
          echo ""
          echo "‚úÖ Gate 2 PASSED: Determinism, reproducibility, and user trust intact (Telemetry, Non-Blocking)"
          echo "TELEMETRY_RESULT=PASS" >> "$GITHUB_ENV"
          echo "TELEMETRY_REASON=" >> "$GITHUB_ENV"
          echo "::notice::Gate 2 Linux Telemetry: PASSED (non-blocking)"
      
      - name: Telemetry summary
        if: always()
        run: |
          set -euo pipefail
          TELEMETRY_RESULT="${TELEMETRY_RESULT:-UNKNOWN}"
          TELEMETRY_REASON="${TELEMETRY_REASON:-}"
          echo ""
          echo "üìä Telemetry Summary (WHITEBOX Linux Telemetry)"
          echo "  Job: gate_2_determinism_trust_linux_telemetry"
          echo "  Mode: WHITEBOX (non-blocking)"
          echo "  Result: ${TELEMETRY_RESULT}"
          if [ -n "${TELEMETRY_REASON}" ]; then
            echo "  Reason: ${TELEMETRY_REASON}"
          fi
          echo ""
          case "${TELEMETRY_RESULT}" in
            CANCELLED)
              echo "::notice::Telemetry cancelled: ${TELEMETRY_REASON:-system swift not available}"
              ;;
            PASS)
              echo "::notice::Telemetry passed: All tests completed successfully"
              ;;
            SIGILL_ENVIRONMENTAL)
              echo "::notice::Telemetry SIGILL detected: Environmental failure (non-blocking)"
              ;;
            FAIL)
              echo "::notice::Telemetry failed: ${TELEMETRY_REASON:-test failure} (non-blocking)"
              ;;
            *)
              echo "::notice::Telemetry result: ${TELEMETRY_RESULT} (non-blocking)"
              ;;
          esac
          echo ""
          echo "This job does NOT block merges regardless of outcome (WHITEBOX mode)"
          exit 0  # Always exit 0
      
      - name: Cancellation Notice
        if: ${{ cancelled() }}
        run: |
          set -euo pipefail
          echo "::notice::JOB CANCELED (not a test failure)"
          echo ""
          echo "=== Cancellation Classification ==="
          echo "Status: CANCELLED (superseded by newer run)"
          echo "Classification: Concurrency cancellation (not a test failure)"
          echo ""
          echo "=== Context ==="
          echo "event_name: ${{ github.event_name }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo ""
          echo "=== Note ==="
          echo "This job was cancelled because a newer run started with the same concurrency group."
          echo "This is expected behavior and does NOT indicate a test failure."
          echo "To see test results, check the newer run (run_id: check GitHub Actions UI)"
  
  # Gate 2 Linux (GitHub-hosted drift telemetry) ‚Äî Non-Blocking Telemetry (Legacy)
  # Purpose: Monitor GitHub-hosted runner drift and SIGILL frequency
  # Runs on pull_request but is non-blocking (continue-on-error: true)
  # Note: This job is kept for backward compatibility. Primary Linux Gate 2 telemetry is gate_2_determinism_trust_linux_telemetry
  gate_2_linux_hosted_telemetry:
    name: Gate 2 Linux (GitHub-hosted drift telemetry)
    runs-on: ubuntu-22.04
    needs: [gate_1_constitutional, gate_linux_preflight_only]
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
    # Explicitly non-blocking: failures do not affect merge gates
    continue-on-error: true
    # Telemetry: Monitor GitHub-hosted runner drift
    env:
      OPENSSL_ia32cap: ":0"
      SSOT_PURE_SWIFT_SHA256: "1"
      GLIBC_TUNABLES: "glibc.cpu.hwcaps=-x86-64-v3:-x86-64-v4"
    strategy:
      fail-fast: false
      matrix:
        build_config: [debug, release]
    
    steps:
      - name: Checkout
        # pinned from v4 (2026-01-24)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Detect system Swift (telemetry)
        shell: bash
        run: |
          set -euo pipefail
          echo "üîç System Swift Detection (WHITEBOX Linux Telemetry)"
          echo ""
          echo "‚ö†Ô∏è  WHITEBOX Linux Telemetry: Using system Swift on GitHub-hosted runner"
          echo "‚ö†Ô∏è  Toolchain pinning is NOT enforced in telemetry lanes (PRODUCTION/self-hosted concern)"
          echo ""
          echo "Environment fingerprint:"
          echo "  runner.os: ubuntu-22.04"
          echo "  uname -a: $(uname -a)"
          echo ""
          if ! command -v swift >/dev/null 2>&1; then
            echo "::notice::Telemetry cancelled: system swift not present on runner"
            echo "TELEMETRY_RESULT=CANCELLED" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=NO_SYSTEM_SWIFT" >> "$GITHUB_ENV"
            echo ""
            echo "Swift location: not found in PATH"
            echo "Swift version: not available"
            echo "Swift compiler version: not available"
            echo ""
            echo "Telemetry job will be cancelled gracefully (exit 0)"
            exit 0
          else
            echo "TELEMETRY_RESULT=RUNNING" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=" >> "$GITHUB_ENV"
            echo ""
            echo "Swift location: $(which swift)"
            echo ""
            echo "Swift version:"
            swift --version || echo "  ‚ö†Ô∏è  swift --version failed"
            echo ""
            echo "Swift compiler version:"
            swiftc --version || echo "  ‚ö†Ô∏è  swiftc --version failed"
            echo ""
            echo "‚úÖ System Swift detected - telemetry will proceed"
          fi
      
      - name: Build (${{ matrix.build_config }})
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          echo "Building in ${{ matrix.build_config }} configuration..."
          swift build -c "${{ matrix.build_config }}" || {
            echo "‚ùå Build failed"
            exit 1
          }
      
      - name: Run Gate 2 Tests (GitHub-hosted Telemetry)
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
          OPENSSL_ia32cap: ${{ env.OPENSSL_ia32cap }}
          SSOT_PURE_SWIFT_SHA256: ${{ env.SSOT_PURE_SWIFT_SHA256 }}
        run: |
          set -euo pipefail
          set +e  # Disable exit on error for WHITEBOX telemetry
          echo "üìä Gate 2 Linux (GitHub-hosted drift telemetry) ‚Äî Non-Blocking"
          echo ""
          echo "‚ö†Ô∏è  This is a NON-BLOCKING telemetry job. Failures do NOT block merges."
          echo "‚ö†Ô∏è  Blocking Gate 2 Linux uses self-hosted deterministic executor."
          echo ""
          echo "Purpose: Monitor GitHub-hosted runner drift and SIGILL frequency."
          echo "Blocking Gate 2: Uses self-hosted runner with fixed baseline CPU."
          echo ""
          echo "Environment:"
          echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo "  GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set}"
          echo ""
          echo "Linux diagnostics:"
          echo "  uname -a: $(uname -a)"
          echo "  Swift: $(swift --version | head -1 || echo 'not available')"
          echo "  CPU flags:"
          grep -m1 '^flags' /proc/cpuinfo || echo "  (cpuinfo not available)"
          echo ""
          
          # Build filter arguments (same as blocking Gate 2)
          FILTERS=(
            --filter CryptoBackendPolicyTests
            --filter ColorMatrixIntegrityTests
            --filter DomainPrefixesTests
            --filter ReproducibilityBoundaryTests
            --filter BreakingSurfaceTests
            --filter ExplanationCatalogCoverageTests
            --filter ReasonCompatibilityTests
            --filter MinimumExplanationSetTests
            --filter CatalogUniquenessTests
            --filter ExplanationIntegrityTests
            --filter CatalogCrossReferenceTests
            --filter CatalogActionabilityRulesTests
            --filter DomainPrefixesClosureTests
            --filter CryptoShimConsistencyTests
          )
          
          TEST_OUTPUT_FILE="/tmp/gate2_hosted_telemetry_output.log"
          SSOT_PURE_SWIFT_SHA256="${SSOT_PURE_SWIFT_SHA256:-1}" OPENSSL_ia32cap="${OPENSSL_ia32cap:-:0}" swift test -c "${{ matrix.build_config }}" "${FILTERS[@]}" 2>&1 | tee "$TEST_OUTPUT_FILE"
          TEST_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          TEST_OUTPUT=$(cat "$TEST_OUTPUT_FILE" 2>/dev/null || echo "")
          
          # Check for zero tests executed
          TEMP_ZERO_CHECK=$(mktemp)
          echo "$TEST_OUTPUT" > "$TEMP_ZERO_CHECK"
          ZERO_TESTS=0
          if grep -qE "Executed 0 tests|0 tests executed|0 test\(s\)" "$TEMP_ZERO_CHECK"; then
            ZERO_TESTS=1
          fi
          rm -f "$TEMP_ZERO_CHECK"
          
          if [ $ZERO_TESTS -eq 1 ]; then
            echo ""
            echo "::notice::Gate 2 Linux Telemetry: Zero tests executed (non-blocking, WHITEBOX)"
            echo "TELEMETRY_RESULT=FAIL" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=ZERO_TESTS_EXECUTED" >> "$GITHUB_ENV"
            exit 0  # Always exit 0 in WHITEBOX telemetry
          fi
          
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            # Classify SIGILL explicitly
            IS_SIGILL=0
            TEMP_SIGILL_CHECK=$(mktemp)
            echo "$TEST_OUTPUT" > "$TEMP_SIGILL_CHECK"
            if grep -qE "signal code 4|Illegal instruction|SIGILL|Exited with unexpected signal code 4" "$TEMP_SIGILL_CHECK"; then
              IS_SIGILL=1
            fi
            rm -f "$TEMP_SIGILL_CHECK"
            
            if [ $IS_SIGILL -eq 1 ]; then
              echo "TELEMETRY_RESULT=SIGILL_ENVIRONMENTAL" >> "$GITHUB_ENV"
              echo "TELEMETRY_REASON=SIGILL_DETECTED" >> "$GITHUB_ENV"
              echo ""
              echo "SSOT_GATE2_FAILURE_CLASS=SIGILL_ENVIRONMENTAL"
              echo ""
              echo "=== SIGILL Detected in GitHub-hosted Telemetry (Non-Blocking) ==="
              echo ""
              echo "AUDIT: Gate2 GitHub-hosted telemetry SIGILL detected"
              echo "  CPU flags: $(grep -m1 '^flags' /proc/cpuinfo | cut -d: -f2 | xargs || echo 'unknown')"
              echo "  Swift version: $(swift --version | head -1 || echo 'not available')"
              echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
              echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set}"
              echo "  GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set}"
              echo ""
              echo "Last 50 lines of test output:"
              echo "$TEST_OUTPUT" | tail -50
              echo ""
              echo "‚ö†Ô∏è  This SIGILL confirms GitHub-hosted runner drift."
              echo "‚ö†Ô∏è  Blocking Gate 2 uses self-hosted deterministic executor (unaffected)."
              echo "‚ö†Ô∏è  This telemetry failure does NOT block merges."
              echo "::notice::Gate 2 Linux Telemetry: SIGILL_ENVIRONMENTAL (non-blocking, environmental failure)"
              exit 0  # Always exit 0 in WHITEBOX telemetry
            fi
            echo "TELEMETRY_RESULT=FAIL" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=TEST_FAILURE" >> "$GITHUB_ENV"
            echo ""
            echo "‚ö†Ô∏è  TELEMETRY FAILURE (Non-Blocking)"
            echo "Blocking Gate 2 uses self-hosted deterministic executor (unaffected)."
            echo "::notice::Gate 2 Linux Telemetry: FAILED (non-blocking, test failure)"
            exit 0  # Always exit 0 in WHITEBOX telemetry
          fi
          
          echo ""
          echo "‚úÖ Telemetry passed (non-blocking, GitHub-hosted runner)"
          echo "TELEMETRY_RESULT=PASS" >> "$GITHUB_ENV"
          echo "TELEMETRY_REASON=" >> "$GITHUB_ENV"
          echo "::notice::Gate 2 Linux Telemetry: PASSED (non-blocking)"
      
      - name: Telemetry summary
        if: always()
        run: |
          set -euo pipefail
          TELEMETRY_RESULT="${TELEMETRY_RESULT:-UNKNOWN}"
          TELEMETRY_REASON="${TELEMETRY_REASON:-}"
          echo ""
          echo "üìä Telemetry Summary (WHITEBOX Linux Telemetry)"
          echo "  Job: gate_2_linux_hosted_telemetry"
          echo "  Mode: WHITEBOX (non-blocking)"
          echo "  Result: ${TELEMETRY_RESULT}"
          if [ -n "${TELEMETRY_REASON}" ]; then
            echo "  Reason: ${TELEMETRY_REASON}"
          fi
          echo ""
          case "${TELEMETRY_RESULT}" in
            CANCELLED)
              echo "::notice::Telemetry cancelled: ${TELEMETRY_REASON:-system swift not available}"
              ;;
            PASS)
              echo "::notice::Telemetry passed: All tests completed successfully"
              ;;
            SIGILL_ENVIRONMENTAL)
              echo "::notice::Telemetry SIGILL detected: Environmental failure (non-blocking)"
              ;;
            FAIL)
              echo "::notice::Telemetry failed: ${TELEMETRY_REASON:-test failure} (non-blocking)"
              ;;
            *)
              echo "::notice::Telemetry result: ${TELEMETRY_RESULT} (non-blocking)"
              ;;
          esac
          echo ""
          echo "This job does NOT block merges regardless of outcome (WHITEBOX mode)"
          exit 0  # Always exit 0
      
      - name: Cancellation Notice
        if: ${{ cancelled() }}
        run: |
          set -euo pipefail
          echo "::notice::JOB CANCELED (not a test failure)"
          echo ""
          echo "=== Cancellation Classification ==="
          echo "Status: CANCELLED (superseded by newer run)"
          echo "Classification: Concurrency cancellation (not a test failure)"
          echo ""
          echo "=== Context ==="
          echo "event_name: ${{ github.event_name }}"
          echo "workflow: ${{ github.workflow }}"
          echo "run_id: ${{ github.run_id }}"
          echo "run_attempt: ${{ github.run_attempt }}"
          echo "ref: ${{ github.ref }}"
          echo "head_ref: ${{ github.head_ref }}"
          echo "sha: ${{ github.sha }}"
          echo "pr_number: ${{ github.event.pull_request.number || 'N/A (not a PR)' }}"
          echo ""
          echo "=== Concurrency ==="
          echo "concurrency.group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}"
          echo "SSOT_CONCURRENCY_GROUP: ${{ env.SSOT_CONCURRENCY_GROUP }}"
          echo ""
          echo "=== Note ==="
          echo "This job was cancelled because a newer run started with the same concurrency group."
          echo "This is expected behavior and does NOT indicate a test failure."
          echo "To see test results, check the newer run (run_id: check GitHub Actions UI)"
  
  # Golden Vector Change Detection
  # Fails if golden vectors are modified without proper documentation
  golden_vector_governance:
    name: Golden Vector Governance Check
    runs-on: ubuntu-22.04  # Pinned to prevent runner drift (replaces legacy ubuntu-latest)
    timeout-minutes: 5
    permissions:
      contents: read
      pull-requests: read
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout
        # pinned from v4 (2026-01-24)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Check Golden Vector Changes
        run: |
          set -euo pipefail
          echo "üîí Golden Vector Governance Check"
          echo "Any change to golden vectors must be accompanied by breaking change documentation"
          echo ""
          
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          
          GOLDEN_FILES=(
            "docs/constitution/constants/GOLDEN_VECTORS_ENCODING.json"
            "docs/constitution/constants/GOLDEN_VECTORS_QUANTIZATION.json"
            "docs/constitution/constants/GOLDEN_VECTORS_COLOR.json"
          )
          
          GOLDEN_CHANGED=false
          for file in "${GOLDEN_FILES[@]}"; do
            if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "^$file$"; then
              echo "‚ö†Ô∏è  Golden vector changed: $file"
              GOLDEN_CHANGED=true
            fi
          done
          
          if [ "$GOLDEN_CHANGED" = true ]; then
            echo ""
            echo "Golden vectors are constitutional artifacts. Changes require:"
            echo "  1. Update to BREAKING_CHANGE_SURFACE.json OR"
            echo "  2. Update to MIGRATION_GUIDE.md OR"
            echo "  3. contractVersion bump"
            echo ""
            
            # Check if breaking change documentation exists
            BREAKING_CHANGED=false
            MIGRATION_CHANGED=false
            CONTRACT_VERSION_CHANGED=false
            
            if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "BREAKING_CHANGE_SURFACE.json"; then
              BREAKING_CHANGED=true
            fi
            
            if git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -q "MIGRATION_GUIDE.md"; then
              MIGRATION_CHANGED=true
            fi
            
            if git diff "$BASE_SHA" "$HEAD_SHA" -- Core/Constants/FoundationVersioning.swift | grep -q "CONTRACT_VERSION"; then
              CONTRACT_VERSION_CHANGED=true
            fi
            
            if [ "$BREAKING_CHANGED" = false ] && [ "$MIGRATION_CHANGED" = false ] && [ "$CONTRACT_VERSION_CHANGED" = false ]; then
              echo "‚ùå FAIL: Golden vectors changed without breaking change documentation"
              echo "   Please update BREAKING_CHANGE_SURFACE.json, MIGRATION_GUIDE.md, or bump contractVersion"
              exit 1
            else
              echo "‚úÖ Golden vector change properly documented"
            fi
          else
            echo "‚úÖ No golden vector changes detected"
          fi
  
  # Experimental: Linux Gate 2 with native crypto backend (non-blocking, telemetry only)
  # Purpose: Monitor native crypto stability without blocking main Gate 2
  # Runs only on workflow_dispatch or nightly schedule
  # Isolated: read-only permissions, continue-on-error, no repo modifications
  gate_2_linux_native_crypto_experiment:
    name: Gate 2 ‚Äî Linux Native Crypto Experiment (Non-Blocking Telemetry Only)
    runs-on: ubuntu-22.04
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
    needs: []
    timeout-minutes: 15
    # Least-privilege permissions: read-only, no repo modifications
    permissions:
      contents: read
      pull-requests: read
    # Explicitly non-blocking: failures do not affect merge gates
    continue-on-error: true
    # Experimental: Do NOT set SSOT_PURE_SWIFT_SHA256 (uses native crypto backend)
    # This is for telemetry only - main Gate 2 remains stable with pure Swift backend
    env:
      OPENSSL_ia32cap: ":0"
      # SSOT_PURE_SWIFT_SHA256 intentionally NOT set (experimental native crypto)
    
    strategy:
      fail-fast: false
      matrix:
        build_config: [debug, release]
    
    steps:
      - name: Checkout
        # pinned from v4 (2026-01-24)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Experimental Native Crypto Notice (Non-Blocking Telemetry)
        run: |
          set -euo pipefail
          echo "üî¨ EXPERIMENTAL: Linux Gate 2 with Native Crypto Backend (Non-Blocking Telemetry Only)"
          echo ""
          echo "‚ö†Ô∏è  This is a NON-BLOCKING telemetry job. Failures do NOT block merges."
          echo "‚ö†Ô∏è  This job has read-only permissions and does NOT modify repository files."
          echo ""
          echo "Purpose: Monitor GitHub-hosted runner drift and native crypto backend stability."
          echo "Main Gate 2 uses pure Swift backend (SSOT_PURE_SWIFT_SHA256=1) + GLIBC_TUNABLES + pinned toolchain for stability."
          echo ""
          echo "Environment:"
          echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set (experimental native crypto)}"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo "  GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set (uses GitHub-hosted default for telemetry)}"
          echo ""
      
      - name: Detect system Swift (telemetry)
        shell: bash
        run: |
          set -euo pipefail
          echo "üîç System Swift Detection (WHITEBOX Linux Telemetry)"
          echo ""
          echo "‚ö†Ô∏è  WHITEBOX Linux Telemetry: Using system Swift on GitHub-hosted runner"
          echo "‚ö†Ô∏è  Toolchain pinning is NOT enforced in telemetry lanes (PRODUCTION/self-hosted concern)"
          echo ""
          echo "Environment fingerprint:"
          echo "  runner.os: ubuntu-22.04"
          echo "  uname -a: $(uname -a)"
          echo ""
          if ! command -v swift >/dev/null 2>&1; then
            echo "::notice::Telemetry cancelled: system swift not present on runner"
            echo "TELEMETRY_RESULT=CANCELLED" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=NO_SYSTEM_SWIFT" >> "$GITHUB_ENV"
            echo ""
            echo "Swift location: not found in PATH"
            echo "Swift version: not available"
            echo "Swift compiler version: not available"
            echo ""
            echo "Telemetry job will be cancelled gracefully (exit 0)"
            exit 0
          else
            echo "TELEMETRY_RESULT=RUNNING" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=" >> "$GITHUB_ENV"
            echo ""
            echo "Swift location: $(which swift)"
            echo ""
            echo "Swift version:"
            swift --version || echo "  ‚ö†Ô∏è  swift --version failed"
            echo ""
            echo "Swift compiler version:"
            swiftc --version || echo "  ‚ö†Ô∏è  swiftc --version failed"
            echo ""
            echo "‚úÖ System Swift detected - telemetry will proceed"
          fi
      
      - name: Build (${{ matrix.build_config }})
        if: env.TELEMETRY_RESULT != 'CANCELLED'
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
        run: |
          set -euo pipefail
          echo "Building in ${{ matrix.build_config }} configuration..."
          swift build -c "${{ matrix.build_config }}" || {
            echo "‚ùå Build failed"
            exit 1
          }
      
      - name: Run Gate 2 Tests (Experimental Native Crypto)
        env:
          CONFIGURATION: ${{ matrix.build_config }}
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8
          TZ: UTC
          # Experimental: Do NOT set SSOT_PURE_SWIFT_SHA256 (native crypto backend)
          OPENSSL_ia32cap: ":0"
        run: |
          set -euo pipefail
          echo "üî¨ EXPERIMENTAL: Running Gate 2 tests with native crypto backend"
          echo "OS: ubuntu-22.04, Config: ${{ matrix.build_config }}"
          echo ""
          echo "Environment:"
          echo "  SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set (experimental)}"
          echo "  OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
          echo ""
          
          # Build filter arguments (same as main Gate 2)
          FILTERS=(
            --filter CryptoBackendPolicyTests
            --filter ColorMatrixIntegrityTests
            --filter DomainPrefixesTests
            --filter ReproducibilityBoundaryTests
            --filter BreakingSurfaceTests
            --filter ExplanationCatalogCoverageTests
            --filter ReasonCompatibilityTests
            --filter MinimumExplanationSetTests
            --filter CatalogUniquenessTests
            --filter ExplanationIntegrityTests
            --filter CatalogCrossReferenceTests
            --filter CatalogActionabilityRulesTests
            --filter DomainPrefixesClosureTests
            --filter CryptoShimConsistencyTests
          )
          
          # Run tests with native crypto (no SSOT_PURE_SWIFT_SHA256)
          # WHITEBOX mode: never exit non-zero (always exit 0)
          set +e  # Disable exit on error for WHITEBOX telemetry
          TEST_OUTPUT_FILE="/tmp/gate2_experiment_output.log"
          OPENSSL_ia32cap=:0 swift test -c "${{ matrix.build_config }}" "${FILTERS[@]}" 2>&1 | tee "$TEST_OUTPUT_FILE"
          TEST_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          TEST_OUTPUT=$(cat "$TEST_OUTPUT_FILE" 2>/dev/null || echo "")
          
          # Check for zero tests executed
          TEMP_ZERO_CHECK=$(mktemp)
          echo "$TEST_OUTPUT" > "$TEMP_ZERO_CHECK"
          ZERO_TESTS=0
          if grep -qE "Executed 0 tests|0 tests executed|0 test\(s\)" "$TEMP_ZERO_CHECK"; then
            ZERO_TESTS=1
          fi
          rm -f "$TEMP_ZERO_CHECK"
          
          if [ $ZERO_TESTS -eq 1 ]; then
            echo ""
            echo "::notice::Experimental Telemetry: Zero tests executed (non-blocking, WHITEBOX)"
            echo "TELEMETRY_RESULT=FAIL" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=ZERO_TESTS_EXECUTED" >> "$GITHUB_ENV"
            exit 0  # Always exit 0 in WHITEBOX telemetry
          fi
          
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            # Classify SIGILL explicitly: check output patterns (exit code from pipe not reliable)
            # Use temp file to avoid SIGPIPE from grep -q
            IS_SIGILL=0
            TEMP_EXP_SIGILL_CHECK=$(mktemp)
            echo "$TEST_OUTPUT" > "$TEMP_EXP_SIGILL_CHECK"
            if grep -qE "signal code 4|Illegal instruction|SIGILL|Exited with unexpected signal code 4" "$TEMP_EXP_SIGILL_CHECK"; then
              IS_SIGILL=1
            fi
            rm -f "$TEMP_EXP_SIGILL_CHECK"
            
            if [ $IS_SIGILL -eq 1 ]; then
              echo "TELEMETRY_RESULT=SIGILL_ENVIRONMENTAL" >> "$GITHUB_ENV"
              echo "TELEMETRY_REASON=SIGILL_DETECTED" >> "$GITHUB_ENV"
              echo ""
              echo "SSOT_GATE2_FAILURE_CLASS=SIGILL_ENVIRONMENTAL"
              echo ""
              echo "=== SIGILL Detected in Experimental Native Crypto Lane (Exclusive Classification) ==="
              echo ""
              echo "swift --version:"
              swift --version || echo "  (swift not available)"
              echo ""
              echo "uname -a:"
              uname -a || echo "  (uname not available)"
              echo ""
              echo "CPU flags:"
              grep -m1 '^flags' /proc/cpuinfo || echo "  (cpuinfo not available)"
              echo ""
              echo "SSOT_PURE_SWIFT_SHA256=${SSOT_PURE_SWIFT_SHA256:-not set (experimental)}"
              echo "OPENSSL_ia32cap=${OPENSSL_ia32cap:-not set}"
              echo "GLIBC_TUNABLES=${GLIBC_TUNABLES:-not set (experimental uses GitHub-hosted default)}"
              # Backend policy is enforced by CryptoBackendPolicyTests (runs first in experimental lane)
              echo "Backend policy: Enforced by CryptoBackendPolicyTests (see test output above)"
              echo ""
              echo "Last 50 lines of test output:"
              echo "$TEST_OUTPUT" | tail -50
              echo ""
              echo "‚ö†Ô∏è  Note: Invariants NOT evaluated due to crash"
              echo "‚ö†Ô∏è  This is an environmental failure, NOT an invariant drift."
              echo "‚ö†Ô∏è  SIGILL failures are exclusively environmental and do not indicate test logic failures."
              echo "‚ö†Ô∏è  This is experimental telemetry. Main Gate 2 uses pure Swift backend for stability."
              echo "::notice::Experimental Telemetry: SIGILL_ENVIRONMENTAL (non-blocking, environmental failure)"
              exit 0  # Always exit 0 in WHITEBOX telemetry
            fi
            echo "TELEMETRY_RESULT=FAIL" >> "$GITHUB_ENV"
            echo "TELEMETRY_REASON=TEST_FAILURE" >> "$GITHUB_ENV"
            echo ""
            echo "‚ö†Ô∏è  EXPERIMENTAL TELEMETRY FAILURE (Non-Blocking)"
            echo "This is experimental telemetry. Main Gate 2 uses pure Swift backend for stability."
            echo ""
            echo "If this failure is SIGILL, it confirms native crypto backend instability on GitHub-hosted runners."
            echo "Main Gate 2 (with pure Swift backend) remains stable and blocking."
            echo ""
            echo "‚úÖ This failure does NOT block merges. Main Gate 2 (pure Swift backend) is unaffected."
            echo "‚úÖ This job has continue-on-error: true and read-only permissions."
            echo "::notice::Experimental Telemetry: FAILED (non-blocking, test failure)"
            exit 0  # Always exit 0 in WHITEBOX telemetry
          fi
          
          echo ""
          echo "‚úÖ Experimental native crypto test passed (telemetry only, non-blocking)"
          echo "TELEMETRY_RESULT=PASS" >> "$GITHUB_ENV"
          echo "TELEMETRY_REASON=" >> "$GITHUB_ENV"
          echo "::notice::Experimental Telemetry: PASSED (non-blocking)"
      
      - name: Telemetry summary
        if: always()
        run: |
          set -euo pipefail
          TELEMETRY_RESULT="${TELEMETRY_RESULT:-UNKNOWN}"
          TELEMETRY_REASON="${TELEMETRY_REASON:-}"
          echo ""
          echo "üìä Telemetry Summary (WHITEBOX Linux Telemetry - Experimental)"
          echo "  Job: gate_2_linux_native_crypto_experiment"
          echo "  Mode: WHITEBOX (non-blocking, experimental)"
          echo "  Result: ${TELEMETRY_RESULT}"
          if [ -n "${TELEMETRY_REASON}" ]; then
            echo "  Reason: ${TELEMETRY_REASON}"
          fi
          echo ""
          case "${TELEMETRY_RESULT}" in
            CANCELLED)
              echo "::notice::Telemetry cancelled: ${TELEMETRY_REASON:-system swift not available}"
              ;;
            PASS)
              echo "::notice::Telemetry passed: All tests completed successfully"
              ;;
            SIGILL_ENVIRONMENTAL)
              echo "::notice::Telemetry SIGILL detected: Environmental failure (non-blocking)"
              ;;
            FAIL)
              echo "::notice::Telemetry failed: ${TELEMETRY_REASON:-test failure} (non-blocking)"
              ;;
            *)
              echo "::notice::Telemetry result: ${TELEMETRY_RESULT} (non-blocking)"
              ;;
          esac
          echo ""
          echo "This job does NOT block merges regardless of outcome (WHITEBOX mode, experimental)"
          exit 0  # Always exit 0


  # SSOT Check Gate ‚Äî Single Entrypoint (macOS)
  # Uses scripts/ssot_check.sh as the single source of verification
  # Replaces ad-hoc checks with unified script
  ssot_check_macos:
    name: SSOT Check (macOS)
    runs-on: macos-14
    needs: [gate_0_workflow_lint]
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: read
    
    steps:
      - name: Checkout
        # pinned from v4 (2026-01-25)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Setup Swift
        # pinned from v2 (2026-01-25)
        uses: swift-actions/setup-swift@7ca6abe6b3b0e8b5421b88be48feee39cbf52c6a
        with:
          swift-version: "6.0"
      
      - name: Run SSOT Check
        run: |
          set -euo pipefail
          export SSOT_SKIP_TESTS=1
          export SKIP_TESTS=1
          echo "üîí SSOT Check (macOS) ‚Äî Single Entrypoint"
          echo "Running: ./scripts/ssot_check.sh"
          echo ""
          chmod +x scripts/ssot_check.sh
          ./scripts/ssot_check.sh || {
            echo ""
            echo "‚ùå SSOT Check FAILED"
            echo "Review failures above and run: ./scripts/ssot_check.sh"
            exit 1
          }
      
      - name: Upload SSOT Diff Report
        if: always()
        # pinned from v4 (2026-01-25)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ssot-diff-report-macos
          path: artifacts/ssot_diff_report.md
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Upload Golden File
        if: always()
        # pinned from v4 (2026-01-25)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: golden-policy-digests-macos
          path: Tests/Golden/policy_digests.json
          if-no-files-found: ignore
          retention-days: 30

  # SSOT Check Gate ‚Äî Single Entrypoint (Linux)
  # Uses scripts/ssot_check.sh as the single source of verification
  # Verifies golden determinism (5 runs match) and cross-platform consistency
  ssot_check_linux:
    name: SSOT Check (Linux)
    runs-on: ubuntu-22.04
    needs: [gate_linux_preflight_only]
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: read
    
    env:
      OPENSSL_ia32cap: ":0"
    
    steps:
      - name: Checkout
        # pinned from v4 (2026-01-25)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
        with:
          fetch-depth: 0
      
      - name: Setup Swift
        # pinned from v2 (2026-01-25)
        uses: swift-actions/setup-swift@7ca6abe6b3b0e8b5421b88be48feee39cbf52c6a
        with:
          swift-version: "6.0"
      
      - name: Run SSOT Check
        env:
          OPENSSL_ia32cap: ":0"
        run: |
          set -euo pipefail
          export SSOT_SKIP_TESTS=1
          export SKIP_TESTS=1
          echo "üîí SSOT Check (Linux) ‚Äî Single Entrypoint"
          echo "Running: ./scripts/ssot_check.sh"
          echo "This includes golden determinism verification (5 runs match)"
          echo ""
          chmod +x scripts/ssot_check.sh
          ./scripts/ssot_check.sh || {
            echo ""
            echo "‚ùå SSOT Check FAILED"
            echo "Review failures above and run: ./scripts/ssot_check.sh"
            exit 1
          }
      
      - name: Verify Golden Cross-Platform Consistency
        run: |
          set -euo pipefail
          echo "üîç Verifying golden file cross-platform consistency"
          echo "Regenerating golden in temp dir and comparing byte-for-byte..."
          
          TEMP_DIR=$(mktemp -d)
          trap "rm -rf $TEMP_DIR" EXIT
          
          # Build UpdateGoldenDigests
          swift build --product UpdateGoldenDigests -c release
          
          # Generate golden in temp dir
          "$(swift build -c release --show-bin-path)/UpdateGoldenDigests" > "$TEMP_DIR/new_golden.json" 2>&1 || {
            echo "‚ùå Failed to regenerate golden file"
            exit 1
          }
          
          # Compare with existing golden
          if diff -q Tests/Golden/policy_digests.json "$TEMP_DIR/new_golden.json" >/dev/null 2>&1; then
            echo "‚úÖ Golden file is byte-for-byte consistent (Linux regeneration matches)"
          else
            echo "‚ùå Golden file mismatch: Linux regeneration differs from committed version"
            echo "Diff:"
            diff -u Tests/Golden/policy_digests.json "$TEMP_DIR/new_golden.json" | head -50
            exit 1
          fi
      
      - name: Upload SSOT Diff Report
        if: always()
        # pinned from v4 (2026-01-25)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: ssot-diff-report-linux
          path: artifacts/ssot_diff_report.md
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Upload Golden File
        if: always()
        # pinned from v4 (2026-01-25)
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: golden-policy-digests-linux
          path: Tests/Golden/policy_digests.json
          if-no-files-found: ignore
          retention-days: 30

  # iOS Compile Gate
  # Compile-only check to ensure iOS targets don't pull in CLI-only code
  # UpdateGoldenDigests and tooling must be isolated to non-iOS targets
  ios_compile_gate:
    name: iOS Compile Gate
    runs-on: macos-14
    needs: [gate_0_workflow_lint]
    timeout-minutes: 10
    permissions:
      contents: read
    
    steps:
      - name: Init iOS build log path (GITHUB_ENV)
        shell: bash
        run: |
          set -euo pipefail
          IOS_BUILD_LOG="${RUNNER_TEMP:-/tmp}/ios_build.log"
          echo "IOS_BUILD_LOG=$IOS_BUILD_LOG" >> "$GITHUB_ENV"
          : > "$IOS_BUILD_LOG"
      - name: Checkout
        # pinned from v4 (2026-01-25)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5
      
      
      - name: Verify iOS Target Isolation
        shell: bash
        run: |
          set -euo pipefail
          : "${IOS_BUILD_LOG:=${RUNNER_TEMP:-/tmp}/ios_build.log}"
          echo "üîí iOS Compile Gate ‚Äî Verify Target Isolation"
          echo "Checking that UpdateGoldenDigests/tooling is isolated from targets"
          echo ""
          
          # Structural guard: tooling must not be iOS-targeted
          if grep -q "UpdateGoldenDigests" Package.swift; then
            echo "Checking UpdateGoldenDigests target configuration..."
            if grep -A 40 "UpdateGoldenDigests" Package.swift | grep -Eqi "\.iOS\b|\biOS\b"; then
              echo "‚ùå UpdateGoldenDigests must not target iOS"
              exit 1
            fi
            echo "‚úÖ UpdateGoldenDigests is not targeting iOS"
          fi
          
          echo ""
          echo "Attempting iOS simulator compile (best-effort, Apple toolchain)..."
          
          if command -v xcrun >/dev/null 2>&1; then
            SDK_PATH="$(xcrun --sdk iphonesimulator --show-sdk-path 2>/dev/null || true)"
            if [ -n "${SDK_PATH:-}" ]; then
              D_LOG="/tmp/ios_build.log"
          
              set +e
              xcrun --sdk iphonesimulator swift build -c release \
                --triple arm64-apple-ios-simulator \
                --product Aether3DCore 2>&1 | tee "$IOS_BUILD_LOG"
              rc=${PIPESTATUS[0]}
              set -e
          
              if [ "$rc" -eq 0 ]; then
                echo "‚úÖ iOS simulator compile succeeded (Aether3DCore)"
              else
                # Env/SDK/toolchain mismatch: downgrade to structure-only (non-blocking)
                if grep -Eqi "Invalid manifest|using sysroot.*iPhoneSimulator.*targeting.*MacOSX|unable to load standard library|SDK.*not.*found|simulator.*not.*found|xcrun: error|toolchain" "$IOS_BUILD_LOG"; then
                  echo "‚ö†Ô∏è iOS compile could not run reliably in this CI environment"
                  echo "Proceeding with structure-only validation (non-blocking)"
                else
                  echo "‚ùå iOS compile failed (code-level incompatibility)"
                  echo "Build log (last 80 lines):"
                  tail -80 "$IOS_BUILD_LOG" || true
                  exit 1
                fi
              fi
            else
              echo "‚ö†Ô∏è iOS SDK not available in this CI environment"
              echo "Proceeding with structure-only validation"
            fi
          else
            echo "‚ö†Ô∏è xcrun not available in this CI environment"
            echo "Proceeding with structure-only validation"
          fi
