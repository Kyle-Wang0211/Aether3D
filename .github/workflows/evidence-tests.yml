name: Evidence System Tests

on:
  push:
    paths:
      - 'Core/Evidence/**'
      - 'Tests/Evidence/**'
      - 'Scripts/ForbiddenPatternLint.swift'
      - '.github/workflows/evidence-tests.yml'
  pull_request:
    paths:
      - 'Core/Evidence/**'
      - 'Tests/Evidence/**'
      - 'Scripts/ForbiddenPatternLint.swift'
      - '.github/workflows/evidence-tests.yml'

jobs:
  behavior-lock-tests:
    runs-on: macos-15
    # Note: macOS runner uses Xcode's built-in Swift, no setup-swift needed
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          # Use Xcode 16.x for Swift 5.9+ compatibility
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          swift --version

      - name: Build
        run: swift build

      - name: Run Forbidden Pattern Lint
        run: |
          swift Scripts/ForbiddenPatternLint.swift .
        continue-on-error: false

      - name: Run Behavior Lock Tests
        run: swift test --filter "GoldenFixtureTests"

      - name: Run Deterministic Encoding Tests
        run: swift test --filter "DeterministicEncodingTests"

      - name: Run Forbidden Pattern Lint Tests
        run: swift test --filter "ForbiddenPatternLintTests"

      - name: Run End-to-End Integration Tests
        run: swift test --filter "EvidenceEndToEndDeterminismTests|EvidenceAdmissionThroughputTests|EvidenceDisplayMonotonicityTests|EvidenceDeltaSemanticsTests|EvidenceOutOfOrderTests"

      - name: Run All PR2 Evidence Tests
        run: swift test --filter "PatchEvidenceMapTests|DynamicWeightsTests|PatchDisplayMapTests|TokenBucketLimiterTests|ViewDiversityTrackerTests|EnumUnknownHandlingTests|EvidenceObservabilityTests|EvidenceReplayTests|EvidenceHealthRedlineTests"

      - name: Run PR3 Gate Tests
        # Note: Use Aether3DCoreTests prefix to avoid matching SSOTGateIntegrationTests
        run: swift test --filter "HardGatesV13Tests|EvidenceVector3Tests|GateGainFunctionsTests|GateCoverageTrackerTests|GateInputValidatorTests|PR3InternalQualityTests|SmartAntiBoostSmootherTests|GateDeterminismTests|Aether3DCoreTests.GateIntegrationTests"

      - name: Run PR3 Math Tests
        run: swift test --filter "PRMathTests|StableLogisticTests|QuantizerQ01Tests|QuantizerAngleTests|ZeroTrigPhiBucketingTests|ZeroTrigThetaBucketingTests|ThetaBucketBitsetTests|PhiBucketBitsetTests|CircularSpanBitsetTests"

      - name: Run PR3 Golden Tests (Double Backend Only)
        run: swift test --filter "GateGoldenTests"
        continue-on-error: false

      - name: Run PR3 Fast Backend Error Bounds Tests
        run: swift test --filter "GateFastBackendTests"
        continue-on-error: false

      - name: Run PR3 Performance Benchmarks
        run: swift test --filter "GatePerformanceBenchmarks"
        continue-on-error: true  # Benchmarks may be flaky

      - name: Fail on Golden Mismatch
        if: failure()
        run: |
          echo "::error::Behavior lock test failed. Golden fixture mismatch detected."
          echo "::error::If this change is intentional, update golden fixtures with:"
          echo "::error::  swift test --filter UpdateGoldenFixtures"
          exit 1

  cross-platform-consistency:
    runs-on: ubuntu-22.04
    # Note: ubuntu-22.04 is pinned because setup-swift@v1 does not support ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Import Swift GPG key
        run: |
          set -euo pipefail
          for i in 1 2 3; do
            if curl -fsSL --compressed --retry 3 --retry-delay 5 https://swift.org/keys/all-keys.asc | gpg --import - 2>&1; then
              echo "✅ Swift GPG key imported successfully"
              exit 0
            fi
            echo "⚠️ Attempt $i failed, retrying in 5s..."
            sleep 5
          done
          echo "❌ Failed to import Swift GPG key after 3 attempts"
          exit 1

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            binutils git unzip gnupg2 libc6-dev libcurl4-openssl-dev \
            libedit2 libgcc-11-dev libpython3-dev libsqlite3-0 \
            libstdc++-11-dev libxml2-dev libz3-dev pkg-config tzdata \
            zlib1g-dev libsqlite3-dev

      - name: Setup Swift
        run: |
          set -euo pipefail
          SWIFT_VERSION="6.2.3"
          SWIFT_PLATFORM="ubuntu22.04"
          SWIFT_TARBALL="swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}.tar.gz"
          SWIFT_URL="https://download.swift.org/swift-${SWIFT_VERSION}-release/ubuntu2204/swift-${SWIFT_VERSION}-RELEASE/${SWIFT_TARBALL}"
          echo "Downloading Swift ${SWIFT_VERSION}..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}" -o "/tmp/${SWIFT_TARBALL}"
          echo "Verifying GPG signature..."
          curl -fsSL --retry 3 --retry-delay 5 "${SWIFT_URL}.sig" -o "/tmp/${SWIFT_TARBALL}.sig"
          gpg --verify "/tmp/${SWIFT_TARBALL}.sig" "/tmp/${SWIFT_TARBALL}" || echo "⚠️ GPG verification failed (non-fatal)"
          echo "Extracting Swift toolchain..."
          sudo tar -xzf "/tmp/${SWIFT_TARBALL}" -C /opt
          SWIFT_PATH="/opt/swift-${SWIFT_VERSION}-RELEASE-${SWIFT_PLATFORM}/usr/bin"
          echo "${SWIFT_PATH}" >> $GITHUB_PATH
          export PATH="${SWIFT_PATH}:${PATH}"
          echo "✅ Swift ${SWIFT_VERSION} installed"
          swift --version

      - name: Build
        run: swift build

      - name: Run Cross-Platform Tests
        run: swift test --filter "CrossPlatformTestUtils|DeterministicEncodingTests|EvidenceEndToEndDeterminismTests"

      - name: Run PR3 Cross-Platform Consistency Tests
        run: swift test --filter "GateDeterminismTests|GateGoldenTests|ZeroTrigPhiBucketingTests|ZeroTrigThetaBucketingTests"
