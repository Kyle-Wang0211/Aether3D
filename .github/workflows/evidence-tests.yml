name: Evidence System Tests

on:
  push:
    paths:
      - 'Core/Evidence/**'
      - 'Tests/Evidence/**'
      - 'Scripts/ForbiddenPatternLint.swift'
      - '.github/workflows/evidence-tests.yml'
  pull_request:
    paths:
      - 'Core/Evidence/**'
      - 'Tests/Evidence/**'
      - 'Scripts/ForbiddenPatternLint.swift'
      - '.github/workflows/evidence-tests.yml'

jobs:
  behavior-lock-tests:
    runs-on: macos-15
    # Note: macOS runner uses Xcode's built-in Swift, no setup-swift needed
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          # Use Xcode 16.x for Swift 5.9+ compatibility
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer || \
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          swift --version

      - name: Build
        run: swift build

      - name: Run Forbidden Pattern Lint
        run: |
          swift Scripts/ForbiddenPatternLint.swift .
        continue-on-error: false

      - name: Run Behavior Lock Tests
        run: swift test --filter "GoldenFixtureTests"

      - name: Run Deterministic Encoding Tests
        run: swift test --filter "DeterministicEncodingTests"

      - name: Run Forbidden Pattern Lint Tests
        run: swift test --filter "ForbiddenPatternLintTests"

      - name: Run End-to-End Integration Tests
        run: swift test --filter "EvidenceEndToEndDeterminismTests|EvidenceAdmissionThroughputTests|EvidenceDisplayMonotonicityTests|EvidenceDeltaSemanticsTests|EvidenceOutOfOrderTests"

      - name: Run All PR2 Evidence Tests
        run: swift test --filter "PatchEvidenceMapTests|DynamicWeightsTests|PatchDisplayMapTests|TokenBucketLimiterTests|ViewDiversityTrackerTests|EnumUnknownHandlingTests|EvidenceObservabilityTests|EvidenceReplayTests|EvidenceHealthRedlineTests"

      - name: Fail on Golden Mismatch
        if: failure()
        run: |
          echo "::error::Behavior lock test failed. Golden fixture mismatch detected."
          echo "::error::If this change is intentional, update golden fixtures with:"
          echo "::error::  swift test --filter UpdateGoldenFixtures"
          exit 1

  cross-platform-consistency:
    runs-on: ubuntu-22.04
    # Note: ubuntu-22.04 is pinned because setup-swift@v1 does not support ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "5.9"
          skip-verify-signature: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlite3-dev pkg-config

      - name: Build
        run: swift build

      - name: Run Cross-Platform Tests
        run: swift test --filter "CrossPlatformTestUtils|DeterministicEncodingTests|EvidenceEndToEndDeterminismTests"
