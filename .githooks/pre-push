#!/usr/bin/env bash
# Git pre-push hook for PR1 PIZ Detection
# This hook runs the PIZ local gate before allowing a push.
#
# To install: bash scripts/dev/install-githooks.sh
# To bypass: git push --no-verify (not recommended)

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

# Check if we're on a PR1 branch
CURRENT_BRANCH=$(git branch --show-current 2>/dev/null || echo "")
if [[ "$CURRENT_BRANCH" == pr1* ]] || [[ "$CURRENT_BRANCH" == *pr1* ]]; then
    echo "ðŸ”’ PR1 branch detected: $CURRENT_BRANCH"
    echo "Running PIZ local pre-push gate..."
    echo ""
    
    cd "$REPO_ROOT"
    
    if ! bash scripts/ci/piz_local_gate.sh; then
        echo ""
        echo "[PIZ_PUSH_BLOCKED] local gate failed; refusing push"
        exit 1
    fi
    
    echo ""
    echo "âœ… Pre-push gate passed. Proceeding with push..."
fi

exit 0
