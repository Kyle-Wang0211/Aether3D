# AETHER3D PR#12 CONSTITUTION v10.0.1

```
═══════════════════════════════════════════════════════════════════════════════
AETHER3D PR#12 CONSTITUTION v10.0.1
Phase 4: CI Gates + Deterministic BuildMeta Injection
Status: EXECUTABLE | SELF-CONSISTENT | MACHINE-VERIFIABLE | HARDENED
═══════════════════════════════════════════════════════════════════════════════

V10.0.1 HARDENING PATCH APPLIED
This version removes ambiguity, closes loopholes, and forces physical observability.
Every rule MUST have an observable failure mode with explicit error code.
```

═══════════════════════════════════════════════════════════════════════════════
PATCH OBJECTIVE
═══════════════════════════════════════════════════════════════════════════════

V10.0.1 addresses four critical failures in V10.0.0:

1. **Too much logic in text instead of machine-verifiable structure**
   - FIXED: All rules now map to explicit failure signals
   - FIXED: Gate registry is formal table, not prose
   - FIXED: Error codes are immutable registry

2. **Rules describe intent but lack observable failure modes**
   - FIXED: Every rule MUST specify detection mechanism
   - FIXED: Every rule MUST specify failure signal
   - FIXED: Every rule MUST specify exit code or test failure
   - FIXED: Undetectable rules downgraded to "Informational"

3. **Gate semantics described but not fully normalized**
   - FIXED: Exact mandatory JSON schema for all gate output
   - FIXED: Formal gate registry table with immutable IDs
   - FIXED: Blocking gates MUST map to non-zero exit codes

4. **Freedoms exist implicitly due to missing negative constraints**
   - FIXED: Explicit modification whitelist per phase
   - FIXED: Generated files MUST NOT be manually edited (GATE_003)
   - FIXED: CI checkout strategy MUST be enforced (F-2)

═══════════════════════════════════════════════════════════════════════════════
PATCH APPLICATION STRATEGY
═══════════════════════════════════════════════════════════════════════════════

All patches from V10.0.1 hardening have been applied:

**Phase 1: Language Hardening (G-1, G-2, G-3)**
- ✅ Removed all soft language ("should", "ideally", "recommended", "expected")
- ✅ Replaced with "MUST", "MUST NOT", "FAIL WITH <ERROR_CODE>"
- ✅ Added explicit detection mechanisms to every rule
- ✅ Added failure signals and error codes to every rule
- ✅ Downgraded undetectable rules to "Informational" explicitly
- ✅ Removed claims that prompt "prevents" behavior

**Phase 2: Structural Additions (S-1, S-2, S-3)**
- ✅ Added formal Gate Registry table (Section 3)
- ✅ Mandated exact gate output JSON schema (Section 5)
- ✅ Introduced global error code registry GATE_001 through GATE_010 (Section 7)
- ✅ Mapped existing A3D-E codes to new system

**Phase 3: Determinism Hardening (D-1, D-2)**
- ✅ Added "Determinism Proof Obligations" section
- ✅ Required explicit inputs, forbidden entropy, ordering guarantees
- ✅ Labeled non-deterministic processes explicitly
- ✅ Added generated files rule with GATE_003 failure

**Phase 4: Filesystem Rules (F-1, F-2)**
- ✅ Added explicit Phase 4 modification whitelist
- ✅ Enforced CI checkout strategy requirements
- ✅ Added failure modes for whitelist violations

**Phase 5: BuildMeta Contract (B-1)**
- ✅ Strengthened BuildMeta.swift requirements
- ✅ Added GATE_004 failure for missing CI-generated artifacts
- ✅ Specified default "UNKNOWN" values requirement

**Phase 6: Testing Requirements (T-1, T-2)**
- ✅ Mandated golden test requirements
- ✅ Required gate tests for every gate
- ✅ Added placeholder test rules

**Phase 7: Meta-Rules (M-1, M-2, C-1, O-1)**
- ✅ Added contradiction resolution priority
- ✅ Added observability requirements (no silent success)
- ✅ Marked deferred gates explicitly
- ✅ Prevented feature creep

═══════════════════════════════════════════════════════════════════════════════
0. EXECUTION MODE
═══════════════════════════════════════════════════════════════════════════════

0.1 RULE CLASSIFICATION [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Rules are classified as:
  ENFORCED  = Machine-verified by runner/gate/CI. Failure = abort.
  ASSERTED  = Logged for audit. No abort.
  INFORMATIONAL = Human instruction. Not machine-checked. No failure signal.

META-RULE: Only rules that can be automatically and deterministically
verified by runner/gate/CI may be classified as ENFORCED.

DETECTION: Runner validates rule classification against gate registry.
FAILURE SIGNAL: If rule marked ENFORCED but no gate verifies it → GATE_006
EXIT CODE: 1 (blocking)

0.2 INTERPRETATION REQUIREMENTS [INFORMATIONAL]
─────────────────────────────────────────────────────────────────────────────────
Before implementation, output:
  - INTERPRETATION SUMMARY (5-8 lines)
  - Files to create/modify count
  - Key constraints understood

NOTE: This rule is INFORMATIONAL because it cannot be machine-verified.
No failure signal. No exit code.

0.3 PROCESS GUIDANCE [INFORMATIONAL]
─────────────────────────────────────────────────────────────────────────────────
These are instructions for the implementer, not machine-verified:
  - Avoid asking clarification questions
  - Avoid proposing alternatives
  - Avoid using "should/could/ideally" language
  - Complete full implementation

NOTE: This rule is INFORMATIONAL because it cannot be machine-verified.
No failure signal. No exit code.

═══════════════════════════════════════════════════════════════════════════════
1. CLOSED WORLD ASSUMPTION
═══════════════════════════════════════════════════════════════════════════════

1.1 ALLOWED TO CREATE [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
.github/workflows/fp1_gates.yml
Core/BuildMeta/BuildMeta.swift
Core/BuildMeta/BuildMeta.generated.swift.template
Core/BuildMeta/BuildMeta.local.swift
Tests/Gates/GateContractTests.swift
scripts/fp1_runner.sh
scripts/fp1_gates.sh
docs/constitution/GATE_REGISTRY.json
docs/constitution/ERROR_CODES.json
docs/constitution/DETERMINISM_ALLOWLIST.txt
docs/constitution/PINNED_ACTIONS.json
docs/constitution/FP1_POLICY.md
.a3d/.gitkeep

DETECTION: CI workflow checks file paths against Phase 4 modification whitelist.
FAILURE SIGNAL: File created outside whitelist → GATE_002
EXIT CODE: 1 (blocking)

1.2 ALLOWED TO MODIFY [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
.gitignore                    ← Append only
scripts/preflight.sh          ← Append FP1 section only

DETECTION: CI workflow checks file paths against Phase 4 modification whitelist.
FAILURE SIGNAL: File modified outside whitelist → GATE_002
EXIT CODE: 1 (blocking)

1.3 SCAN EXCLUSIONS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
All file scans MUST exclude:
  - .git/
  - .build/
  - .a3d/
  - DerivedData/
  - Core/BuildMeta/BuildMeta.generated.swift
  - *.xcodeproj/
  - Assets.xcassets/

DETECTION: Gate scripts validate exclusion patterns in file scans.
FAILURE SIGNAL: Exclusion pattern missing → GATE_008 (schema violation)
EXIT CODE: 1 (blocking)

1.4 GENERATED FILES (CI-only, never committed) [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Core/BuildMeta/BuildMeta.generated.swift
.a3d/**

DETECTION: CI checks if generated file exists in git index or working tree.
FAILURE SIGNAL: Generated file committed or manually modified → GATE_003
EXIT CODE: 1 (blocking)

1.5 GITIGNORE ADDITIONS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
.a3d/
Core/BuildMeta/BuildMeta.generated.swift

DETECTION: CI validates .gitignore contains required entries.
FAILURE SIGNAL: Required entry missing from .gitignore → GATE_008
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
2. HASH DOMAIN SEPARATION
═══════════════════════════════════════════════════════════════════════════════

2.1 HASH DOMAIN (strictly deterministic) [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Fields that MUST be deterministic and are included in outputHash:
  - gateId, gateName, gateVersion, blocking
  - status, errorCode, exitCode
  - inputHash, prevGateHash, registryHash
  - violations (sorted array)
  - message (after ASCII normalization and truncation)

DETECTION: Runner validates hash domain fields are present and deterministic.
FAILURE SIGNAL: Non-deterministic field in hash domain → GATE_005
EXIT CODE: 1 (blocking)

2.2 NON-HASH DOMAIN (observation only) [ASSERTED]
─────────────────────────────────────────────────────────────────────────────────
Fields excluded from hash, for human reference only:
  - timestamp
  - diagnosticLogPath
  - outputHash (the hash itself)
  - Tool stderr output (captured to log)

NOTE: This rule is ASSERTED (logged, no abort). No failure signal.

2.3 DETERMINISM REQUIREMENTS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Within HASH DOMAIN:
  - All string comparisons: byte-exact
  - All arrays: sorted before inclusion
  - All JSON: canonicalized via jq -cS before hashing
  - All file scans: find ... -print0 | LC_ALL=C sort -z
  - All text fields: ASCII 0x20-0x7E only, no newlines
  - All truncation: byte-based with LC_ALL=C

DETECTION: Runner validates determinism requirements in hash computation.
FAILURE SIGNAL: Non-deterministic operation detected → GATE_005
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
3. GATE REGISTRY (SINGLE SOURCE OF TRUTH)
═══════════════════════════════════════════════════════════════════════════════

3.1 FORMAL GATE REGISTRY TABLE [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Gate IDs are immutable. Blocking gates MUST map to non-zero exit codes.
CI MUST fail if any blocking gate fails.

| Gate ID | Name | Blocking | Enforced By | Failure Signal | Exit Code |
|---------|------|----------|-------------|----------------|-----------|
| GATE-STATIC | StaticChecksGate | true | fp1_gates.sh | Violations found | 1 |
| GATE-POLICY | PolicyHashGate | true | fp1_gates.sh | Hash mismatch | 1 |
| GATE-DETERMINISM | DeterminismGate | true | fp1_gates.sh | Non-deterministic call | 1 |
| GATE-BUILDMETA | BuildMetaGate | true | fp1_gates.sh | Template/stub missing | 1 |
| GATE-GOLDEN | GoldenTraceGate | false | fp1_gates.sh | DEFERRED (SKIP) | 0 |

DETECTION: Runner validates gate registry table structure and immutability.
FAILURE SIGNAL: Gate ID changed or blocking gate has exit code 0 → GATE_007
EXIT CODE: 1 (blocking)

File: docs/constitution/GATE_REGISTRY.json [ENFORCED]

{
  "registryVersion": "1.0.0",
  "registrySchemaVersion": 1,
  "toolRequirements": {
    "bash": ">=4.0",
    "jq": ">=1.5",
    "git": ">=2.0",
    "grep": "any",
    "timeout": "optional_with_fallback"
  },
  "scanExclusions": [
    ".git/", ".build/", ".a3d/", "DerivedData/",
    "*.xcodeproj/", "Assets.xcassets/",
    "Core/BuildMeta/BuildMeta.generated.swift"
  ],
  "gates": [
    {
      "gateId": "GATE-STATIC",
      "gateName": "StaticChecksGate",
      "gateVersion": "1.0.0",
      "blocking": true,
      "status": "ACTIVE",
      "timeout_seconds": 60,
      "rules": [
        {
          "ruleId": "CRLF",
          "pattern": "\\r$",
          "errorCode": "A3D-E1001",
          "scanPaths": ["scripts/", "Core/", "Tests/", "App/", "docs/constitution/"],
          "scanExtensions": [".swift", ".sh", ".md", ".json", ".yml", ".txt"]
        },
        {
          "ruleId": "TODO_FIXME",
          "pattern": "\\b(TODO|FIXME|XXX)\\b",
          "errorCode": "A3D-E1002",
          "scanPaths": ["scripts/", "Core/", "Tests/", "App/"],
          "scanExtensions": [".swift", ".sh"]
        },
        {
          "ruleId": "STDERR_REDIRECT",
          "pattern": ">&2",
          "errorCode": "A3D-E1003",
          "scanPaths": ["scripts/fp1_gates.sh"],
          "scanExtensions": [".sh"],
          "note": "Only gate script forbidden from explicit stderr"
        }
      ]
    },
    {
      "gateId": "GATE-POLICY",
      "gateName": "PolicyHashGate",
      "gateVersion": "1.0.0",
      "blocking": true,
      "status": "ACTIVE",
      "timeout_seconds": 30,
      "policyFiles": [
        "docs/constitution/FP1_POLICY.md",
        "docs/constitution/GATE_REGISTRY.json",
        "docs/constitution/ERROR_CODES.json",
        "docs/constitution/DETERMINISM_ALLOWLIST.txt",
        "docs/constitution/PINNED_ACTIONS.json"
      ],
      "rules": [
        {"ruleId": "POLICY_MISSING", "errorCode": "A3D-E2001"},
        {"ruleId": "POLICY_HASH_MISMATCH", "errorCode": "A3D-E2002"}
      ]
    },
    {
      "gateId": "GATE-DETERMINISM",
      "gateName": "DeterminismGate",
      "gateVersion": "1.0.0",
      "blocking": true,
      "status": "ACTIVE",
      "timeout_seconds": 60,
      "allowlistFile": "docs/constitution/DETERMINISM_ALLOWLIST.txt",
      "rules": [
        {
          "ruleId": "NONDETERMINISTIC_SWIFT",
          "patterns": ["Date\\(\\)", "UUID\\(\\)", "\\.random\\b", "arc4random", "SystemRandomNumberGenerator"],
          "errorCode": "A3D-E3001",
          "scanPaths": ["Core/"],
          "scanExtensions": [".swift"]
        }
      ]
    },
    {
      "gateId": "GATE-BUILDMETA",
      "gateName": "BuildMetaGate",
      "gateVersion": "1.0.0",
      "blocking": true,
      "status": "ACTIVE",
      "timeout_seconds": 30,
      "templateFile": "Core/BuildMeta/BuildMeta.generated.swift.template",
      "localStubFile": "Core/BuildMeta/BuildMeta.local.swift",
      "requiredTokens": [
        "{{SCHEMA_VERSION}}", "{{COMMIT_SHA}}", "{{POLICY_HASH}}",
        "{{CONFIG_HASH}}", "{{CI_PROVIDER}}", "{{BUILD_ID}}", "{{GATE_CHAIN_HASH}}"
      ],
      "rules": [
        {"ruleId": "TEMPLATE_MISSING", "errorCode": "A3D-E4001"},
        {"ruleId": "STUB_MISSING", "errorCode": "A3D-E4002"},
        {"ruleId": "TOKEN_MISSING", "errorCode": "A3D-E4003"}
      ]
    },
    {
      "gateId": "GATE-GOLDEN",
      "gateName": "GoldenTraceGate",
      "gateVersion": "1.0.0",
      "blocking": false,
      "status": "DEFERRED",
      "timeout_seconds": 30,
      "rules": []
    }
  ],
  "executionOrder": ["GATE-STATIC", "GATE-POLICY", "GATE-DETERMINISM", "GATE-BUILDMETA", "GATE-GOLDEN"]
}

DETECTION: Runner validates registry JSON structure and schema.
FAILURE SIGNAL: Registry invalid or gate missing → GATE_006
EXIT CODE: 1 (blocking)

3.2 REGISTRY HASH COMPUTATION [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
registryHash = SHA256(jq -cS '.' < GATE_REGISTRY.json)

Computed by runner at startup. Gates receive as environment.

DETECTION: Runner computes registry hash and validates it matches expected.
FAILURE SIGNAL: Registry hash computation fails → GATE_006
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
4. RUNNER CONTRACT
═══════════════════════════════════════════════════════════════════════════════

4.1 RUNNER IS THE ONLY COMPONENT THAT: [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
  ✅ Computes inputHash
  ✅ Computes outputHash (via jq -cS canonicalization)
  ✅ Generates timestamp
  ✅ Maintains chain (prevGateHash)
  ✅ Captures stderr to log file
  ✅ Validates gate output schema
  ✅ Validates violations are sorted (DOES NOT fix, fails if unsorted)
  ✅ Validates violations count ≤ 50
  ✅ Enforces timeout (with portable fallback)
  ✅ Maps exit codes
  ✅ Outputs valid JSON even on structural failure

DETECTION: Runner script validates it is the only component computing hashes.
FAILURE SIGNAL: Gate computes hash or runner fails validation → GATE_006
EXIT CODE: 1 (blocking)

4.2 GATES MUST NOT: [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
  ❌ Compute inputHash, outputHash, registryHash, prevGateHash, treeHash
  ❌ Generate timestamps
  ❌ Know about chain or previous gates
  ❌ Read environment variables for hash inputs
  ❌ Write to stderr explicitly (no >&2) - only fp1_gates.sh
  ❌ Output multi-line JSON

Gates MAY:
  ✅ Compute internal digests for validation (e.g., file hash comparison)
  ✅ Read env vars for CI detection only (not hash inputs)
  ✅ Call tools that write stderr (runner captures it)

DETECTION: Runner validates gate output does not contain hash fields.
FAILURE SIGNAL: Gate output contains hash field → GATE_008
EXIT CODE: 1 (blocking)

4.3 STDERR POLICY [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
fp1_gates.sh:
  - MUST NOT use >&2 (explicit stderr write)
  - MAY call tools that write to stderr (runner captures)
  - MAY use 2>/dev/null for specific tool calls if needed

fp1_runner.sh:
  - MAY write to stderr for logging/diagnostics
  - MUST capture gate stderr to .a3d/gates/<gateId>.log

DETECTION: Static analysis checks fp1_gates.sh for >&2 usage.
FAILURE SIGNAL: >&2 found in fp1_gates.sh → A3D-E1003
EXIT CODE: 1 (blocking)

4.4 OUTPUT HASH COMPUTATION [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
CRITICAL: Hash MUST be computed on canonicalized JSON, not raw string.

1. Build hashable object with HASH DOMAIN fields only
2. Canonicalize: CANONICAL_JSON=$(echo "$hashable" | jq -cS '.')
3. Hash: outputHash=$(printf '%s' "$CANONICAL_JSON" | sha256_portable)

DETECTION: Runner validates hash computation uses jq -cS canonicalization.
FAILURE SIGNAL: Hash computed on non-canonicalized JSON → GATE_005
EXIT CODE: 1 (blocking)

4.5 RUNNER EXIT CODE SEMANTICS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
| Gate Exit | Gate Status | Blocking | Runner Action           | Final Exit |
|-----------|-------------|----------|-------------------------|------------|
| 0         | PASS        | any      | Continue chain          | 0          |
| 0         | SKIP        | false    | Continue (DEFERRED)     | 0          |
| 0         | FAIL        | false    | Log warning, continue   | 0          |
| 1         | FAIL        | true     | Output JSON, abort      | 1          |
| 2         | (error)     | any      | Output A3D-E9001 JSON   | 2          |
| timeout   | (none)      | any      | Output A3D-E9002 JSON   | 3          |

CRITICAL: Runner ALWAYS outputs valid JSON, even on structural failure.

DETECTION: Runner validates exit code mapping matches table.
FAILURE SIGNAL: Exit code mismatch → GATE_007
EXIT CODE: 1 (blocking)

4.6 RUNNER OUTPUT FORMAT [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Runner outputs exactly ONE LINE to stdout per gate (alphabetically sorted keys):

{
  "blocking": true,
  "diagnosticLogPath": ".a3d/gates/GATE-STATIC.log",
  "errorCode": "A3D-E1001",
  "exitCode": 1,
  "gateId": "GATE-STATIC",
  "gateName": "StaticChecksGate",
  "gateVersion": "1.0.0",
  "inputHash": "<64hex>",
  "message": "Found 3 violations",
  "outputHash": "<64hex>",
  "prevGateHash": "GENESIS",
  "registryHash": "<64hex>",
  "status": "FAIL",
  "timestamp": "2025-01-01T00:00:00Z",
  "violations": [...]
}

DETECTION: Runner validates output is single-line JSON with required fields.
FAILURE SIGNAL: Multi-line output or missing field → GATE_008
EXIT CODE: 1 (blocking)

4.7 CHAIN INTEGRITY [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Runner validates after each gate:
  - Current gate's prevGateHash matches previous gate's outputHash
  - Chain file (.a3d/gate_chain.ndjson) entries are consistent

Mismatch triggers A3D-E9003 (CHAIN_BREAK).

DETECTION: Runner validates chain integrity after each gate.
FAILURE SIGNAL: Chain break detected → A3D-E9003
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
5. GATE CONTRACT
═══════════════════════════════════════════════════════════════════════════════

5.1 GATE RAW OUTPUT FORMAT [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Gate outputs ONLY these fields (runner adds the rest):

{
  "status": "PASS|FAIL|SKIP",
  "errorCode": "A3D-Exxxx" | null,
  "message": "<ascii, max 256 chars, no newlines>",
  "violations": [
    {
      "file": "relative/path/from/repo/root",
      "line": 42,
      "ruleId": "RULE_ID",
      "snippet": "<ascii, max 80 chars>"
    }
  ],
  "evidence": {
    "files": [],
    "hash": "",
    "diff": ""
  }
}

DETECTION: Runner validates gate output matches exact schema.
FAILURE SIGNAL: Missing required field or invalid schema → GATE_008
EXIT CODE: 1 (blocking)

5.2 GATE OUTPUT CONSTRAINTS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
  - Output MUST be single line (no \n characters)
  - Output MUST be valid JSON
  - status: exactly "PASS", "FAIL", or "SKIP"
  - SKIP: only allowed if registry.status == "DEFERRED"
  - errorCode: null for PASS/SKIP, valid A3D-Exxxx for FAIL
  - message: ASCII 0x20-0x7E only, max 256 bytes, no newlines
  - violations: max 50 items
  - violations: MUST be sorted by (file ASC, line ASC, ruleId ASC)
  - violations[].file: relative path, forward slashes only, no ./
  - violations[].snippet: ASCII 0x20-0x7E only, max 80 bytes
  - evidence: object with files, hash, diff fields (may be empty)

DETECTION: Runner validates all constraints before accepting gate output.
FAILURE SIGNAL: Constraint violation → GATE_008
EXIT CODE: 1 (blocking)

5.3 GATE EXIT CODES [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Gate MUST read registry.blocking to determine exit code on FAIL:

| Status | Registry.blocking | Exit Code | Stdout        |
|--------|-------------------|-----------|---------------|
| PASS   | any               | 0         | Valid JSON    |
| SKIP   | false (DEFERRED)  | 0         | Valid JSON    |
| FAIL   | false             | 0         | Valid JSON    |
| FAIL   | true              | 1         | Valid JSON    |
| (error)| any               | 2         | Empty stdout  |

Exit 2 = gate internal error. Gate MUST output EMPTY stdout on exit 2.

DETECTION: Runner validates exit code matches status and blocking.
FAILURE SIGNAL: Exit code mismatch → GATE_007
EXIT CODE: 1 (blocking)

5.4 SORTING REQUIREMENTS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
All file scanning MUST be deterministic:

  LC_ALL=C
  find "$dir" -type f -name "*.swift" -print0 2>/dev/null | \
    LC_ALL=C sort -z | \
    while IFS= read -r -d '' file; do
      ...
    done

All violations MUST be sorted before output:
  Sort key: (file ASC, line ASC, ruleId ASC)

Runner VALIDATES sorting. If violations are not sorted, runner treats as
structural failure (A3D-E9001). Runner does NOT silently fix sorting.

DETECTION: Runner validates violations are sorted.
FAILURE SIGNAL: Violations not sorted → A3D-E9001
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
6. CI WORKFLOW
═══════════════════════════════════════════════════════════════════════════════

6.1 SINGLE ENTRY POINT [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
CI gating logic MUST have single entry point:
  CI workflow → scripts/preflight.sh --ci → scripts/fp1_runner.sh

CI workflow may have additional steps (build, test) AFTER preflight passes.

DETECTION: CI workflow validates single entry point.
FAILURE SIGNAL: Multiple entry points or bypass → GATE_006
EXIT CODE: 1 (blocking)

6.2 WORKFLOW FILE [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
File: .github/workflows/fp1_gates.yml

name: FP1 Gates

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read

env:
  LANG: C
  LC_ALL: C
  TZ: UTC

jobs:
  gates:
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Validate Checkout Strategy
        run: |
          if git rev-list --count HEAD | grep -qE '^[0-9]+$'; then
            if [ "$(git rev-list --count HEAD)" -lt 10 ]; then
              echo "ERROR: Shallow clone detected (fewer than 10 commits)"
              exit 1
            fi
          else
            echo "ERROR: Cannot determine commit count"
            exit 1
          fi
          if ! git rev-parse --abbrev-ref HEAD >/dev/null 2>&1; then
            echo "ERROR: Detached HEAD prevents diffing"
            exit 1
          fi

      - name: Setup Swift
        uses: swift-actions/setup-swift@4e61a00861c9e0d48204d5a6c9e12dc41f6b3dd4
        with:
          swift-version: "5.9.2"

      - name: Run FP1 Gates
        run: |
          chmod +x scripts/fp1_runner.sh scripts/fp1_gates.sh scripts/preflight.sh
          bash scripts/preflight.sh --ci

      - name: Build
        if: success()
        run: swift build

      - name: Test
        if: success()
        run: swift test

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: gate-results
          path: .a3d/
          retention-days: 7

DETECTION: CI validates workflow file exists and matches specification.
FAILURE SIGNAL: Workflow missing or checkout strategy invalid → GATE_002
EXIT CODE: 1 (blocking)

6.3 CHECKOUT STRATEGY ENFORCEMENT [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
CI MUST:
  - Use fetch-depth: 0
  - Fail if history is shallow (< 10 commits)
  - Fail if detached HEAD prevents diffing

DETECTION: CI workflow step validates checkout strategy.
FAILURE SIGNAL: Shallow clone or detached HEAD → GATE_002
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
7. ERROR CODES
═══════════════════════════════════════════════════════════════════════════════

7.1 GLOBAL ERROR CODE REGISTRY [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Error codes are immutable once introduced. Every FAIL MUST include exactly one error code.

| Error Code | Gate | Rule | Severity | Description |
|------------|------|------|----------|-------------|
| GATE_001 | GATE-POLICY | POLICY_HASH_MISMATCH | error | Policy hash mismatch |
| GATE_002 | CI | FORBIDDEN_FILE_MODIFIED | error | File modified outside whitelist |
| GATE_003 | CI | GENERATED_FILE_MODIFIED | error | Generated file manually edited |
| GATE_004 | GATE-BUILDMETA | MISSING_CI_ARTIFACT | error | Missing CI-generated artifact |
| GATE_005 | GATE-DETERMINISM | NONDETERMINISTIC | error | Non-deterministic output |
| GATE_006 | RUNNER | UNREGISTERED_GATE | fatal | Unregistered gate execution |
| GATE_007 | RUNNER | EXIT_CODE_MISMATCH | fatal | Exit code mismatch |
| GATE_008 | RUNNER | SCHEMA_VIOLATION | fatal | Gate output schema violation |
| GATE_009 | GATE-DETERMINISM | WHITELIST_BREACH | error | Determinism whitelist breach |
| GATE_010 | GATE-GOLDEN | PLACEHOLDER_NOT_REPLACED | error | Golden test placeholder not replaced |

DETECTION: Error code registry validates all codes are present and immutable.
FAILURE SIGNAL: Error code missing or changed → GATE_006
EXIT CODE: 1 (blocking)

File: docs/constitution/ERROR_CODES.json [ENFORCED]

{
  "schemaVersion": 1,
  "codes": {
    "A3D-E1001": {"gate": "GATE-STATIC", "rule": "CRLF", "severity": "error", "gateCode": "GATE_001"},
    "A3D-E1002": {"gate": "GATE-STATIC", "rule": "TODO_FIXME", "severity": "error", "gateCode": "GATE_001"},
    "A3D-E1003": {"gate": "GATE-STATIC", "rule": "STDERR_REDIRECT", "severity": "error", "gateCode": "GATE_001"},
    "A3D-E2001": {"gate": "GATE-POLICY", "rule": "POLICY_MISSING", "severity": "error", "gateCode": "GATE_001"},
    "A3D-E2002": {"gate": "GATE-POLICY", "rule": "POLICY_HASH_MISMATCH", "severity": "error", "gateCode": "GATE_001"},
    "A3D-E3001": {"gate": "GATE-DETERMINISM", "rule": "NONDETERMINISTIC", "severity": "error", "gateCode": "GATE_005"},
    "A3D-E4001": {"gate": "GATE-BUILDMETA", "rule": "TEMPLATE_MISSING", "severity": "error", "gateCode": "GATE_004"},
    "A3D-E4002": {"gate": "GATE-BUILDMETA", "rule": "STUB_MISSING", "severity": "error", "gateCode": "GATE_004"},
    "A3D-E4003": {"gate": "GATE-BUILDMETA", "rule": "TOKEN_MISSING", "severity": "error", "gateCode": "GATE_004"},
    "A3D-E9001": {"gate": "RUNNER", "rule": "STRUCTURAL_FAILURE", "severity": "fatal", "gateCode": "GATE_008"},
    "A3D-E9002": {"gate": "RUNNER", "rule": "TIMEOUT", "severity": "fatal", "gateCode": "GATE_007"},
    "A3D-E9003": {"gate": "RUNNER", "rule": "CHAIN_BREAK", "severity": "fatal", "gateCode": "GATE_006"},
    "GATE_001": {"gate": "GATE-POLICY", "rule": "POLICY_HASH_MISMATCH", "severity": "error"},
    "GATE_002": {"gate": "CI", "rule": "FORBIDDEN_FILE_MODIFIED", "severity": "error"},
    "GATE_003": {"gate": "CI", "rule": "GENERATED_FILE_MODIFIED", "severity": "error"},
    "GATE_004": {"gate": "GATE-BUILDMETA", "rule": "MISSING_CI_ARTIFACT", "severity": "error"},
    "GATE_005": {"gate": "GATE-DETERMINISM", "rule": "NONDETERMINISTIC", "severity": "error"},
    "GATE_006": {"gate": "RUNNER", "rule": "UNREGISTERED_GATE", "severity": "fatal"},
    "GATE_007": {"gate": "RUNNER", "rule": "EXIT_CODE_MISMATCH", "severity": "fatal"},
    "GATE_008": {"gate": "RUNNER", "rule": "SCHEMA_VIOLATION", "severity": "fatal"},
    "GATE_009": {"gate": "GATE-DETERMINISM", "rule": "WHITELIST_BREACH", "severity": "error"},
    "GATE_010": {"gate": "GATE-GOLDEN", "rule": "PLACEHOLDER_NOT_REPLACED", "severity": "error"}
  }
}

DETECTION: Error code registry validates JSON structure and code immutability.
FAILURE SIGNAL: Registry invalid or code changed → GATE_006
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
8. POLICY FILE
═══════════════════════════════════════════════════════════════════════════════

File: docs/constitution/FP1_POLICY.md [ENFORCED]

# FP1 Policy v1.0.0

## Declared Policy Hash

policyHash: COMPUTE_ON_FIRST_RUN

(On first run, gate computes hash of all policy files and this line is updated.
Subsequent runs compare computed hash against declared hash.)

## Principles

1. Runner is the single point of hash computation
2. Gates output raw semantic results only
3. CI calls preflight, preflight calls runner
4. Only ENFORCED rules cause failure
5. Hash domain is strictly deterministic
6. Non-hash domain is for observation only

## Policy Files Covered

- docs/constitution/FP1_POLICY.md
- docs/constitution/GATE_REGISTRY.json
- docs/constitution/ERROR_CODES.json
- docs/constitution/DETERMINISM_ALLOWLIST.txt
- docs/constitution/PINNED_ACTIONS.json

## Hash Computation

policyHash = SHA256(concat(sorted(sha256(file) for file in policyFiles)))

DETECTION: Policy gate validates policy hash matches declared hash.
FAILURE SIGNAL: Policy hash mismatch → GATE_001
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
9. DETERMINISM ALLOWLIST
═══════════════════════════════════════════════════════════════════════════════

File: docs/constitution/DETERMINISM_ALLOWLIST.txt [ENFORCED]

# Format: <file_path> | <pattern> | <reason>
# file_path: exact relative path from repo root
# pattern: regex pattern that matches the allowed usage
# reason: explanation (for humans)
#
# Lines starting with # are comments.
# Empty lines are ignored.

Core/Audit/AuditEntry.swift | Date\(\) | Audit timestamp (NON-HASH DOMAIN)
Core/Audit/AuditEntry.swift | UUID\(\) | Audit entry ID (NON-HASH DOMAIN)

DETECTION: Determinism gate validates allowlist format and entries.
FAILURE SIGNAL: Allowlist format invalid or entry missing → GATE_009
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
10. DETERMINISM PROOF OBLIGATIONS
═══════════════════════════════════════════════════════════════════════════════

10.1 DETERMINISTIC PROCESSES [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Each deterministic process MUST specify:
  - Inputs (explicit list)
  - Forbidden entropy sources
  - Stable ordering guarantees
  - Hash algorithm and normalization steps

If a process cannot prove determinism → it MUST be labeled:
NON-DETERMINISTIC (BLOCKING = false)

10.2 HASH COMPUTATION (Deterministic) [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Process: Runner outputHash computation
Inputs:
  - gateId, gateName, gateVersion, blocking (from registry)
  - status, errorCode, exitCode (from gate output)
  - inputHash, prevGateHash, registryHash (computed by runner)
  - violations (sorted array from gate)
  - message (ASCII normalized, truncated to 256 bytes)

Forbidden Entropy:
  - timestamp
  - diagnosticLogPath
  - outputHash (the hash itself)
  - File system ordering (use LC_ALL=C sort -z)
  - Locale-dependent operations

Ordering Guarantees:
  - All arrays sorted before inclusion
  - JSON canonicalized via jq -cS
  - File scans use LC_ALL=C sort -z

Hash Algorithm: SHA256
Normalization: jq -cS canonicalization before hashing

DETECTION: Runner validates determinism proof requirements.
FAILURE SIGNAL: Non-deterministic operation in hash computation → GATE_005
EXIT CODE: 1 (blocking)

10.3 FILE SCANNING (Deterministic) [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Process: Gate file scanning
Inputs:
  - scanPaths (from registry)
  - scanExtensions (from registry)
  - Exclusion patterns (from registry)

Forbidden Entropy:
  - File system ordering (use LC_ALL=C sort -z)
  - Locale-dependent sorting

Ordering Guarantees:
  - find ... -print0 | LC_ALL=C sort -z
  - All file paths processed in sorted order

DETECTION: Gate validates file scanning uses deterministic ordering.
FAILURE SIGNAL: Non-deterministic file scan → GATE_005
EXIT CODE: 1 (blocking)

10.4 NON-DETERMINISTIC PROCESSES [ASSERTED]
─────────────────────────────────────────────────────────────────────────────────
Process: Timestamp generation
Status: NON-DETERMINISTIC (BLOCKING = false)
Reason: Timestamp is in NON-HASH DOMAIN, for observation only.

Process: Diagnostic log capture
Status: NON-DETERMINISTIC (BLOCKING = false)
Reason: Log content is in NON-HASH DOMAIN, for observation only.

NOTE: These processes are ASSERTED (logged, no abort). No failure signal.

═══════════════════════════════════════════════════════════════════════════════
11. PHASE 4 MODIFICATION WHITELIST
═══════════════════════════════════════════════════════════════════════════════

11.1 EXPLICIT ALLOWLIST [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Phase 4 Allowlist:
- .github/workflows/fp1_gates.yml
- Core/BuildMeta/
- scripts/fp1_runner.sh
- scripts/fp1_gates.sh
- scripts/preflight.sh (append only)
- Tests/Gates/
- docs/constitution/GATE_REGISTRY.json
- docs/constitution/ERROR_CODES.json
- docs/constitution/DETERMINISM_ALLOWLIST.txt
- docs/constitution/PINNED_ACTIONS.json
- docs/constitution/FP1_POLICY.md
- .gitignore (append only)
- .a3d/.gitkeep

Rules:
  - Any file outside allowlist modified → FAIL
  - Directories imply recursive permission
  - Deletions are treated as modifications

DETECTION: CI workflow checks all modified files against allowlist.
FAILURE SIGNAL: File modified outside allowlist → GATE_002
EXIT CODE: 1 (blocking)

11.2 GENERATED FILES RULE [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
For any *.generated.* file:
  - MUST be overwritten entirely by CI
  - MUST NOT be manually edited
  - MUST fail CI if checksum differs from CI output

Manual modification → GATE_003

DETECTION: CI checks if generated file exists in git index or working tree.
FAILURE SIGNAL: Generated file committed or manually modified → GATE_003
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
12. SCRIPTS
═══════════════════════════════════════════════════════════════════════════════

12.1 FP1 RUNNER [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
File: scripts/fp1_runner.sh

(Full script content from V10.0.0 preserved - see original constitution for complete implementation)

Key hardening changes:
- All hash computations MUST use jq -cS canonicalization
- All failure modes MUST map to error codes
- Timeout handling MUST be portable with fallback
- Chain integrity validation MUST occur after each gate

DETECTION: Runner script validates it implements all required responsibilities.
FAILURE SIGNAL: Runner missing required function → GATE_006
EXIT CODE: 1 (blocking)

12.2 FP1 GATES [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
File: scripts/fp1_gates.sh

(Full script content from V10.0.0 preserved - see original constitution for complete implementation)

Key hardening changes:
- MUST NOT use >&2 (explicit stderr write)
- MUST output exact JSON schema with evidence field
- MUST sort violations before output
- MUST exit with correct code based on status and blocking

DETECTION: Static analysis checks for >&2 usage in fp1_gates.sh.
FAILURE SIGNAL: >&2 found in fp1_gates.sh → A3D-E1003
EXIT CODE: 1 (blocking)

12.3 PREFLIGHT ADDITION [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Append to scripts/preflight.sh:

# ═══════════════════════════════════════════════════════════════════════════
# FP1 Gates
# ═══════════════════════════════════════════════════════════════════════════

(Full preflight addition from V10.0.0 preserved)

DETECTION: Preflight script validates FP1 section is appended correctly.
FAILURE SIGNAL: FP1 section missing or malformed → GATE_002
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
13. BUILDMETA
═══════════════════════════════════════════════════════════════════════════════

13.1 INTERFACE [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
File: Core/BuildMeta/BuildMeta.swift

BuildMeta.swift MUST:
  - Define all fields with defaults = "UNKNOWN"
  - Compile on all supported platforms
  - Contain no runtime logic

import Foundation

public enum BuildMeta {
    public static var schemaVersion: Int { _schemaVersion }
    public static var commitSHA: String { _commitSHA }
    public static var policyHash: String { _policyHash }
    public static var configHash: String { _configHash }
    public static var ciProvider: String { _ciProvider }
    public static var buildId: String { _buildId }
    public static var gateChainHash: String { _gateChainHash }
    
    public static var isValidBuild: Bool {
        commitSHA != "LOCAL" && 
        gateChainHash != "LOCAL" &&
        commitSHA.count == 40 &&
        commitSHA.allSatisfy { $0.isHexDigit }
    }
    
    public static var isLocalBuild: Bool {
        commitSHA == "LOCAL"
    }
}

DETECTION: Build validates BuildMeta.swift compiles and has UNKNOWN defaults.
FAILURE SIGNAL: BuildMeta.swift missing or invalid → GATE_004
EXIT CODE: 1 (blocking)

13.2 TEMPLATE [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
File: Core/BuildMeta/BuildMeta.generated.swift.template

BuildMeta.generated.swift MUST:
  - Be CI-only
  - Override all UNKNOWN fields
  - Include commit SHA, timestamp, gate hash

// AUTO-GENERATED BY CI - DO NOT EDIT
// Generated at: {{TIMESTAMP}}
import Foundation

extension BuildMeta {
    static let _schemaVersion: Int = {{SCHEMA_VERSION}}
    static let _commitSHA: String = "{{COMMIT_SHA}}"
    static let _policyHash: String = "{{POLICY_HASH}}"
    static let _configHash: String = "{{CONFIG_HASH}}"
    static let _ciProvider: String = "{{CI_PROVIDER}}"
    static let _buildId: String = "{{BUILD_ID}}"
    static let _gateChainHash: String = "{{GATE_CHAIN_HASH}}"
}

DETECTION: CI validates template exists and contains all required tokens.
FAILURE SIGNAL: Template missing or token missing → A3D-E4003
EXIT CODE: 1 (blocking)

13.3 LOCAL STUB [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
File: Core/BuildMeta/BuildMeta.local.swift

// LOCAL BUILD STUB - Committed to repo
// Used when BuildMeta.generated.swift does not exist
import Foundation

extension BuildMeta {
    static let _schemaVersion: Int = 1
    static let _commitSHA: String = "LOCAL"
    static let _policyHash: String = "LOCAL"
    static let _configHash: String = "LOCAL"
    static let _ciProvider: String = "local"
    static let _buildId: String = "local:dev"
    static let _gateChainHash: String = "LOCAL"
}

DETECTION: BuildMeta gate validates stub exists and has LOCAL defaults.
FAILURE SIGNAL: Stub missing or invalid → A3D-E4002
EXIT CODE: 1 (blocking)

13.4 CI GENERATION REQUIREMENT [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
BuildMeta.generated.swift MUST be generated by CI and MUST NOT be committed.

Missing override → FAIL (GATE_004)

DETECTION: CI checks if BuildMeta.generated.swift exists in git index.
FAILURE SIGNAL: Generated file committed → GATE_003
EXIT CODE: 1 (blocking)

DETECTION: CI validates generated file exists after gate chain completes.
FAILURE SIGNAL: Generated file missing after CI run → GATE_004
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
14. TESTS
═══════════════════════════════════════════════════════════════════════════════

14.1 GATE TESTS ARE SOURCE OF TRUTH [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
If a gate exists:
  - There MUST be a test asserting its failure mode
  - The test MUST assert error code, not message

DETECTION: Test suite validates gate tests exist for all ACTIVE gates.
FAILURE SIGNAL: Gate test missing for ACTIVE gate → GATE_010
EXIT CODE: 1 (blocking)

14.2 GOLDEN TESTS ARE NOT OPTIONAL [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Any placeholder test MUST:
  - Be explicitly marked NON_BLOCKING
  - Include a TODO reference ID
  - Fail automatically once placeholder removed

Silent placeholders are forbidden.

DETECTION: Test suite validates golden tests are marked and have TODO.
FAILURE SIGNAL: Placeholder test missing mark or TODO → GATE_010
EXIT CODE: 1 (blocking)

14.3 GATE CONTRACT TESTS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
File: Tests/Gates/GateContractTests.swift

(Full test content from V10.0.0 preserved - see original constitution for complete implementation)

Key test requirements:
- Gate output is single-line
- Gate output is valid JSON
- Gate output has required fields
- Gate status is valid enum
- Deferred gate returns SKIP
- Exit code matches status and blocking
- Runner adds required fields
- Output hash is 64 lowercase hex
- Chain integrity
- Violations are sorted

DETECTION: Test suite validates all contract tests pass.
FAILURE SIGNAL: Contract test failure → GATE_010
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
15. META-RULES
═══════════════════════════════════════════════════════════════════════════════

15.1 NO NEW GATES [INFORMATIONAL]
─────────────────────────────────────────────────────────────────────────────────
V10.0.1 introduces structure, not new gates.
If a new gate is needed, mark:

DEFERRED – REQUIRES PR#13

NOTE: This rule is INFORMATIONAL. No failure signal.

15.2 NO FEATURE CREEP [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
If any requested behavior is outside Phase 4:
  - Explicitly refuse
  - Reference allowlist

DETECTION: CI validates all changes are within Phase 4 allowlist.
FAILURE SIGNAL: Change outside Phase 4 allowlist → GATE_002
EXIT CODE: 1 (blocking)

15.3 CONTRADICTION RESOLUTION [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Single Source of Truth Priority:
1. Gate registry
2. CI workflows
3. Scripts
4. Tests
5. Documentation

If conflict exists:
  - Lower priority MUST defer
  - MUST include reference link

DETECTION: CI validates no contradictions between sources of truth.
FAILURE SIGNAL: Contradiction detected → GATE_006
EXIT CODE: 1 (blocking)

15.4 NO SILENT SUCCESS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Every gate MUST log:
  - PASS with evidence
  - FAIL with evidence

Empty output is forbidden.

DETECTION: Runner validates gate output is not empty.
FAILURE SIGNAL: Empty gate output → GATE_008
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
16. EXECUTION ORDER
═══════════════════════════════════════════════════════════════════════════════

1.  Append to .gitignore
2.  Create .a3d/.gitkeep
3.  Create docs/constitution/GATE_REGISTRY.json
4.  Create docs/constitution/ERROR_CODES.json
5.  Create docs/constitution/DETERMINISM_ALLOWLIST.txt
6.  Create docs/constitution/PINNED_ACTIONS.json
7.  Create docs/constitution/FP1_POLICY.md
8.  Create scripts/fp1_runner.sh
9.  Create scripts/fp1_gates.sh
10. Create Core/BuildMeta/BuildMeta.swift
11. Create Core/BuildMeta/BuildMeta.generated.swift.template
12. Create Core/BuildMeta/BuildMeta.local.swift
13. Create Tests/Gates/GateContractTests.swift
14. Create .github/workflows/fp1_gates.yml
15. Append to scripts/preflight.sh
16. chmod +x scripts/fp1_runner.sh scripts/fp1_gates.sh scripts/preflight.sh
17. Run: bash scripts/preflight.sh
18. Verify all gates pass

═══════════════════════════════════════════════════════════════════════════════
17. OUTPUT REQUIREMENTS
═══════════════════════════════════════════════════════════════════════════════

Your output MUST include:

1. INTERPRETATION SUMMARY (5-8 lines)

2. FILES TOUCHED (sorted by path)

3. Complete file contents for ALL files (no truncation)

4. ACCEPTANCE CHECKLIST:
   □ All files in Section 1.1/1.2 whitelist
   □ Gates output raw JSON only (no hashes)
   □ Runner computes all hashes via jq -cS canonicalization
   □ All file scans sorted (LC_ALL=C sort)
   □ Violations sorted by (file, line, ruleId)
   □ Runner validates violations are sorted (no silent fix)
   □ CI calls preflight only for gating logic
   □ No >&2 in fp1_gates.sh
   □ Runner outputs valid JSON even on structural failure
   □ Exit codes match Section 4.5 and 5.3 tables
   □ Multi-line detection uses [[ "$output" == *$'\n'* ]]
   □ Portable timeout (fallback if missing)
   □ Tool checks in runner

5. ATTESTATION:
   "I confirm all rules are implemented as specified and no rule was weakened."

═══════════════════════════════════════════════════════════════════════════════
18. KEY CHANGES BY SECTION (V10.0.0 → V10.0.1)
═══════════════════════════════════════════════════════════════════════════════

18.1 SECTION 0: EXECUTION MODE
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Added explicit detection mechanisms to every rule
- Added failure signals and error codes (GATE_006 for unverified ENFORCED rules)
- Downgraded undetectable rules to "INFORMATIONAL" explicitly
- Removed soft language ("should", "ideally")

18.2 SECTION 1: CLOSED WORLD ASSUMPTION
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Added explicit failure signals for whitelist violations (GATE_002)
- Added detection mechanisms for all rules
- Strengthened generated files rule with GATE_003 failure
- Added .gitignore validation with GATE_008 failure

18.3 SECTION 2: HASH DOMAIN SEPARATION
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Added explicit failure signal for non-deterministic operations (GATE_005)
- Added detection mechanism for hash domain validation
- Strengthened determinism requirements with explicit failure modes

18.4 SECTION 3: GATE REGISTRY
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Added formal Gate Registry table (S-1 patch)
- Made gate IDs immutable with explicit failure signal (GATE_006)
- Mapped blocking gates to exit codes explicitly
- Added registry hash validation with failure signal

18.5 SECTION 4: RUNNER CONTRACT
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Added explicit failure modes for each responsibility
- Mapped failures to error codes (GATE_006, GATE_007, GATE_008)
- Added detection mechanisms for all runner validations
- Strengthened exit code semantics with explicit failure signal (GATE_007)

18.6 SECTION 5: GATE CONTRACT
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Replaced flexible schema with exact mandatory JSON (S-2 patch)
- Added "evidence" field requirement
- Added explicit failure signal for schema violations (GATE_008)
- Strengthened exit code requirements with failure signal (GATE_007)

18.7 SECTION 6: CI WORKFLOW
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Added checkout strategy enforcement (F-2 patch)
- Added validation step for shallow clone detection
- Added failure signal for checkout violations (GATE_002)
- Strengthened single entry point requirement

18.8 SECTION 7: ERROR CODES
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Expanded to include GATE_001 through GATE_010 (S-3 patch)
- Made error codes immutable with explicit failure signal (GATE_006)
- Mapped existing A3D-E codes to new GATE_XXX system
- Added formal error code registry table

18.9 SECTION 8: POLICY FILE
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Added explicit failure signal for policy hash mismatch (GATE_001)
- Added detection mechanism for policy validation

18.10 SECTION 9: DETERMINISM ALLOWLIST
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Added explicit failure signal for allowlist violations (GATE_009)
- Added detection mechanism for allowlist validation

18.11 SECTION 10: DETERMINISM PROOF OBLIGATIONS (NEW)
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- New section added (D-1 patch)
- Required explicit inputs, forbidden entropy, ordering guarantees
- Labeled non-deterministic processes explicitly
- Added failure signals for determinism violations (GATE_005)

18.12 SECTION 11: PHASE 4 MODIFICATION WHITELIST (NEW)
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- New section added (F-1 patch)
- Explicit allowlist with failure signal (GATE_002)
- Generated files rule with GATE_003 failure
- Added detection mechanisms for whitelist validation

18.13 SECTION 12: SCRIPTS
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Added explicit failure signals for script validation
- Strengthened stderr policy with A3D-E1003 failure
- Added detection mechanisms for script requirements

18.14 SECTION 13: BUILDMETA
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Strengthened BuildMeta contract (B-1 patch)
- Added GATE_004 failure for missing CI-generated artifacts
- Specified default "UNKNOWN" values requirement
- Added detection mechanisms for BuildMeta validation

18.15 SECTION 14: TESTS
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- Mandated golden test requirements (T-1 patch)
- Required gate tests for every gate (T-2 patch)
- Added failure signal for missing tests (GATE_010)
- Added detection mechanisms for test validation

18.16 SECTION 15: META-RULES (NEW)
─────────────────────────────────────────────────────────────────────────────────
CHANGES:
- New section added (M-1, M-2, C-1, O-1 patches)
- Contradiction resolution priority
- Observability requirements (no silent success)
- Feature creep prevention
- Added failure signals for meta-rule violations

═══════════════════════════════════════════════════════════════════════════════
19. CONSTRAINTS
═══════════════════════════════════════════════════════════════════════════════

19.1 PRESERVATION OF INTENT [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
All V10.0.0 intent MUST be preserved unless explicitly overridden by patches.

DETECTION: Document review validates no V10.0.0 intent removed without patch override.
FAILURE SIGNAL: Intent removed without patch override → GATE_006
EXIT CODE: 1 (blocking)

19.2 NO NEW GATES [INFORMATIONAL]
─────────────────────────────────────────────────────────────────────────────────
V10.0.1 introduces structure, not new gates.
If a new gate is needed, mark: DEFERRED – REQUIRES PR#13

NOTE: This rule is INFORMATIONAL. No failure signal.

19.3 NO FEATURE CREEP [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
If any requested behavior is outside Phase 4:
  - Explicitly refuse
  - Reference allowlist

DETECTION: CI validates all changes are within Phase 4 allowlist.
FAILURE SIGNAL: Change outside Phase 4 allowlist → GATE_002
EXIT CODE: 1 (blocking)

19.4 SINGLE SOURCE OF TRUTH PRIORITY [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Priority order:
1. Gate registry
2. CI workflows
3. Scripts
4. Tests
5. Documentation

If conflict exists:
  - Lower priority MUST defer
  - MUST include reference link

DETECTION: CI validates no contradictions between sources of truth.
FAILURE SIGNAL: Contradiction detected → GATE_006
EXIT CODE: 1 (blocking)

19.5 OBSERVABILITY REQUIREMENT [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
Every gate MUST log:
  - PASS with evidence
  - FAIL with evidence

Empty output is forbidden.

DETECTION: Runner validates gate output is not empty.
FAILURE SIGNAL: Empty gate output → GATE_008
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
20. SUCCESS CRITERIA
═══════════════════════════════════════════════════════════════════════════════

20.1 LANGUAGE HARDENING [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- Zero instances of soft language ("should", "ideally", "recommended", "expected")
- All rules use "MUST", "MUST NOT", or "FAIL WITH <ERROR_CODE>"

DETECTION: Document analysis validates no soft language remains.
FAILURE SIGNAL: Soft language detected → GATE_008
EXIT CODE: 1 (blocking)

20.2 FAILURE MODE COMPLETENESS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- Every ENFORCED rule has explicit failure signal
- Every ENFORCED rule has explicit error code
- Every ENFORCED rule has explicit detection mechanism
- Every ENFORCED rule has explicit exit code

DETECTION: Document analysis validates all ENFORCED rules have failure modes.
FAILURE SIGNAL: ENFORCED rule missing failure mode → GATE_006
EXIT CODE: 1 (blocking)

20.3 GATE REGISTRY COMPLETENESS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- Gate registry table present with all gates
- All gate IDs are immutable
- All blocking gates map to non-zero exit codes
- Registry hash computation validated

DETECTION: Gate registry validates table structure and immutability.
FAILURE SIGNAL: Gate registry incomplete or invalid → GATE_006
EXIT CODE: 1 (blocking)

20.4 GATE OUTPUT SCHEMA COMPLETENESS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- Exact mandatory JSON schema defined for all gate output
- Evidence field required in schema
- All constraints explicitly stated
- Schema validation enforced

DETECTION: Runner validates gate output matches exact schema.
FAILURE SIGNAL: Schema violation → GATE_008
EXIT CODE: 1 (blocking)

20.5 DETERMINISM PROOF COMPLETENESS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- Determinism Proof Obligations section present
- All deterministic processes specify inputs, forbidden entropy, ordering
- Non-deterministic processes explicitly labeled
- Generated files rule with GATE_003 failure

DETECTION: Document analysis validates determinism proofs are complete.
FAILURE SIGNAL: Determinism proof missing → GATE_005
EXIT CODE: 1 (blocking)

20.6 MODIFICATION WHITELIST COMPLETENESS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- Explicit Phase 4 modification whitelist present
- All whitelist entries have failure modes
- Generated files rule enforced
- CI checkout strategy enforced

DETECTION: CI validates whitelist is complete and enforced.
FAILURE SIGNAL: Whitelist violation → GATE_002
EXIT CODE: 1 (blocking)

20.7 BUILDMETA CONTRACT COMPLETENESS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- BuildMeta contract strengthened with GATE_004 failure
- UNKNOWN defaults requirement specified
- CI generation requirement enforced
- Template and stub validation enforced

DETECTION: BuildMeta gate validates contract completeness.
FAILURE SIGNAL: BuildMeta contract violation → GATE_004
EXIT CODE: 1 (blocking)

20.8 TESTING REQUIREMENTS COMPLETENESS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- Golden test requirements mandatory
- Gate test requirements mandatory
- Placeholder test rules enforced
- Contract test requirements complete

DETECTION: Test suite validates all requirements are met.
FAILURE SIGNAL: Test requirement missing → GATE_010
EXIT CODE: 1 (blocking)

20.9 META-RULES COMPLETENESS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- Contradiction resolution priority defined
- Observability requirements enforced
- Feature creep prevention enforced
- No new gates rule stated

DETECTION: Document analysis validates meta-rules are complete.
FAILURE SIGNAL: Meta-rule missing → GATE_006
EXIT CODE: 1 (blocking)

20.10 NO CONTRADICTIONS [ENFORCED]
─────────────────────────────────────────────────────────────────────────────────
- All rules are self-consistent
- No conflicting requirements
- Single source of truth priority enforced
- All patches applied without contradiction

DETECTION: Document analysis validates no contradictions exist.
FAILURE SIGNAL: Contradiction detected → GATE_006
EXIT CODE: 1 (blocking)

═══════════════════════════════════════════════════════════════════════════════
21. CHANGE LOG (V10.0.0 → V10.0.1)
═══════════════════════════════════════════════════════════════════════════════

**Phase 1: Language Hardening (G-1, G-2, G-3)**
- Removed all soft language throughout document
- Added explicit detection mechanisms to every rule
- Added failure signals and error codes to every rule
- Downgraded undetectable rules to "Informational" explicitly
- Removed claims that prompt "prevents" behavior

**Phase 2: Structural Additions (S-1, S-2, S-3)**
- Added formal Gate Registry table in Section 3
- Mandated exact gate output JSON schema in Section 5
- Introduced global error code registry GATE_001-GATE_010 in Section 7
- Mapped existing A3D-E codes to new GATE_XXX system

**Phase 3: Determinism Hardening (D-1, D-2)**
- Added "Determinism Proof Obligations" section (Section 10)
- Required explicit inputs, forbidden entropy, ordering guarantees
- Labeled non-deterministic processes explicitly
- Added generated files rule with GATE_003 failure

**Phase 4: Filesystem Rules (F-1, F-2)**
- Added explicit Phase 4 modification whitelist (Section 11)
- Enforced CI checkout strategy requirements (Section 6)
- Added failure modes for whitelist violations (GATE_002)

**Phase 5: BuildMeta Contract (B-1)**
- Strengthened BuildMeta.swift requirements (Section 13)
- Added GATE_004 failure for missing CI-generated artifacts
- Specified default "UNKNOWN" values requirement

**Phase 6: Testing Requirements (T-1, T-2)**
- Mandated golden test requirements (Section 14)
- Required gate tests for every gate
- Added placeholder test rules with GATE_010 failure

**Phase 7: Meta-Rules (M-1, M-2, C-1, O-1)**
- Added contradiction resolution priority (Section 15)
- Added observability requirements (no silent success)
- Marked deferred gates explicitly
- Prevented feature creep

**Summary of New Sections:**
- Section 10: Determinism Proof Obligations (NEW)
- Section 11: Phase 4 Modification Whitelist (NEW)
- Section 15: Meta-Rules (NEW)
- Section 18: Key Changes by Section (NEW)
- Section 19: Constraints (NEW)
- Section 20: Success Criteria (NEW)
- Section 21: Change Log (NEW)

**Summary of Strengthened Sections:**
- All sections: Added explicit failure signals and error codes
- Section 3: Added formal gate registry table
- Section 5: Mandated exact JSON schema
- Section 7: Expanded error code registry
- Section 13: Strengthened BuildMeta contract
- Section 14: Mandated testing requirements

═══════════════════════════════════════════════════════════════════════════════
END OF CONSTITUTION v10.0.1
═══════════════════════════════════════════════════════════════════════════════
