#!/bin/bash
# Pre-push hook for PR1 Constitution compliance
# Source: LOCAL_PREFLIGHT_GATE.md §2.2

set -e

echo "╔════════════════════════════════════════╗"
echo "║     LOCAL PRE-FLIGHT CHECK             ║"
echo "╚════════════════════════════════════════╝"

FAILED=0

# §1.1 Check 1: Syntax
echo "▶ [1/4] Checking Swift syntax..."
if ! swift build --target Core 2>/dev/null; then
    echo "  ✗ Swift build failed"
    FAILED=1
else
    echo "  ✓ Swift syntax OK"
fi

# §1.1 Check 2: Banned Patterns
echo "▶ [2/4] Scanning for banned patterns..."
if ! ./scripts/scan-prohibited-patterns.sh; then
    echo "  ✗ Banned patterns found"
    FAILED=1
else
    echo "  ✓ No banned patterns"
fi

# §1.1 Check 3: SSOT Integrity
echo "▶ [3/4] Verifying SSOT integrity..."
if ! ./scripts/verify-ssot-integrity.sh; then
    echo "  ✗ SSOT integrity failed"
    FAILED=1
else
    echo "  ✓ SSOT integrity OK"
fi

# §1.1 Check 4: Smoke Test (optional but recommended)
echo "▶ [4/4] Running smoke tests..."
if swift test --filter SmokeTests 2>/dev/null; then
    echo "  ✓ Smoke tests passed"
else
    echo "  ⚠ Smoke tests failed (warning only)"
fi

echo ""
if [ $FAILED -ne 0 ]; then
    echo "╔════════════════════════════════════════╗"
    echo "║  ✗ PRE-FLIGHT FAILED - PUSH BLOCKED    ║"
    echo "╚════════════════════════════════════════╝"
    echo ""
    echo "Fix the issues above and try again."
    exit 1
else
    echo "╔════════════════════════════════════════╗"
    echo "║  ✓ PRE-FLIGHT PASSED - PUSH ALLOWED    ║"
    echo "╚════════════════════════════════════════╝"
    exit 0
fi
